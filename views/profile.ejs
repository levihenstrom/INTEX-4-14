    <!-- Regular User View: Show their own profile -->
    <div class="participants-page">
        <div class="info-video-header">
            <h1>My Profile</h1>
        </div>
        
        <% if (typeof error !== 'undefined' && error) { %>
            <div class="alert alert-danger" role="alert">
                <%= error %>
            </div>
        <% } %>
        
        <% if (typeof success !== 'undefined' && success) { %>
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <%= success %>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        <% } %>

        

        <div class="card shadow-sm mb-4">
            <div class="card-body d-flex flex-column gap-3 position-relative profile-card-body">
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-start gap-4">
                    <div>
                        <p class="text-muted text-uppercase small mb-1"></p>
                        <h2 class="mb-3">Welcome, <%= participant.ParticipantFirstName %> <%= participant.ParticipantLastName %></h2>
                        <p class="mb-1"><strong>Email:</strong> <%= participant.ParticipantEmail %></p>
                        <p class="mb-1"><strong>Phone:</strong> <%= participant.ParticipantPhone || 'Not provided' %></p>
                        <p class="mb-1"><strong>Birthday:</strong> <%= profileDOBDisplay || 'Not provided' %></p>
                        <p class="mb-1"><strong>Location:</strong> 
                            <%= participant.ParticipantCity || 'City N/A' %>, 
                            <%= participant.ParticipantState || 'State N/A' %>
                        </p>
                        <p class="mb-0"><strong>School/Employer:</strong> <%= participant.ParticipantSchoolOrEmployer || 'Not provided' %></p>
                    </div>
                    <div class="text-muted text-end ms-md-auto">
                        <p class="text-uppercase small mb-1">Member since</p>
                        <p class="fs-5 mb-0"><%= memberSinceDisplay || 'Date not set' %></p>
                    </div>
                </div>
                <button class="btn btn-outline-primary profile-edit-trigger" type="button" data-bs-toggle="collapse" data-bs-target="#profileEditForm" aria-expanded="false" aria-controls="profileEditForm">
                    Update Your Details
                </button>
            </div>
        </div>
        <div class="collapse mb-4" id="profileEditForm">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Update Your Details</h5>
                </div>
                <div class="card-body">
                    <form action="/participants" method="POST">
                        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="userParticipantFirstName" class="form-label">First Name *</label>
                            <input type="text" class="form-control" id="userParticipantFirstName" 
                                   name="ParticipantFirstName" 
                                   value="<%= participant.ParticipantFirstName || '' %>" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="userParticipantLastName" class="form-label">Last Name *</label>
                            <input type="text" class="form-control" id="userParticipantLastName" 
                                   name="ParticipantLastName" 
                                   value="<%= participant.ParticipantLastName || '' %>" required>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="userParticipantEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="userParticipantEmail" 
                               value="<%= participant.ParticipantEmail || '' %>" disabled>
                        <small class="form-text text-muted">Email cannot be changed</small>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="userParticipantDOB" class="form-label">Date of Birth</label>
                            <input type="date" class="form-control" id="userParticipantDOB" 
                                   name="ParticipantDOB" 
                                   value="<%= profileDOBInput || '' %>">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="userParticipantPhone" class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" id="userParticipantPhone" 
                                   name="ParticipantPhone" inputmode="numeric" maxlength="12"
                                   pattern="\d{3}-\d{3}-\d{4}"
                                   title="Phone must be in the format 111-111-1111"
                                   value="<%= participant.ParticipantPhone || '' %>">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="userParticipantCity" class="form-label">City</label>
                            <input type="text" class="form-control" id="userParticipantCity" 
                                   name="ParticipantCity" 
                                   value="<%= participant.ParticipantCity || '' %>">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="userParticipantState" class="form-label">State</label>
                            <input type="text" class="form-control" id="userParticipantState" 
                                   name="ParticipantState" 
                                   value="<%= participant.ParticipantState || '' %>">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="userParticipantZip" class="form-label">ZIP Code</label>
                            <input type="text" class="form-control" id="userParticipantZip" 
                                   name="ParticipantZip" 
                                   value="<%= participant.ParticipantZip || '' %>">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="userParticipantSchoolOrEmployer" class="form-label">School or Employer</label>
                        <input type="text" class="form-control" id="userParticipantSchoolOrEmployer" 
                               name="ParticipantSchoolOrEmployer" 
                               value="<%= participant.ParticipantSchoolOrEmployer || '' %>">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Field of Interest</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="ParticipantFieldOfInterest" 
                                   id="user_interest_stem" value="STEM"
                                   <%= participant.ParticipantFieldOfInterest === 'STEM' ? 'checked' : '' %>>
                            <label class="form-check-label" for="user_interest_stem">STEM</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="ParticipantFieldOfInterest" 
                                   id="user_interest_arts" value="Arts"
                                   <%= participant.ParticipantFieldOfInterest === 'Arts' ? 'checked' : '' %>>
                            <label class="form-check-label" for="user_interest_arts">Arts</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="ParticipantFieldOfInterest" 
                                   id="user_interest_both" value="Both"
                                   <%= participant.ParticipantFieldOfInterest === 'Both' ? 'checked' : '' %>>
                            <label class="form-check-label" for="user_interest_both">Both</label>
                        </div>
                    </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">Update Profile</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <% const kpiMetrics = metrics || {}; %>
        <% const latestMilestone = kpiMetrics.recentMilestone; %>
        <% const showDonationsCard = (kpiMetrics.totalDonationsDisplay && Number(kpiMetrics.totalDonationsDisplay) > 0); %>
        <div class="row g-3 mb-4">
            <div class="<%= showDonationsCard ? 'col-md-4' : 'col-md-6' %>">
                <a href="/events" class="text-decoration-none text-reset d-block h-100">
                    <div class="card h-100 text-center shadow-sm profile-kpi-card">
                        <div class="card-body profile-kpi-card-body">
                            <p class="text-muted text-uppercase small profile-kpi-label">Total Events Attended</p>
                            <h3 class="display-6 kpi-value-display"><%= kpiMetrics.totalEventsAttended || 0 %></h3>
                        </div>
                    </div>
                </a>
            </div>
            <div class="<%= showDonationsCard ? 'col-md-4' : 'col-md-6' %>">
                <a href="/milestones" class="text-decoration-none text-reset d-block h-100">
                    <div class="card h-100 text-center shadow-sm profile-kpi-card">
                        <div class="card-body profile-kpi-card-body">
                            <p class="text-muted text-uppercase small profile-kpi-label">Most Recent Milestone</p>
                            <% if (latestMilestone) { %>
                                <h5 class="mb-1 profile-milestone-title"><%= latestMilestone.MilestoneTitle %></h5>
                                <p class="text-muted mb-0 profile-milestone-date"><%= latestMilestone.MilestoneDate ? new Date(latestMilestone.MilestoneDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'Date TBD' %></p>
                            <% } else { %>
                                <h5 class="mb-1 profile-milestone-title">No milestones yet</h5>
                                <p class="text-muted mb-0 profile-milestone-date">Keep going!</p>
                            <% } %>
                        </div>
                    </div>
                </a>
            </div>
            <% if (showDonationsCard) { %>
            <div class="col-md-4">
                <a href="/donations" class="text-decoration-none text-reset d-block h-100">
                    <div class="card h-100 text-center shadow-sm profile-kpi-card">
                        <div class="card-body profile-kpi-card-body">
                            <p class="text-muted text-uppercase small profile-kpi-label">Total Donations</p>
                            <h3 class="display-6 kpi-value-display">$<%= kpiMetrics.totalDonationsDisplay || '0.00' %></h3>
                        </div>
                    </div>
                </a>
            </div>
            <% } %>
        </div>

        <div class="my-events-section mb-4">
            <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between mb-3">
                <h2 class="mb-2 mb-md-0">My Events</h2>
                <div class="occurrence-toggle" id="profile-events-toggle">
                    <button type="button" class="toggle-btn active" data-filter="upcoming">Upcoming</button>
                    <button type="button" class="toggle-btn" data-filter="past">Past</button>
                </div>
            </div>
            <div class="occurrences-list" id="profileEventsList">
                <% if (userEvents && userEvents.length) { %>
                    <% userEvents.forEach(ev => { 
                        const startDate = ev.start ? new Date(ev.start) : null;
                        const endDate = ev.end ? new Date(ev.end) : null;
                        const isToday = startDate && startDate.toDateString() === new Date().toDateString();
                        const isThisYear = startDate && startDate.getFullYear() === new Date().getFullYear();
                        const imgSrc = `/images/events/event_${ev.eventId}.jpg`;
                        const statusLower = ev.status ? ev.status.toLowerCase() : '';
                        const isCancelled = statusLower === 'cancelled';
                        const pillLabel = ev.isPast 
                            ? (ev.attended ? 'Attended' : (isCancelled ? 'Cancelled' : 'No Show')) 
                            : (isCancelled ? 'Cancelled' : (ev.attended ? 'Checked In' : 'Registered'));
                        const pillCls = (pillLabel === 'Attended' || pillLabel === 'Checked In')
                            ? 'status-pill--good'
                            : (pillLabel === 'Cancelled')
                                ? 'status-pill--neutral'
                                : (pillLabel === 'No Show')
                                    ? 'status-pill--bad'
                                    : 'status-pill--neutral';
                        const statusIcon = pillLabel === 'Attended'
                            ? 'fa-user-check'
                            : pillLabel === 'Checked In'
                                ? 'fa-person-walking'
                                : pillLabel === 'Cancelled'
                                    ? 'fa-ban'
                                    : 'fa-user-clock';
                        let typeIcon = 'fa-tag';
                        let typeColor = '#6B6F6B';
                        if (ev.eventType === 'STEM') {
                            typeIcon = 'fa-gear';
                            typeColor = '#99B7C6';
                        } else if (ev.eventType === 'Arts') {
                            typeIcon = 'fa-paintbrush';
                            typeColor = '#F4B092';
                        } else if (ev.eventType === 'Leadership') {
                            typeIcon = 'fa-users';
                            typeColor = '#9AB59D';
                        } else if (ev.eventType === 'Annual Conference') {
                            typeIcon = 'fa-calendar-star';
                            typeColor = '#978EC4';
                        }
                    %>
                        <div class="occurrence-card my-event-card <%= (ev.isPast && ev.attended && !ev.surveyId) ? 'survey-missing' : '' %>"
                             data-is-past="<%= ev.isPast %>"
                             data-registration-id="<%= ev.registrationId %>"
                             data-occurrence-id="<%= ev.occurrenceId %>"
                             data-start="<%= ev.start ? ev.start.toISOString() : '' %>"
                             data-end="<%= ev.end ? ev.end.toISOString() : '' %>"
                             data-deadline="<%= ev.deadline ? ev.deadline.toISOString() : '' %>"
                             data-survey-id="<%= ev.surveyId || '' %>"
                             data-status="<%= ev.status %>"
                             data-attended="<%= ev.attended %>">
                            <!-- Image -->
                            <div class="my-event-image">
                                <img src="<%- imgSrc %>" alt="<%= ev.eventName %>" onerror="this.src='/images/events/event_0_real.png'">
                            </div>
                            
                            <!-- Main Info: Title, Date, Registered/Past Badge -->
                            <div class="my-event-main-info">
                                <h3 class="event-title"><%= ev.eventName %></h3>
                                <div class="occurrence-date">
                                    <%= startDate
                                        ? (isToday
                                            ? 'Today'
                                            : startDate.toLocaleDateString('en-US', isThisYear
                                                ? { weekday: 'short', month: 'short', day: 'numeric' }
                                                : { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' }))
                                        : 'Date TBD' %>
                                </div>
                                <span class="status-badge <%= ev.isPast ? 'status-past' : 'status-available' %>">
                                    <i class="fa-solid <%= ev.isPast ? 'fa-clock' : 'fa-users' %>"></i>
                                    <%= ev.isPast ? 'Past' : 'Registered' %>
                                </span>
                            </div>
                            
                            <!-- Details: Location, Time, Type -->
                            <div class="my-event-details">
                                <% if (ev.location) { %>
                                <div class="occurrence-detail-item">
                                    <i class="fa-solid fa-location-dot"></i>
                                    <span><%= ev.location %></span>
                                </div>
                                <% } %>
                                <div class="occurrence-detail-item">
                                    <i class="fa-solid fa-clock"></i>
                                    <span>
                                        <%= startDate
                                            ? startDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })
                                            : 'Time TBD' %>
                                        <% if (endDate) { %>
                                            - <%= endDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true }) %>
                                        <% } %>
                                    </span>
                                </div>
                                <% if (ev.eventType) { %>
                                <div class="occurrence-detail-item">
                                    <i class="fa-solid <%= typeIcon %>"></i>
                                    <span><%= ev.eventType %></span>
                                </div>
                                <% } %>
                            </div>
                            
                            <!-- Status Pill -->
                            <div class="my-event-status-pill">
                                <span class="status-pill <%= pillCls %>">
                                    <i class="fa-solid <%= statusIcon %>"></i>
                                    <span><%= pillLabel %></span>
                                </span>
                            </div>
                            
                            <!-- Survey/Action Merged - Only for Past Events -->
                            <% if (ev.isPast && ev.attended) { %>
                                <div class="my-event-survey-action">
                                    <% if (ev.surveyId) { %>
                                        <a class="survey-badge" href="/surveys?filterSurveyID=<%= ev.surveyId %>">
                                            <i class="fa-solid fa-check"></i>
                                            Survey Complete
                                        </a>
                                    <% } else { %>
                                        <button type="button" class="survey-badge missing survey-missing-btn" 
                                                data-registration-id="<%= ev.registrationId %>"
                                                data-occurrence-id="<%= ev.occurrenceId %>">
                                            <i class="fa-solid fa-circle-check"></i>
                                            Fill Survey
                                        </button>
                                    <% } %>
                                </div>
                            <% } else { %>
                                <!-- Action Button for Upcoming Events -->
                                <div class="my-event-survey-action occurrence-actions"></div>
                            <% } %>
                        </div>
                    <% }); %>
                <% } else { %>
                    <div class="no-occurrences">You have not registered for any events yet.</div>
                <% } %>
            </div>
        </div>

        
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Phone formatting
        const userPhoneInput = document.getElementById('userParticipantPhone');
        if (userPhoneInput) {
            userPhoneInput.addEventListener('input', function () {
                let digits = userPhoneInput.value.replace(/\D/g, '');
                if (digits.length > 10) {
                    digits = digits.slice(0, 10);
                }
                let formatted = '';
                if (digits.length > 0) {
                    formatted = digits.substring(0, 3);
                }
                if (digits.length >= 4) {
                    formatted += '-' + digits.substring(3, 6);
                }
                if (digits.length >= 7) {
                    formatted += '-' + digits.substring(6, 10);
                }
                userPhoneInput.value = formatted;
            });
        }

        // My events filter
        const toggle = document.getElementById('profile-events-toggle');
        let cards = Array.from(document.querySelectorAll('.my-event-card'));
        const applyFilter = (filter) => {
            cards.forEach(card => {
                const isPast = card.getAttribute('data-is-past') === 'true';
                const show = filter === 'past' ? isPast : !isPast;
                card.style.display = show ? '' : 'none';
            });
        };
        if (toggle) {
            toggle.querySelectorAll('.toggle-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    toggle.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    applyFilter(btn.getAttribute('data-filter'));
                });
            });
            applyFilter('upcoming');
        }

        // Confirmation modal
        const confirmModal = document.createElement('div');
        confirmModal.className = 'reg-confirm-backdrop active';
        confirmModal.style.display = 'none';
        confirmModal.innerHTML = `
            <div class="reg-confirm-modal">
                <h4 class="modal-confirm-title">Confirm</h4>
                <p id="profileConfirmMessage" class="modal-confirm-message">Are you sure?</p>
                <div class="reg-confirm-actions">
                    <button type="button" class="btn btn-outline-secondary" id="profileConfirmNo">Cancel</button>
                    <button type="button" class="btn btn-danger" id="profileConfirmYes">Confirm</button>
                </div>
            </div>
        `;
        document.body.appendChild(confirmModal);
        const confirmMsg = confirmModal.querySelector('#profileConfirmMessage');
        const confirmYes = confirmModal.querySelector('#profileConfirmYes');
        const confirmNo = confirmModal.querySelector('#profileConfirmNo');
        let confirmResolver = null;

        const openConfirm = (message) => {
            confirmMsg.textContent = message || 'Are you sure?';
            confirmModal.style.display = 'flex';
            return new Promise(resolve => { confirmResolver = resolve; });
        };
        const closeConfirm = (result) => {
            confirmModal.style.display = 'none';
            if (confirmResolver) {
                confirmResolver(result);
                confirmResolver = null;
            }
        };
        confirmYes.addEventListener('click', () => closeConfirm(true));
        confirmNo.addEventListener('click', () => closeConfirm(false));
        confirmModal.addEventListener('click', (e) => {
            if (e.target === confirmModal) {
                closeConfirm(false);
            }
        });

        // Action buttons
        const profileNow = Date.now();
        const setStatusPill = (card, label, cls) => {
            const pillContainer = card.querySelector('.my-event-status-pill');
            if (!pillContainer) return;
            const pill = pillContainer.querySelector('.status-pill');
            if (!pill) return;
            const icon = label === 'Attended'
                ? 'fa-user-check'
                : label === 'Checked In'
                    ? 'fa-person-walking'
                    : label === 'Cancelled'
                        ? 'fa-ban'
                        : label === 'No Show'
                            ? 'fa-user-clock'
                            : 'fa-user-clock';
            pill.innerHTML = `<i class="fa-solid ${icon}"></i><span>${label}</span>`;
            pill.className = `status-pill ${cls}`;
        };
        const addSurveyBadge = (card, surveyId) => {
            const surveyActionBox = card.querySelector('.my-event-survey-action');
            if (!surveyActionBox) return;
            
            const isPast = card.getAttribute('data-is-past') === 'true';
            const attended = card.getAttribute('data-attended') === 'true';
            
            if (isPast && attended) {
                surveyActionBox.innerHTML = '';
                if (surveyId) {
                    const a = document.createElement('a');
                    a.className = 'survey-badge';
                    a.href = `/surveys?filterSurveyID=${surveyId}`;
                    a.innerHTML = `<i class="fa-solid fa-check"></i> Survey Complete`;
                    surveyActionBox.appendChild(a);
                    // Remove survey-missing class from card
                    card.classList.remove('survey-missing');
                } else {
                    const regId = card.getAttribute('data-registration-id');
                    const occId = card.getAttribute('data-occurrence-id');
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'survey-badge missing survey-missing-btn';
                    btn.setAttribute('data-registration-id', regId);
                    btn.setAttribute('data-occurrence-id', occId);
                    btn.innerHTML = `<i class="fa-solid fa-circle-check"></i> Fill Survey`;
                    btn.addEventListener('click', () => {
                        openSurveyModal(card);
                    });
                    surveyActionBox.appendChild(btn);
                    // Add survey-missing class to card
                    card.classList.add('survey-missing');
                }
            }
        };

        const renderActions = (card) => {
            // For past events, survey/action is already handled in the HTML
            const isPast = card.getAttribute('data-is-past') === 'true';
            if (isPast) {
                // Add event listener to survey missing button if it exists
                const surveyMissingBtn = card.querySelector('.survey-missing-btn');
                if (surveyMissingBtn && !surveyMissingBtn.hasAttribute('data-listener-added')) {
                    surveyMissingBtn.setAttribute('data-listener-added', 'true');
                    surveyMissingBtn.addEventListener('click', () => {
                        openSurveyModal(card);
                    });
                }
                return;
            }

            // For upcoming events, use the merged survey/action column
            const actions = card.querySelector('.my-event-survey-action.occurrence-actions');
            if (!actions) return;

            const status = (card.getAttribute('data-status') || '').toLowerCase();
            const attended = card.getAttribute('data-attended') === 'true';
            const start = card.getAttribute('data-start') ? new Date(card.getAttribute('data-start')) : null;
            const end = card.getAttribute('data-end') ? new Date(card.getAttribute('data-end')) : null;
            const deadline = card.getAttribute('data-deadline') ? new Date(card.getAttribute('data-deadline')) : null;
            const regId = card.getAttribute('data-registration-id');
            const occId = card.getAttribute('data-occurrence-id');
            const nowMs = Date.now();

            actions.innerHTML = '';

            // Check if event is currently happening (started but not ended)
            const isHappeningNow = start && nowMs >= start.getTime() && (!end || nowMs <= end.getTime());

            // If event is happening now, allow check-in
            if (isHappeningNow && !attended) {
                const btn = document.createElement('button');
                btn.className = 'btn btn-secondary btn-sm';
                btn.innerHTML = '<i class="fa-solid fa-person-walking"></i> Check In';
                btn.addEventListener('click', async () => {
                    btn.disabled = true;
                    try {
                        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
                        const res = await fetch(`/registrations/${regId}/check-in`, { 
                            method: 'POST',
                            headers: {
                                'X-CSRF-Token': csrfToken
                            }
                        });
                        const data = await res.json();
                        if (!data.success) throw new Error(data.error || 'Error');
                        card.setAttribute('data-attended', 'true');
                        card.setAttribute('data-status', 'Registered');
                        setStatusPill(card, 'Checked In', 'status-pill--good');
                        // For current events, just clear the action
                        actions.innerHTML = '';
                    } catch (err) {
                        alert(err.message || 'Error checking in');
                        btn.disabled = false;
                    }
                });
                actions.appendChild(btn);
                return;
            }

            if (deadline && nowMs < deadline.getTime()) {
                const btn = document.createElement('button');
                btn.className = 'btn btn-outline-secondary btn-sm';
                btn.innerHTML = '<i class="fa-solid fa-user-minus"></i> Unregister';
                btn.addEventListener('click', async () => {
                    const confirmed = await openConfirm('Unregister from this event?');
                    if (!confirmed) return;
                    btn.disabled = true;
                    try {
                        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
                        const res = await fetch('/unregister-occurrence', {
                            method: 'POST',
                            headers: { 
                                'Content-Type': 'application/json',
                                'X-CSRF-Token': csrfToken
                            },
                            body: JSON.stringify({ occurrenceId: Number(occId) })
                        });
                        const data = await res.json();
                        if (!data.success) throw new Error(data.error || 'Error');
                        const idx = cards.indexOf(card);
                        if (idx >= 0) cards.splice(idx, 1);
                        card.remove();
                        applyFilter(toggle?.querySelector('.toggle-btn.active')?.getAttribute('data-filter') || 'upcoming');
                    } catch (err) {
                        alert(err.message || 'Error unregistering');
                        btn.disabled = false;
                    }
                });
                actions.appendChild(btn);
                return;
            }

            // Don't show cancel button if already cancelled
            if (status === 'cancelled') {
                actions.innerHTML = '';
                return;
            }
            
            // Show cancel button if:
            // 1. Event hasn't started yet (start && nowMs < start.getTime()), OR
            // 2. Deadline has passed but event hasn't started (deadline && nowMs >= deadline.getTime() && start && nowMs < start.getTime())
            // Actually, we can simplify: show cancel if event hasn't started, regardless of deadline
            if (start && nowMs < start.getTime()) {
                const btn = document.createElement('button');
                btn.className = 'btn btn-outline-secondary btn-sm';
                btn.innerHTML = '<i class="fa-solid fa-ban"></i> Cancel';
                btn.addEventListener('click', async () => {
                    const confirmed = await openConfirm('Cancel this registration?');
                    if (!confirmed) return;
                    btn.disabled = true;
                    try {
                        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
                        const res = await fetch(`/registrations/${regId}/cancel`, { 
                            method: 'POST',
                            headers: {
                                'X-CSRF-Token': csrfToken
                            }
                        });
                        const data = await res.json();
                        if (!data.success) throw new Error(data.error || 'Error');
                        card.setAttribute('data-status', 'Cancelled');
                        setStatusPill(card, 'Cancelled', 'status-pill--neutral');
                        actions.innerHTML = '';
                    } catch (err) {
                        alert(err.message || 'Error cancelling');
                        btn.disabled = false;
                    }
                });
                actions.appendChild(btn);
                return;
            }

        };

        cards.forEach(renderActions);
        const activeFilter = toggle?.querySelector('.toggle-btn.active')?.getAttribute('data-filter') || 'upcoming';
        applyFilter(activeFilter);

        // Survey Modal
        const surveyBackdrop = document.createElement('div');
        surveyBackdrop.className = 'reg-confirm-backdrop';
        surveyBackdrop.id = 'surveyModalBackdrop';
        surveyBackdrop.innerHTML = `
            <div class="reg-confirm-modal survey-modal-container">
                <div class="survey-modal-header">
                    <h4 class="survey-modal-title">Fill Out Survey</h4>
                    <button type="button" class="reg-modal-close survey-modal-close-btn" id="surveyModalClose">&times;</button>
                </div>
                <div id="surveyModalEventInfo" class="survey-modal-event-info">
                    <!-- Event info will be populated here -->
                </div>
                <form id="surveyForm">
                    <input type="hidden" id="surveyRegistrationId" name="registrationId">
                    <div class="survey-rating-grid">
                        <div>
                            <label class="form-label survey-form-label">Satisfaction *</label>
                            <div class="survey-rating-container">
                                <input type="range" id="surveySatisfaction" name="satisfaction" min="0" max="5" value="3" step="1" class="survey-range-input" required>
                                <span id="surveySatisfactionValue" class="survey-rating-value">3</span>
                            </div>
                        </div>
                        <div>
                            <label class="form-label survey-form-label">Usefulness *</label>
                            <div class="survey-rating-container">
                                <input type="range" id="surveyUsefulness" name="usefulness" min="0" max="5" value="3" step="1" class="survey-range-input" required>
                                <span id="surveyUsefulnessValue" class="survey-rating-value">3</span>
                            </div>
                        </div>
                        <div>
                            <label class="form-label survey-form-label">Instructor *</label>
                            <div class="survey-rating-container">
                                <input type="range" id="surveyInstructor" name="instructor" min="0" max="5" value="3" step="1" class="survey-range-input" required>
                                <span id="surveyInstructorValue" class="survey-rating-value">3</span>
                            </div>
                        </div>
                        <div>
                            <label class="form-label survey-form-label">Recommendation *</label>
                            <div class="survey-rating-container">
                                <input type="range" id="surveyRecommendation" name="recommendation" min="0" max="5" value="3" step="1" class="survey-range-input" required>
                                <span id="surveyRecommendationValue" class="survey-rating-value">3</span>
                            </div>
                        </div>
                    </div>
                    <div class="survey-comments-section">
                        <label class="form-label survey-form-label">Comments</label>
                        <textarea id="surveyComments" name="comments" rows="3" class="form-control" placeholder="Optional feedback..."></textarea>
                    </div>
                    <div class="survey-modal-buttons">
                        <button type="button" class="btn btn-outline-secondary" id="surveyModalCancel">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="surveyModalSubmit">Submit Survey</button>
                    </div>
                </form>
            </div>
        `;
        document.body.appendChild(surveyBackdrop);

        const surveyModalClose = document.getElementById('surveyModalClose');
        const surveyModalCancel = document.getElementById('surveyModalCancel');
        const surveyForm = document.getElementById('surveyForm');
        const surveySatisfaction = document.getElementById('surveySatisfaction');
        const surveyUsefulness = document.getElementById('surveyUsefulness');
        const surveyInstructor = document.getElementById('surveyInstructor');
        const surveyRecommendation = document.getElementById('surveyRecommendation');
        const surveySatisfactionValue = document.getElementById('surveySatisfactionValue');
        const surveyUsefulnessValue = document.getElementById('surveyUsefulnessValue');
        const surveyInstructorValue = document.getElementById('surveyInstructorValue');
        const surveyRecommendationValue = document.getElementById('surveyRecommendationValue');

        // Update slider values
        if (surveySatisfaction) {
            surveySatisfaction.addEventListener('input', (e) => {
                surveySatisfactionValue.textContent = e.target.value;
            });
        }
        if (surveyUsefulness) {
            surveyUsefulness.addEventListener('input', (e) => {
                surveyUsefulnessValue.textContent = e.target.value;
            });
        }
        if (surveyInstructor) {
            surveyInstructor.addEventListener('input', (e) => {
                surveyInstructorValue.textContent = e.target.value;
            });
        }
        if (surveyRecommendation) {
            surveyRecommendation.addEventListener('input', (e) => {
                surveyRecommendationValue.textContent = e.target.value;
            });
        }

        const openSurveyModal = async (card) => {
            const occId = card.getAttribute('data-occurrence-id');
            const regId = card.getAttribute('data-registration-id');
            if (!occId || !regId) return;

            try {
                const res = await fetch(`/api/occurrence/${occId}/survey-info`);
                const data = await res.json();
                if (!data.success) throw new Error(data.error || 'Failed to load event info');

                const eventInfo = document.getElementById('surveyModalEventInfo');
                const startDate = data.eventStart ? new Date(data.eventStart) : null;
                const dateStr = startDate ? startDate.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    month: 'long', 
                    day: 'numeric', 
                    year: 'numeric' 
                }) : 'Date TBD';

                eventInfo.innerHTML = `
                    <h5 class="survey-event-card-title">${data.eventName || 'Event'}</h5>
                    <p class="survey-event-card-date">${dateStr}</p>
                `;

                document.getElementById('surveyRegistrationId').value = regId;
                surveyBackdrop.classList.add('active');
            } catch (err) {
                console.error('Error loading survey info:', err);
                alert('Error loading event information. Please try again.');
            }
        };

        const closeSurveyModal = () => {
            surveyBackdrop.classList.remove('active');
            if (surveyForm) surveyForm.reset();
            if (surveySatisfaction) surveySatisfaction.value = 3;
            if (surveyUsefulness) surveyUsefulness.value = 3;
            if (surveyInstructor) surveyInstructor.value = 3;
            if (surveyRecommendation) surveyRecommendation.value = 3;
            surveySatisfactionValue.textContent = '3';
            surveyUsefulnessValue.textContent = '3';
            surveyInstructorValue.textContent = '3';
            surveyRecommendationValue.textContent = '3';
        };

        if (surveyModalClose) {
            surveyModalClose.addEventListener('click', closeSurveyModal);
        }
        if (surveyModalCancel) {
            surveyModalCancel.addEventListener('click', closeSurveyModal);
        }
        if (surveyBackdrop) {
            surveyBackdrop.addEventListener('click', (e) => {
                if (e.target === surveyBackdrop) {
                    closeSurveyModal();
                }
            });
        }

        if (surveyForm) {
            surveyForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitBtn = document.getElementById('surveyModalSubmit');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Submitting...';

                try {
                    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
                    const res = await fetch('/surveys/create', {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'X-CSRF-Token': csrfToken
                        },
                        body: JSON.stringify({
                            registrationId: document.getElementById('surveyRegistrationId').value,
                            satisfaction: parseInt(surveySatisfaction.value, 10),
                            usefulness: parseInt(surveyUsefulness.value, 10),
                            instructor: parseInt(surveyInstructor.value, 10),
                            recommendation: parseInt(surveyRecommendation.value, 10),
                            comments: surveyForm.querySelector('#surveyComments').value || null
                        })
                    });

                    const data = await res.json();
                    if (!data.success) {
                        throw new Error(data.error || 'Failed to submit survey');
                    }

                    // Update the card
                    const card = document.querySelector(`[data-registration-id="${document.getElementById('surveyRegistrationId').value}"]`);
                    if (card) {
                        card.setAttribute('data-survey-id', data.surveyId);
                        addSurveyBadge(card, data.surveyId);
                        // Remove survey-missing class after survey is submitted
                        card.classList.remove('survey-missing');
                    }

                    closeSurveyModal();
                } catch (err) {
                    console.error('Error submitting survey:', err);
                    alert(err.message || 'Error submitting survey. Please try again.');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit Survey';
                }
            });
        }
    });
</script>
