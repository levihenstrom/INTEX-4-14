<% pageTitle = 'Donations'; %>
<% if (!user) { %>
<!-- Visitor Donation Page -->
<div class="donate-page">
    <!-- Cover Image -->
    <div class="donate-cover-image">
        <img src="/images/ella_donate.jpg" alt="Ella Rises Campaign" class="donate-cover-img">
    </div>

    <!-- Title Section -->
    <div class="donate-header-card">
        <div class="donate-header-card-body">
            <h1 class="donate-main-title">Rise With Ella: Empowering Futures Together</h1>
            <p class="donate-main-subtitle">We believe in the power of community and the brilliance of our youth.</p>
        </div>
    </div>

    <!-- Two Cards Layout -->
    <div class="row justify-content-center g-3">
        <!-- First Card: Information Card -->
        <div class="col-12 col-lg-7">
            <div class="donate-info-card">
                <div class="donate-info-card-body">
                    <div class="donate-section">
                        <h3 class="donate-section-title">Why We're Fundraising</h3>
                        <p class="donate-section-text">Your generous contribution will impact these programs and experiences:</p>
                        <ul class="donate-programs">
                            <li><strong>Ella Rises Youth Summits:</strong> Day camps focused on the Ella Rises Experience* across the state of Utah.</li>
                            <li><strong>Educational tours:</strong> Visits to local universities, colleges, and businesses.</li>
                            <li><strong>STEM, education, and arts programs:</strong> Including the Ella Rises Mariachi band and Ballet Folklorico.</li>
                        </ul>
                        <p class="donate-note"><em>*The Ella Rises Experience is a joyful blend of art, STEM, and educational exploration — designed to build confidence in each girl's divine worth and purpose.</em></p>
                    </div>

                    <div class="donate-section">
                        <h3 class="donate-section-title">Here's How You Can Help Today</h3>
                        <ul class="donate-help-list">
                            <li><strong>Donate</strong> — Make a one-time or monthly gift.</li>
                            <li><strong>Share</strong> — Post our campaign on your social platforms.</li>
                            <li><strong>Join</strong> — Become a mentor, volunteer, or community partner.</li>
                        </ul>
                        <p class="donate-closing">With your support, <strong>Ella Rises.</strong></p>
                        <p class="donate-signature">With gratitude,<br><em>Nadia Cates, Founder of Ella Rises</em></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Second Card: Donation Form Card -->
        <div class="col-12 col-lg-5">
            <div class="donate-form-card">
                <div class="donate-form-card-body">
                    <% if (typeof error !== 'undefined' && error) { %>
                        <div class="donate-alert"><%= error %></div>
                    <% } %>
                    <% if (typeof success !== 'undefined' && success) { %>
                        <div class="donate-success"><%= success %></div>
                    <% } %>

                    <form id="VisitorDonateForm" action="/donations/add/visitor" method="POST" class="donate-form">
                        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                        <h3 class="donate-form-title">Make a Donation</h3>
                        
                        <div class="donate-amount-section">
                            <label class="donate-label">Donation Amount</label>
                            <div class="donate-quick-amounts">
                                <button type="button" class="donate-quick-btn" data-amount="25">$25</button>
                                <button type="button" class="donate-quick-btn" data-amount="50">$50</button>
                                <button type="button" class="donate-quick-btn" data-amount="100">$100</button>
                                <button type="button" class="donate-quick-btn" data-amount="250">$250</button>
                            </div>
                            <div class="donate-amount-input-group">
                                <span class="donate-currency">$</span>
                                <input type="number" step="0.01" min="0.01" class="donate-amount-input" id="VisitorDonateAmount" name="DonationAmount" placeholder="0.00" required>
                            </div>
                        </div>

                        <div class="donate-form-group">
                            <label for="FirstName" class="donate-label">First Name *</label>
                            <input type="text" class="donate-input" id="FirstName" name="FirstName" required>
                        </div>
                        <div class="donate-form-group">
                            <label for="LastName" class="donate-label">Last Name *</label>
                            <input type="text" class="donate-input" id="LastName" name="LastName" required>
                        </div>
                        <div class="donate-form-group">
                            <label for="Email" class="donate-label">Email *</label>
                            <input type="email" class="donate-input" id="Email" name="Email" required>
                        </div>
                        
                        <input type="hidden" id="addDonationDate" name="DonationDate" value="<%= new Date().toISOString().split('T')[0] %>">
                        
                        <div class="donate-button-group">
                            <button type="submit" class="donate-btn-primary">Donate Now</button>
                        </div>
                        
                        <p class="donate-footer-note">By donating, you'll be redirected to our secure payment processor to complete your contribution.</p>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* ====================================================== */
/*                    DONATE PAGE STYLING                */
/* ====================================================== */

.donate-page {
    padding: 0 0 2rem 0;
    max-width: 1200px;
    margin: 0 auto;
}

/* Cover Image */
.donate-cover-image {
    width: 100%;
    height: 300px;
    overflow: hidden;
    margin-bottom: 2rem;
    border-radius: 12px;
}

.donate-cover-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
}

/* Header Card Section */
.donate-header-card {
    background: linear-gradient(135deg, #9AB59D 0%, #7fa082 100%);
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(154, 181, 157, 0.25);
    margin-bottom: 1.5rem;
    overflow: hidden;
    animation: fadeInScale 0.6s ease both;
}

.donate-header-card-body {
    text-align: center;
    padding: 1.5rem 2rem;
}

.donate-main-title {
    font-family: 'DM Serif Display', serif;
    font-size: 1.75rem;
    color: #FFFFFF;
    margin-bottom: 0.5rem;
    line-height: 1.2;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.donate-main-subtitle {
    font-family: 'Montserrat', sans-serif;
    font-size: 0.95rem;
    color: #FFFFFF;
    margin-bottom: 0;
    line-height: 1.5;
    opacity: 0.95;
}

/* Information Card */
.donate-info-card {
    background: #FFFFFF;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(58, 63, 59, 0.08);
    overflow: hidden;
    animation: fadeInScale 0.6s ease both;
    height: 100%;
}

.donate-info-card-body {
    padding: 1.5rem;
}

/* Form Card */
.donate-form-card {
    background: #FFFFFF;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(58, 63, 59, 0.08);
    overflow: hidden;
    animation: fadeInScale 0.6s ease 0.2s both;
    height: fit-content;
}

.donate-form-card-body {
    padding: 1.25rem;
}

.donate-section {
    margin-bottom: 1.5rem;
}

.donate-section:last-child {
    margin-bottom: 0;
}

.donate-section-title {
    font-family: 'DM Serif Display', serif;
    font-size: 1.4rem;
    color: #3A3F3B;
    margin-bottom: 0.75rem;
    font-weight: 600;
}

.donate-section-text {
    font-family: 'Montserrat', sans-serif;
    font-size: 1rem;
    color: #5A5E5A;
    margin-bottom: 0.75rem;
    line-height: 1.6;
}

.donate-programs {
    font-family: 'Montserrat', sans-serif;
    font-size: 0.95rem;
    color: #3A3F3B;
    margin-left: 1.25rem;
    margin-bottom: 0.75rem;
    line-height: 1.7;
    list-style: disc;
}

.donate-programs li {
    margin-bottom: 0.65rem;
}

.donate-help-list {
    font-family: 'Montserrat', sans-serif;
    font-size: 0.85rem;
    color: #3A3F3B;
    margin-left: 1.25rem;
    margin-bottom: 1rem;
    line-height: 1.6;
    list-style: disc;
}

.donate-help-list li {
    margin-bottom: 0.5rem;
}

.donate-note {
    font-family: 'Montserrat', sans-serif;
    font-size: 0.9rem;
    color: #7A7E7A;
    font-style: italic;
    margin-top: 0.75rem;
    padding-top: 0.75rem;
    border-top: 1px solid #E5E5E5;
    line-height: 1.6;
}

.donate-closing {
    font-family: 'Montserrat', sans-serif;
    font-size: 0.9rem;
    color: #3A3F3B;
    margin-bottom: 1rem;
    line-height: 1.5;
}

.donate-signature {
    font-family: 'Montserrat', sans-serif;
    font-size: 0.85rem;
    color: #5A5E5A;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #E5E5E5;
    line-height: 1.5;
}

.donate-alert {
    background: #FFD8D1;
    color: #9AB59D;
    padding: 1rem 1.25rem;
    border-radius: 12px;
    margin-bottom: 1.5rem;
    font-family: 'Montserrat', sans-serif;
    font-size: 0.95rem;
    border-left: 4px solid #9AB59D;
}

.donate-success {
    background: #9AB59D;
    color: #FFFFFF;
    padding: 1rem 1.25rem;
    border-radius: 12px;
    margin-bottom: 1.5rem;
    font-family: 'Montserrat', sans-serif;
    font-size: 0.95rem;
}

.donate-form {
    background: transparent;
    border: none;
    padding: 0;
}

.donate-form-title {
    font-family: 'DM Serif Display', serif;
    font-size: 1.35rem;
    color: #3A3F3B;
    margin-bottom: 1rem;
}

.donate-amount-section {
    margin-bottom: 1.25rem;
}

.donate-quick-amounts {
    display: flex;
    gap: 0.75rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
}

.donate-quick-btn {
    flex: 1;
    min-width: 80px;
    padding: 0.75rem 1rem;
    background: #FFFFFF;
    border: 2px solid #9AB59D;
    border-radius: 12px;
    color: #9AB59D;
    font-family: 'Montserrat', sans-serif;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.donate-quick-btn:hover,
.donate-quick-btn.active {
    background: #9AB59D;
    color: #FFFFFF;
    transform: translateY(-2px);
}

.donate-amount-input-group {
    display: flex;
    align-items: center;
    border: 2px solid #E5E5E5;
    border-radius: 12px;
    padding: 0.875rem 1.25rem;
    transition: all 0.3s ease;
}

.donate-amount-input-group:focus-within {
    border-color: #9AB59D;
    box-shadow: 0 0 0 3px rgba(154, 181, 157, 0.1);
}

.donate-currency {
    font-family: 'Montserrat', sans-serif;
    font-weight: 600;
    font-size: 1.2rem;
    color: #3A3F3B;
    margin-right: 0.5rem;
}

.donate-amount-input {
    flex: 1;
    border: none;
    outline: none;
    font-family: 'Montserrat', sans-serif;
    font-size: 1.5rem;
    font-weight: 600;
    color: #3A3F3B;
    background: transparent;
}

.donate-amount-input::placeholder {
    color: #9A9A9A;
    font-weight: 400;
}

.donate-form-group {
    margin-bottom: 1rem;
}

.donate-label {
    display: block;
    font-family: 'Montserrat', sans-serif;
    font-weight: 600;
    font-size: 0.95rem;
    color: #3A3F3B;
    margin-bottom: 0.5rem;
}

.donate-input {
    width: 100%;
    padding: 0.875rem 1.25rem;
    border: 2px solid #E5E5E5;
    border-radius: 12px;
    font-family: 'Montserrat', sans-serif;
    font-size: 1rem;
    color: #3A3F3B;
    background: #FFFFFF;
    transition: all 0.3s ease;
    box-sizing: border-box;
}

.donate-input:focus {
    outline: none;
    border-color: #9AB59D;
    box-shadow: 0 0 0 3px rgba(154, 181, 157, 0.1);
}

.donate-button-group {
    margin-top: 2rem;
}

.donate-btn-primary {
    width: 100%;
    padding: 0.875rem 1.5rem;
    background: #9AB59D;
    color: #FFFFFF;
    border: none;
    border-radius: 12px;
    font-family: 'Montserrat', sans-serif;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 8px 25px rgba(154, 181, 157, 0.3);
}

.donate-btn-primary:hover {
    background: #7fa082;
    transform: translateY(-2px);
    box-shadow: 0 12px 35px rgba(154, 181, 157, 0.4);
}

.donate-footer-note {
    font-family: 'Montserrat', sans-serif;
    font-size: 0.8rem;
    color: #7A7E7A;
    text-align: center;
    margin-top: 1rem;
    line-height: 1.4;
}

/* Responsive */
@media (max-width: 991.98px) {
    .donate-cover-image {
        height: 250px;
        margin-bottom: 1.5rem;
    }

    .donate-header-card-body {
        padding: 1.25rem 1.5rem;
    }

    .donate-main-title {
        font-size: 1.5rem;
    }

    .donate-main-subtitle {
        font-size: 0.9rem;
    }

    .donate-section-title {
        font-size: 1.3rem;
    }

    .donate-info-card-body,
    .donate-form-card-body {
        padding: 1.25rem;
    }

    .donate-section-title {
        font-size: 1.15rem;
    }
}

@media (max-width: 575.98px) {
    .donate-cover-image {
        height: 200px;
        border-radius: 8px;
        margin-bottom: 1rem;
    }

    .donate-header-card-body {
        padding: 1rem 1.25rem;
    }

    .donate-main-title {
        font-size: 1.35rem;
    }

    .donate-main-subtitle {
        font-size: 0.85rem;
    }

    .donate-section-title {
        font-size: 1.2rem;
    }

    .donate-section-text {
        font-size: 0.95rem;
    }

    .donate-programs {
        font-size: 0.9rem;
    }

    .donate-info-card-body,
    .donate-form-card-body {
        padding: 1rem;
    }
    
    .donate-section-title {
        font-size: 1.1rem;
    }

    .donate-section-text,
    .donate-programs,
    .donate-help-list {
        font-size: 0.8rem;
    }
    
    .donate-image-side {
        min-height: 200px;
        max-height: 250px;
    }

    .donate-quick-btn {
        min-width: 100px;
    }
}
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('VisitorDonateForm');
        const amountInput = document.getElementById('VisitorDonateAmount');
        const quickAmountBtns = document.querySelectorAll('.donate-quick-btn');

        // Quick amount buttons
        quickAmountBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const amount = this.getAttribute('data-amount');
                amountInput.value = amount;
                
                // Update active state
                quickAmountBtns.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
            });
        });

        form.addEventListener('submit', function(e) {
            const amount = amountInput.value;
            if (amount && parseFloat(amount) > 0) {
                // Open Givebutter in new tab
                window.open(`https://givebutter.com/EllaRises?amount=${encodeURIComponent(amount)}`, '_blank');
                // Form will still submit normally to /donations
            }
        });
    });
</script>
<% } else { %>
    <% const participantChoices = Array.isArray(participantOptions) ? participantOptions : []; %>
    <% const filterValues = filters || {}; %>
    <%
    const filterPairs = [];
    function pushFilterPair(key) {
        if (filterValues[key]) {
            filterPairs.push({ key: key, value: filterValues[key] });
        }
    }
    pushFilterPair('filterParticipantID');
    pushFilterPair('filterDonationID');
    pushFilterPair('filterStartDate');
    pushFilterPair('filterEndDate');
    pushFilterPair('filterTitle');
    pushFilterPair('filterCategory');
    pushFilterPair('filterMinAge');
    pushFilterPair('filterMaxAge');
    pushFilterPair('filterCity');
    pushFilterPair('filterState');
    pushFilterPair('filterRole');
    pushFilterPair('filterInterest');
    const filterQueryString = filterPairs.length ? '&' + filterPairs.map(function(pair) {
        return pair.key + '=' + encodeURIComponent(pair.value);
    }).join('&') : '';
    const sortQueryString = (typeof sortColumn !== 'undefined' ? '&sort=' + encodeURIComponent(sortColumn) : '') + (typeof sortDir !== 'undefined' ? '&sortDir=' + encodeURIComponent(sortDir) : '');
%>
    
    <%
        function formatCurrency(value) {
            if (typeof value !== 'number' || Number.isNaN(value)) {
                return '$0.00';
            }
            return value.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
        }
    %>
    <% const searchValue = typeof searchTerm !== 'undefined' ? searchTerm : ''; %>
    <% const metricsData = metrics || {}; %>
    <% const totalAmountValue = typeof metricsData.totalAmount === 'number' ? metricsData.totalAmount : 0; %>
    <% const monthAmountValue = typeof metricsData.monthAmount === 'number' ? metricsData.monthAmount : 0; %>
    <% const donationCountValue = typeof metricsData.count === 'number' ? metricsData.count : 0; %>

    <div class="milestones-page">
        <!-- Donations Header -->
        <div class="events-header">
            <h1>DONATIONS</h1>
            <p>Track generosity and giving impact. Your contributions help empower young women through education, art, and community programs that build confidence and open doors to higher education.</p>
        </div>
        
        <% if(!isAdmin) { %>
            <div class="mb-4 text-center">
                <button type="button" class="btn btn-primary donations-user-donate-btn" data-bs-toggle="modal" data-bs-target="#DonateModal">
                    <i class="fa-solid fa-hand-holding-heart"></i> Donate
                </button>
            </div>
        <% } %>

        <!-- Donations Chart -->
        <% if (isAdmin) { %>
            <div class="row mb-4">
                <div class="col-12">
                    <div style="position: relative; height: 300px; width: 100%;">
                        <canvas id="donationsByMonthChart"
                            data-search="<%= searchValue || '' %>"
                            data-filter-start-date="<%= filterValues.filterStartDate || '' %>"
                            data-filter-end-date="<%= filterValues.filterEndDate || '' %>"
                            data-filter-min-amount="<%= filterValues.filterMinAmount || '' %>"
                            data-filter-max-amount="<%= filterValues.filterMaxAmount || '' %>">
                        </canvas>
                    </div>
                    <p class="text-muted text-center mt-2 mb-0" style="font-size: 0.85rem;">
                        Click a point to filter donations for that month. Click empty space to clear filters.
                    </p>
                </div>
            </div>
        <% } %>

        <div class="row g-3 mb-4">
            <div class="col-md-4">
                <div class="card text-center shadow-sm h-100 donation-kpi-card">
                    <div class="card-body">
                        <p class="text-muted text-uppercase small mb-1" style="font-family: 'Montserrat', sans-serif; font-weight: 600; letter-spacing: 1px;">Total Donation Amount</p>
                        <h3 class="mb-0" style="font-family: 'DM Serif Display', serif; color: #3A3F3B; font-size: 2rem;"><%= formatCurrency(totalAmountValue) %></h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center shadow-sm h-100 donation-kpi-card">
                    <div class="card-body">
                        <p class="text-muted text-uppercase small mb-1" style="font-family: 'Montserrat', sans-serif; font-weight: 600; letter-spacing: 1px;">Donations This Month</p>
                        <h3 class="mb-0" style="font-family: 'DM Serif Display', serif; color: #3A3F3B; font-size: 2rem;"><%= formatCurrency(monthAmountValue) %></h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center shadow-sm h-100 donation-kpi-card">
                    <div class="card-body">
                        <p class="text-muted text-uppercase small mb-1" style="font-family: 'Montserrat', sans-serif; font-weight: 600; letter-spacing: 1px;">Number of Donations</p>
                        <h3 class="mb-0" style="font-family: 'DM Serif Display', serif; color: #3A3F3B; font-size: 2rem;"><%= donationCountValue %></h3>
                    </div>
                </div>
            </div>
        </div>

        <% if (isAdmin) { %>
            <div class="donations-top-bar mb-4">
                <form method="GET" action="/donations" class="donations-search-form">
                    <% filterPairs.forEach(function(pair) { %>
                        <input type="hidden" name="<%= pair.key %>" value="<%= pair.value %>">
                    <% }); %>
                    <input type="hidden" name="sort" value="<%= typeof sortColumn !== 'undefined' ? sortColumn : 'DonationDate' %>">
                    <input type="hidden" name="sortDir" value="<%= typeof sortDir !== 'undefined' ? sortDir : 'desc' %>">
                    <input type="hidden" name="page" value="1">
                    <div class="donations-search-input-wrapper">
                        <i class="fa-solid fa-search donations-search-icon"></i>
                        <input type="text" class="form-control donations-search-input" name="search" placeholder="Search by donor, amount, or ID..." value="<%= searchValue %>">
                    </div>
                    <% if (searchValue || filterPairs.length > 0) { %>
                        <a href="/donations" class="btn btn-outline-secondary donations-clear-btn donations-search-clear-btn">Clear</a>
                    <% } %>
                </form>
                <div class="donations-actions">
                    <button type="button" class="btn btn-outline-secondary donations-filter-btn" data-bs-toggle="collapse" data-bs-target="#donationsFilterSection" aria-expanded="false" aria-controls="donationsFilterSection">
                        <i class="fa-solid fa-filter"></i> Filter
                    </button>
                    <button type="button" class="btn btn-primary donations-add-btn" id="addDonationBtn">
                        <i class="fa-solid fa-plus"></i> Add Donation
                    </button>
                </div>
            </div>

            <!-- Collapsible Filters + Sorting Section -->
            <div class="collapse mb-4" id="donationsFilterSection">
                <div class="row">
                    <div class="col-12">
                        <div class="card shadow-sm">
                            <div class="card-header bg-white">
                                <h5 class="mb-0">Filters & Sorting</h5>
                            </div>
                            <div class="card-body donations-filter-section">
                                <form method="GET" action="/donations" id="donationsFilterForm">
                                    <% if (searchValue) { %>
                                        <input type="hidden" name="search" value="<%= searchValue %>">
                                    <% } %>
                                    <input type="hidden" name="page" value="1">
                                    
                                    <div class="donations-filter-grid">
                                        <!-- Donation Date Range -->
                                        <div class="donations-filter-group">
                                            <label class="donations-filter-group-label">Donation Date Range</label>
                                            <div class="donations-range-controls">
                                                <div class="donations-range-slider-row">
                                                    <div class="donations-range-input-group">
                                                        <label class="donations-range-label">From</label>
                                                        <input type="date" class="form-control donations-range-input" name="filterStartDate" id="filterStartDate" value="<%= filterValues.filterStartDate || '' %>">
                                                    </div>
                                                    <div class="donations-range-input-group">
                                                        <label class="donations-range-label">To</label>
                                                        <input type="date" class="form-control donations-range-input" name="filterEndDate" id="filterEndDate" value="<%= filterValues.filterEndDate || '' %>">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Location -->
                                        <div class="donations-filter-group">
                                            <label class="donations-filter-group-label">Location</label>
                                            <div class="donations-range-controls">
                                                <div class="donations-range-slider-row">
                                                    <div class="donations-range-input-group" style="position: relative;">
                                                        <label class="donations-range-label">City</label>
                                                        <input type="text" class="form-control reg-participant-search donations-range-input" id="donationsFilterCitySearch" placeholder="Search city..." value="<%= filterValues.filterCity || '' %>" autocomplete="off">
                                                        <div class="reg-search-results" id="donationsFilterCityResults"></div>
                                                        <input type="hidden" name="filterCity" id="donationsFilterCityInput" value="<%= filterValues.filterCity || '' %>">
                                                    </div>
                                                    <div class="donations-range-input-group" style="position: relative;">
                                                        <label class="donations-range-label">State</label>
                                                        <input type="text" class="form-control reg-participant-search donations-range-input" id="donationsFilterStateSearch" placeholder="Search state..." value="<%= filterValues.filterState || '' %>" autocomplete="off">
                                                        <div class="reg-search-results" id="donationsFilterStateResults"></div>
                                                        <input type="hidden" name="filterState" id="donationsFilterStateInput" value="<%= filterValues.filterState || '' %>">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Amount Range -->
                                        <div class="donations-filter-group">
                                            <label class="donations-filter-group-label">Donation Amount Range</label>
                                            <div class="donations-range-controls">
                                                <div class="donations-range-with-inputs">
                                                    <!-- Min input -->
                                                    <div class="donations-range-input-group donations-range-input-group-min">
                                                        <label class="donations-range-label">Min</label>
                                                        <input
                                                            type="text"
                                                            class="form-control donations-range-input"
                                                            name="filterMinAmount"
                                                            id="filterMinAmount"
                                                            value="<%= filterValues.filterMinAmount || '' %>"
                                                            placeholder="min"
                                                        >
                                                    </div>

                                                    <!-- Dual slider -->
                                                    <div class="donations-dual-range-wrapper">
                                                        <input
                                                            type="range"
                                                            class="donations-dual-range donations-dual-range-min"
                                                            id="amountMinSlider"
                                                            min="0"
                                                            max="10000"
                                                            step="10"
                                                            value="<%= filterValues.filterMinAmount ? Math.min(parseFloat(filterValues.filterMinAmount), 10000) : 0 %>"
                                                        >
                                                        <input
                                                            type="range"
                                                            class="donations-dual-range donations-dual-range-max"
                                                            id="amountMaxSlider"
                                                            min="0"
                                                            max="10000"
                                                            step="10"
                                                            value="<%= filterValues.filterMaxAmount ? Math.min(parseFloat(filterValues.filterMaxAmount), 10000) : 10000 %>"
                                                        >
                                                    </div>

                                                    <!-- Max input -->
                                                    <div class="donations-range-input-group donations-range-input-group-max">
                                                        <label class="donations-range-label">Max</label>
                                                        <input
                                                            type="text"
                                                            class="form-control donations-range-input"
                                                            name="filterMaxAmount"
                                                            id="filterMaxAmount"
                                                            value="<%= filterValues.filterMaxAmount || '' %>"
                                                            placeholder="max"
                                                        >
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Age Range -->
                                        <div class="donations-filter-group">
                                            <label class="donations-filter-group-label">Age Range</label>
                                            <div class="donations-range-controls">
                                                <div class="donations-range-with-inputs">
                                                    <!-- Min input -->
                                                    <div class="donations-range-input-group donations-range-input-group-min">
                                                        <label class="donations-range-label">Min</label>
                                                        <input
                                                            type="text"
                                                            class="form-control donations-range-input"
                                                            name="filterMinAge"
                                                            id="filterMinAge"
                                                            value="<%= filterValues.filterMinAge || '' %>"
                                                            placeholder="min"
                                                        >
                                                    </div>

                                                    <!-- Dual slider -->
                                                    <div class="donations-dual-range-wrapper">
                                                        <input
                                                            type="range"
                                                            class="donations-dual-range donations-dual-range-min"
                                                            id="ageMinSlider"
                                                            min="0"
                                                            max="100"
                                                            step="1"
                                                            value="<%= filterValues.filterMinAge ? Math.min(parseInt(filterValues.filterMinAge), 100) : 0 %>"
                                                        >
                                                        <input
                                                            type="range"
                                                            class="donations-dual-range donations-dual-range-max"
                                                            id="ageMaxSlider"
                                                            min="0"
                                                            max="100"
                                                            step="1"
                                                            value="<%= filterValues.filterMaxAge ? Math.min(parseInt(filterValues.filterMaxAge), 100) : 100 %>"
                                                        >
                                                    </div>

                                                    <!-- Max input -->
                                                    <div class="donations-range-input-group donations-range-input-group-max">
                                                        <label class="donations-range-label">Max</label>
                                                        <input
                                                            type="text"
                                                            class="form-control donations-range-input"
                                                            name="filterMaxAge"
                                                            id="filterMaxAge"
                                                            value="<%= filterValues.filterMaxAge || '' %>"
                                                            placeholder="max"
                                                        >
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        

                                        <!-- Participant Role (Icon-based) -->
                                        <div class="donations-filter-group">
                                            <label class="donations-filter-group-label">Participant Role</label>
                                            <div class="event-labels filter-labels" id="donation-role-pills">
                                                <span class="event-label event-label-type-stem filter-pill donation-role-pill" data-role-value="">
                                                    <i class="fa-solid fa-sliders"></i>Any
                                                </span>
                                                <span class="event-label event-label-type-leadership filter-pill donation-role-pill <%= filterValues.filterRole === 'a' ? 'filter-selected' : '' %>" data-role-value="a">
                                                    <i class="fa-solid fa-user-shield"></i>Admin
                                                </span>
                                                <span class="event-label event-label-type-stem filter-pill donation-role-pill <%= filterValues.filterRole === 'p' ? 'filter-selected' : '' %>" data-role-value="p">
                                                    <i class="fa-solid fa-user"></i>Participant
                                                </span>
                                            </div>
                                            <input type="hidden" name="filterRole" id="filterRoleInput" value="<%= filterValues.filterRole || '' %>">
                                        </div>

                                        <!-- Field of Interest (Icon-based) -->
                                        <div class="donations-filter-group">
                                            <label class="donations-filter-group-label">Field of Interest</label>
                                            <div class="event-labels filter-labels" id="donation-interest-pills">
                                                <span class="event-label event-label-type-stem filter-pill donation-interest-pill" data-interest-value="">
                                                    <i class="fa-solid fa-sliders"></i>Any
                                                </span>
                                                <span class="event-label event-label-type-stem filter-pill donation-interest-pill <%= filterValues.filterInterest === 'STEM' ? 'filter-selected' : '' %>" data-interest-value="STEM">
                                                    <i class="fa-solid fa-gear"></i>STEM
                                                </span>
                                                <span class="event-label event-label-type-arts filter-pill donation-interest-pill <%= filterValues.filterInterest === 'Arts' ? 'filter-selected' : '' %>" data-interest-value="Arts">
                                                    <i class="fa-solid fa-paintbrush"></i>Arts
                                                </span>
                                                <span class="event-label event-label-type-annual-conference filter-pill donation-interest-pill <%= filterValues.filterInterest === 'Both' ? 'filter-selected' : '' %>" data-interest-value="Both">
                                                    <i class="fa-solid fa-layer-group"></i>Both
                                                </span>
                                            </div>
                                            <input type="hidden" name="filterInterest" id="filterInterestInput" value="<%= filterValues.filterInterest || '' %>">
                                        </div>

                                        <!-- Sorting -->
                                        <div class="donations-filter-group">
                                            <label class="donations-filter-group-label">Sorting</label>
                                            <div class="donations-range-controls">
                                                <div class="donations-range-slider-row">
                                                    <div class="donations-range-input-group">
                                                        <label class="donations-range-label">Sort By</label>
                                                        <select class="form-select donations-range-input" name="sort">
                                                            <option value="DonationDate" <%= sortColumn === 'DonationDate' ? 'selected' : '' %>>Donation Date</option>
                                                            <option value="DonationAmount" <%= sortColumn === 'DonationAmount' ? 'selected' : '' %>>Donation Amount</option>
                                                            <option value="DonationID" <%= sortColumn === 'DonationID' ? 'selected' : '' %>>Donation ID</option>
                                                        </select>
                                                    </div>
                                                    <div class="donations-range-input-group">
                                                        <label class="donations-range-label">Direction</label>
                                                        <select class="form-select donations-range-input" name="sortDir">
                                                            <option value="desc" <%= sortDir === 'desc' ? 'selected' : '' %>>Descending</option>
                                                            <option value="asc" <%= sortDir === 'asc' ? 'selected' : '' %>>Ascending</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                <!-- Action Buttons -->
                                <div class="donations-filter-actions">
                                    <a href="/donations<%= searchValue ? '?search=' + encodeURIComponent(searchValue) : '' %>" class="btn btn-outline-secondary donations-filter-reset-btn">Reset</a>
                                    <button type="submit" class="btn btn-primary donations-filter-apply-btn">Apply</button>
                                </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        <% } else { %>
            <div class="mb-4"></div>
        <% } %>

        <div class="border-bottom mb-4"></div>

        <% if (typeof error !== 'undefined' && error) { %>
            <div class="alert alert-danger" role="alert"><%= error %></div>
        <% } %>
        <% if (typeof success !== 'undefined' && success) { %>
            <div class="alert alert-success" role="alert"><%= success %></div>
        <% } %>

        <% if (Array.isArray(donations) && donations.length) { %>
            <%
            // Sort donations: most recent first, "date not set" at the end
            // This ensures donations without dates don't appear on the first page
            const sortedDonations = donations.slice().sort(function(a, b) {
                const dateA = a.DonationDate ? new Date(a.DonationDate) : null;
                const dateB = b.DonationDate ? new Date(b.DonationDate) : null;
                
                // Check if dates are null/undefined (date not set)
                const aHasDate = dateA !== null && dateA !== undefined && !isNaN(dateA.getTime());
                const bHasDate = dateB !== null && dateB !== undefined && !isNaN(dateB.getTime());
                
                // If both have dates, sort by date (most recent first)
                if (aHasDate && bHasDate) {
                    return dateB - dateA;
                }
                // If only A has a date, A comes first (dates before no dates)
                if (aHasDate && !bHasDate) {
                    return -1;
                }
                // If only B has a date, B comes first (dates before no dates)
                if (!aHasDate && bHasDate) {
                    return 1;
                }
                // If neither has a date, maintain original order (both at the end)
                return 0;
            });
            %>
            <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-4">
                <% sortedDonations.forEach(function(donation) { %>
                    <div class="col">
                        <div class="card h-100 shadow-sm donation-card">
                            <div class="card-body d-flex flex-column">
                                <div class="d-flex w-100 justify-content-between align-items-start mb-3">
                                    <div class="donation-amount-section">
                                        <h5 class="donation-amount mb-1"><%= formatCurrency(donation.DonationAmountValue) %></h5>
                                        <small class="donation-date"><%= donation.DonationDateDisplay || 'Date not set' %></small>
                                    </div>
                                    <% if (isAdmin) { %>
                                        <div class="donation-actions-group">
                                        <button type="button"
                                                class="btn btn-outline-primary donation-edit-btn"
                                                data-donation-id="<%= donation.DonationID %>"
                                                data-date="<%= donation.DonationDate ? new Date(donation.DonationDate).toISOString().split('T')[0] : '' %>"
                                                data-amount="<%= donation.DonationAmountValue %>"
                                                data-participant-id="<%= donation.ParticipantID %>"
                                                data-participant-display="<%= donation.ParticipantFirstName %> <%= donation.ParticipantLastName %> (#<%= donation.ParticipantID %>) - <%= donation.ParticipantEmail %>">
                                            <i class="fa-solid fa-pencil"></i>
                                        </button>
                                            <button type="button" class="btn btn-outline-danger donation-delete-btn" 
                                                    data-donation-id="<%= donation.DonationID %>"
                                                    data-amount="<%= formatCurrency(donation.DonationAmountValue) %>">
                                                <i class="fa-solid fa-trash"></i>
                                            </button>
                            
                                        </div>
                                    <% } %>
                                </div>
                                <div class="donation-participant-info mb-2">
                                    <p class="mb-1 donation-participant-label">
                                        <strong>Participant:</strong>
                                    </p>
                                    <p class="mb-0 donation-participant-name">
                                        <span class="participant-tooltip" data-bs-toggle="tooltip" data-bs-html="true" title="<%= donation.ParticipantFirstName %> <%= donation.ParticipantLastName %><br>Age: <%= typeof donation.ParticipantAge === 'number' ? donation.ParticipantAge : 'N/A' %><br>City: <%= donation.ParticipantCity || 'N/A' %><br>State: <%= donation.ParticipantState || 'N/A' %><br>Interest: <%= donation.ParticipantFieldOfInterest || 'N/A' %><br>Email: <%= donation.ParticipantEmail %>">
                                            <%= donation.ParticipantFirstName %> <%= donation.ParticipantLastName %>
                                        </span>
                                    </p>
                                </div>
                                <p class="text-muted mb-0 donation-id">Donation ID: <%= donation.DonationID %></p>
                            </div>
                        </div>
                    </div>
                <% }); %>
            </div>
            <% if (typeof totalDonations !== 'undefined' && totalDonations >= 0) { %>
                <% const startIndex = totalDonations > 0 ? ((currentPage - 1) * pageSize + 1) : 0; %>
                <% const endIndex = totalDonations > 0 ? Math.min(currentPage * pageSize, totalDonations) : 0; %>
                <div class="mt-4 d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
                    <div>
                        <% if (currentPage > 1) { %>
                            <a href="/donations?page=<%= currentPage - 1 %><%= searchValue ? '&search=' + encodeURIComponent(searchValue) : '' %><%= filterQueryString %><%= sortQueryString %>" class="btn btn-secondary donations-pagination-btn">&larr; Previous Page</a>
                        <% } %>
                    </div>
                    <div class="text-muted text-center" style="font-family: 'Montserrat', sans-serif;">
                        Showing <%= startIndex %> - <%= endIndex %> of <%= totalDonations %> donations (Page <%= currentPage %> of <%= totalPages %>)
                    </div>
                    <div class="text-end">
                        <% if (hasNextPage) { %>
                            <a href="/donations?page=<%= currentPage + 1 %><%= searchValue ? '&search=' + encodeURIComponent(searchValue) : '' %><%= filterQueryString %><%= sortQueryString %>" class="btn btn-primary donations-pagination-btn">Next Page &rarr;</a>
                        <% } %>
                    </div>
                </div>
            <% } %>
        <% } else { %>
            <div class="alert alert-info text-center">No donations found.</div>
        <% } %>
    </div>

    <% if (isAdmin) { %>
        <!-- Modern Add Donation Modal -->
        <div class="add-donation-backdrop" id="addDonationBackdrop">
            <div class="add-donation-modal">
                <div class="add-donation-header">
                    <h4>Add Donation</h4>
                    <button type="button" class="add-donation-close" id="addDonationClose">&times;</button>
                </div>
                    <div class="modal-body">
                        <form id="addDonationForm" action="/donations/add" method="POST">
                            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                            <div class="mb-3">
                                <label class="form-label">Participant *</label>
                                <div style="position: relative;">
                                    <input type="text" class="form-control reg-participant-search" id="addDonationParticipantSearch" placeholder="Search participants..." autocomplete="off">
                                    <div class="reg-search-results" id="addDonationParticipantResults"></div>
                                </div>
                                <input type="hidden" id="addDonationParticipantId" name="ParticipantID" required>
                            </div>
                            <div class="mb-3">
                                <label for="addDonationAmount" class="form-label">Amount *</label>
                                <input type="number" step="0.01" min="0.01" class="form-control" id="addDonationAmount" name="DonationAmount" required>
                            </div>
                            <div class="mb-3">
                                <label for="addDonationDate" class="form-label">Donation Date</label>
                                <input type="date" class="form-control" id="addDonationDate" name="DonationDate">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary donations-modal-cancel-btn" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" form="addDonationForm" class="btn btn-primary donations-modal-save-btn">Save Donation</button>
                    </div>
            </div>
        </div>

        <div class="modal fade" id="editDonationModal" tabindex="-1" aria-labelledby="editDonationModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editDonationModalLabel">Edit Donation</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editDonationForm" action="/donations/edit" method="POST">
                            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                            <input type="hidden" name="DonationID" id="editDonationId">
                            <div class="mb-3">
                                <label class="form-label">Participant *</label>
                                <div style="position: relative;">
                                    <input type="text" class="form-control reg-participant-search" id="editDonationParticipantSearch" placeholder="Search participants..." autocomplete="off">
                                    <div class="reg-search-results" id="editDonationParticipantResults"></div>
                                </div>
                                <input type="hidden" id="editDonationParticipantId" name="ParticipantID" required>
                            </div>
                            <div class="mb-3">
                                <label for="editDonationAmount" class="form-label">Amount *</label>
                                <input type="number" step="0.01" min="0.01" class="form-control" id="editDonationAmount" name="DonationAmount" required>
                            </div>
                            <div class="mb-3">
                                <label for="editDonationDate" class="form-label">Donation Date</label>
                                <input type="date" class="form-control" id="editDonationDate" name="DonationDate" >
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary donations-modal-cancel-btn" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" form="editDonationForm" class="btn btn-primary donations-modal-save-btn">Update Donation</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Delete Donation Confirmation Modal -->
        <div class="reg-confirm-backdrop" id="deleteDonationConfirmBackdrop" aria-modal="true" role="dialog">
            <div class="reg-confirm-modal">
                <h4 style="margin: 0;">Confirm Delete</h4>
                <p id="deleteDonationConfirmMessage" style="margin: 0;">Are you sure?</p>
                <div class="reg-confirm-actions">
                    <button type="button" class="btn btn-outline-secondary" id="deleteDonationConfirmNo">Cancel</button>
                    <button type="button" class="btn btn-danger" id="deleteDonationConfirmYes">Delete</button>
                </div>
            </div>
        </div>
    <% } else if (user.ParticipantRole === 'p') { %>
        <div class="modal fade" id="DonateModal" tabindex="-1" aria-labelledby="DonateModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="DonateLabel">Donate</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="DonateForm" action="/donations/add/user" method="POST">
                            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                            <div class="mb-3">
                                <input 
                                    type="hidden"
                                    id="donationParticipantSearch"
                                    name="ParticipantID"
                                    value="<%= user.ParticipantID %>"
                                >
                            </div>
                            <div class="mb-3">
                                <label for="DonateAmount" class="form-label">Amount *</label>
                                <input type="number" step="0.01" min="0.01" class="form-control" id="DonateAmount" name="DonationAmount" required>
                            </div>
                            <div class="mb-3">
                                <input 
                                    type="hidden"
                                    id="addDonationDate"
                                    name="DonationDate"
                                    value="<%= new Date().toISOString().split('T')[0] %>"
                                >
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary donations-modal-cancel-btn" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" form="DonateForm" class="btn btn-primary donations-modal-save-btn">Save Donation</button>
                    </div>
                </div>
            </div>
        </div>
    <% } %>

    <script>
        var form = document.getElementById('DonateForm');

        if (form) {
            form.addEventListener('submit', function(e) {

                // get donation amount
                var amount = document.getElementById('DonateAmount').value;

                // Open new tab
                window.open(`https://givebutter.com/EllaRises?amount=${encodeURIComponent(amount)}`, '_blank');

                // Form will still submit normally to /donations
            });
        }
    </script>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Add Donation Modal - Participant Search
        const addSearchInput = document.getElementById('addDonationParticipantSearch');
        const addSearchResults = document.getElementById('addDonationParticipantResults');
        const addParticipantIdInput = document.getElementById('addDonationParticipantId');
        let addActiveSearchId = null;

        // Edit Donation Modal - Participant Search
        const editSearchInput = document.getElementById('editDonationParticipantSearch');
        const editSearchResults = document.getElementById('editDonationParticipantResults');
        const editParticipantIdInput = document.getElementById('editDonationParticipantId');
        const editIdInput = document.getElementById('editDonationId');
        const editAmountInput = document.getElementById('editDonationAmount');
        const editDateInput = document.getElementById('editDonationDate');
        let editActiveSearchId = null;

        // Participant search functionality (same as registration.ejs)
        function setupParticipantSearch(searchInput, searchResults, participantIdInput, activeSearchIdObj) {
            if (!searchInput || !searchResults || !participantIdInput) return;

            const hideResults = () => {
                if (searchResults) searchResults.style.display = 'none';
            };

            const showResults = () => {
                if (searchResults) searchResults.style.display = 'block';
            };

            searchInput.addEventListener('input', async () => {
                const q = searchInput.value.trim();
                if (activeSearchIdObj) activeSearchIdObj.value = null;
                if (!q || !searchResults) {
                    hideResults();
                    participantIdInput.value = '';
                    return;
                }
                try {
                    const res = await fetch(`/admin/participants/search?q=${encodeURIComponent(q)}`);
                    const data = await res.json();
                    if (!data.success) {
                        hideResults();
                        return;
                    }
                    searchResults.innerHTML = '';
                    data.results.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'result-item';
                        div.textContent = `${item.name} (#${item.participantId}) - ${item.email}`;
                        div.addEventListener('click', () => {
                            searchInput.value = `${item.name} (#${item.participantId})`;
                            if (activeSearchIdObj) activeSearchIdObj.value = item.participantId;
                            participantIdInput.value = item.participantId;
                            hideResults();
                        });
                        searchResults.appendChild(div);
                    });
                    showResults();
                } catch (err) {
                    console.error(err);
                    hideResults();
                }
            });

            // Hide results when clicking outside
            document.addEventListener('click', (e) => {
                if (searchResults && !searchResults.contains(e.target) && e.target !== searchInput) {
                    hideResults();
                }
            });
        }

        // Setup search for add donation modal
        const addActiveSearchIdObj = { value: null };
        setupParticipantSearch(addSearchInput, addSearchResults, addParticipantIdInput, addActiveSearchIdObj);

        // Setup search for edit donation modal
        const editActiveSearchIdObj = { value: null };
        setupParticipantSearch(editSearchInput, editSearchResults, editParticipantIdInput, editActiveSearchIdObj);

        // Edit donation button click handler
        const editDonationModal = document.getElementById('editDonationModal');
        let editModalInstance = null;
        if (editDonationModal && typeof bootstrap !== 'undefined') {
            editModalInstance = new bootstrap.Modal(editDonationModal);
        }

        document.querySelectorAll('.donation-edit-btn').forEach(function(button) {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const donationId = this.getAttribute('data-donation-id') || '';
                const participantId = this.getAttribute('data-participant-id') || '';
                const participantDisplay = this.getAttribute('data-participant-display') || '';
                const amount = this.getAttribute('data-amount') || '';
                const date = this.getAttribute('data-date') || '';

                // Set donation ID
                if (editIdInput) editIdInput.value = donationId;

                // Set participant search value and ID
                if (editSearchInput && participantDisplay) {
                    editSearchInput.value = participantDisplay;
                }
                if (editParticipantIdInput && participantId) {
                    editParticipantIdInput.value = participantId;
                    if (editActiveSearchIdObj) editActiveSearchIdObj.value = participantId;
                }

                // Set amount - ensure it's a number with 2 decimal places
                if (editAmountInput && amount) {
                    const amountNum = parseFloat(amount);
                    if (!isNaN(amountNum)) {
                        editAmountInput.value = amountNum.toFixed(2);
                    } else {
                        editAmountInput.value = amount;
                    }
                }

                // Set date - only if date exists
                if (editDateInput) {
                    if (date) {
                        editDateInput.value = date;
                    } else {
                        editDateInput.value = '';
                    }
                }

                // Open modal after values are set
                if (editModalInstance) {
                    editModalInstance.show();
                } else if (editDonationModal) {
                    // Fallback if Bootstrap is not available
                    editDonationModal.classList.add('show');
                    editDonationModal.style.display = 'block';
                }
            });
        });

        // Delete donation confirmation modal
        const deleteConfirmBackdrop = document.getElementById('deleteDonationConfirmBackdrop');
        const deleteConfirmMessage = document.getElementById('deleteDonationConfirmMessage');
        const deleteConfirmYes = document.getElementById('deleteDonationConfirmYes');
        const deleteConfirmNo = document.getElementById('deleteDonationConfirmNo');
        let pendingDeleteForm = null;

        const openDeleteConfirm = (form, amount) => {
            if (!deleteConfirmBackdrop || !deleteConfirmMessage) {
                // Fallback to console confirm if modal doesn't exist
                if (confirm('Delete ' + (amount || 'this donation') + '?')) {
                    form.submit();
                }
                return;
            }
            pendingDeleteForm = form;
            deleteConfirmMessage.textContent = 'Delete ' + (amount || 'this donation') + '?';
            deleteConfirmBackdrop.classList.add('active');
        };

        if (deleteConfirmYes) {
            deleteConfirmYes.addEventListener('click', function() {
                if (pendingDeleteForm) {
                    pendingDeleteForm.submit();
                }
                if (deleteConfirmBackdrop) {
                    deleteConfirmBackdrop.classList.remove('active');
                }
                pendingDeleteForm = null;
            });
        }

        if (deleteConfirmNo) {
            deleteConfirmNo.addEventListener('click', function() {
                if (deleteConfirmBackdrop) {
                    deleteConfirmBackdrop.classList.remove('active');
                }
                pendingDeleteForm = null;
            });
        }

        if (deleteConfirmBackdrop) {
            deleteConfirmBackdrop.addEventListener('click', (e) => {
                if (e.target === deleteConfirmBackdrop) {
                    deleteConfirmBackdrop.classList.remove('active');
                    pendingDeleteForm = null;
                }
            });
        }

        // Delete donation button click handler
        document.querySelectorAll('.donation-delete-btn').forEach(function(button) {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const donationId = this.getAttribute('data-donation-id');
                const amount = this.getAttribute('data-amount') || 'this donation';
                
                // Create a form to submit
                const form = document.createElement('form');
                form.action = '/donations/delete';
                form.method = 'POST';
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = '_csrf';
                csrfInput.value = '<%= csrfToken %>';
                form.appendChild(csrfInput);
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'DonationID';
                input.value = donationId;
                form.appendChild(input);
                document.body.appendChild(form);
                
                openDeleteConfirm(form, amount);
            });
        });

        // Tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.forEach(function(triggerEl) {
            new bootstrap.Tooltip(triggerEl);
        });

        // Reset and open add donation modal when button is clicked
        const addDonationBtn = document.getElementById('addDonationBtn');
        const addDonationBackdrop = document.getElementById('addDonationBackdrop');
        if (addDonationBtn && addDonationBackdrop) {
            addDonationBtn.addEventListener('click', () => {
                // Reset form
                if (addSearchInput) addSearchInput.value = '';
                if (addParticipantIdInput) addParticipantIdInput.value = '';
                if (addActiveSearchIdObj) addActiveSearchIdObj.value = null;
                if (addSearchResults) addSearchResults.style.display = 'none';
                // Open modal
                addDonationBackdrop.classList.add('active');
            });
        }
    });
    </script>

    <% if (isAdmin) { %>
        <!-- Chart.js Library -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="/js/donations-by-month-chart.js"></script>
    <% } %>

    <style>
    /* Donations KPI Cards */
    .donation-kpi-card {
        border-radius: 16px;
        border: none;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        background: white;
    }

    .donation-kpi-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    }

    .donation-kpi-card .card-body {
        padding: 2rem;
    }

    /* Donations Top Bar */
    .donations-top-bar {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    @media (min-width: 768px) {
        .donations-top-bar {
            flex-direction: row;
            align-items: center;
            gap: 1rem;
        }
    }

    .donations-search-form {
        flex: 1;
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    .donations-search-input-wrapper {
        flex: 1;
        position: relative;
        display: flex;
        align-items: center;
    }

    .donations-search-icon {
        position: absolute;
        left: 1rem;
        color: #5A5E5A;
        z-index: 1;
        pointer-events: none;
    }

    .donations-search-input {
        flex: 1;
        border-radius: 999px;
        padding: 0.6rem 1.3rem 0.6rem 2.75rem;
        height: auto;
        border: 2px solid #E0E0E0;
        font-family: 'Montserrat', sans-serif;
        font-size: 0.95rem;
        transition: all 0.2s ease;
    }

    .donations-search-input:focus {
        outline: none;
        border-color: #978EC4;
        box-shadow: 0 0 0 3px rgba(151, 142, 196, 0.1);
    }

    .donations-clear-btn {
        white-space: nowrap;
    }

    .donations-search-clear-btn {
        border-radius: 999px;
        padding: 0.6rem 1.3rem;
        font-weight: 700;
        font-family: 'Montserrat', sans-serif;
        transition: all 0.2s ease;
        background: white;
        color: #3A3F3B;
        border: 2px solid #E0E0E0;
        text-decoration: none;
    }

    .donations-search-clear-btn:hover {
        background: #F0F0F0;
        color: #3A3F3B;
        border-color: #D0D0D0;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .donations-actions {
        display: flex;
        gap: 0.75rem;
        align-items: center;
    }

    /* Filter and Add Donation Buttons */
    .donations-filter-btn,
    .donations-add-btn {
        border-radius: 999px;
        padding: 0.6rem 1.3rem;
        font-weight: 700;
        font-family: 'Montserrat', sans-serif;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s ease;
        border: none;
    }

    .donations-filter-btn {
        background: #F0F0F0;
        color: #3A3F3B;
        border: 2px solid #E0E0E0;
    }

    .donations-filter-btn:hover {
        background: #E0E0E0;
        color: #3A3F3B;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .donations-add-btn {
        background: #978EC4;
        color: white;
        box-shadow: 0 6px 16px rgba(151, 142, 196, 0.35);
    }

    .donations-add-btn:hover {
        background: #897FB8;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(151, 142, 196, 0.4);
    }

    /* Donation Cards */
    .donation-card {
        border-radius: 16px;
        border: none;
        background: white;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        overflow: hidden;
    }

    .donation-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    }

    .donation-card .card-body {
        padding: 1.5rem;
    }

    .donation-amount-section {
        flex: 1;
    }

    .donation-amount {
        font-family: 'DM Serif Display', serif;
        font-size: 1.75rem;
        color: #3A3F3B;
        font-weight: 600;
        margin: 0;
    }

    .donation-date {
        font-family: 'Montserrat', sans-serif;
        font-size: 0.85rem;
        color: #5A5E5A;
        display: block;
        margin-top: 0.25rem;
    }

    .donation-actions-group {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    .donation-edit-btn,
    .donation-delete-btn {
        border-radius: 8px;
        padding: 0.5rem 0.75rem;
        font-weight: 600;
        font-family: 'Montserrat', sans-serif;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        border: 2px solid;
        min-width: 36px;
        height: 36px;
    }

    .donation-edit-btn {
        background: white;
        color: #978EC4;
        border-color: #978EC4;
    }

    .donation-edit-btn:hover {
        background: #978EC4;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(151, 142, 196, 0.3);
    }

    .donation-delete-btn {
        background: white;
        color: #CE325B;
        border-color: #CE325B;
    }

    .donation-delete-btn:hover {
        background: #CE325B;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(206, 50, 91, 0.3);
    }

    .donation-participant-info {
        flex: 1;
    }

    .donation-participant-label {
        font-family: 'Montserrat', sans-serif;
        font-size: 0.85rem;
        color: #5A5E5A;
        margin: 0;
    }

    .donation-participant-name {
        font-family: 'Montserrat', sans-serif;
        font-size: 1rem;
        color: #3A3F3B;
        font-weight: 600;
        margin: 0;
    }

    .donation-id {
        font-family: 'Montserrat', sans-serif;
        font-size: 0.85rem;
        color: #7A7E7A;
        margin: 0;
    }

    /* Pagination Buttons */
    .donations-pagination-btn {
        border-radius: 999px;
        padding: 0.6rem 1.3rem;
        font-weight: 700;
        font-family: 'Montserrat', sans-serif;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .donations-pagination-btn.btn-secondary {
        background: #F0F0F0;
        color: #3A3F3B;
        border: 2px solid #E0E0E0;
    }

    .donations-pagination-btn.btn-secondary:hover {
        background: #E0E0E0;
        color: #3A3F3B;
        border-color: #D0D0D0;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .donations-pagination-btn.btn-primary {
        background: #978EC4;
        color: white;
        border: 2px solid #978EC4;
        box-shadow: 0 6px 16px rgba(151, 142, 196, 0.35);
    }

    .donations-pagination-btn.btn-primary:hover {
        background: #897FB8;
        border-color: #897FB8;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(151, 142, 196, 0.4);
    }

    /* User Donate Button - Green like status-pill--good */
    .donations-user-donate-btn {
        border-radius: 999px;
        padding: 0.6rem 1.3rem;
        font-weight: 700;
        font-family: 'Montserrat', sans-serif;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        background: #9AB59D;
        color: white;
        border: 2px solid #9AB59D;
        box-shadow: 0 6px 16px rgba(154, 181, 157, 0.35);
    }

    .donations-user-donate-btn:hover {
        background: #7fa082;
        border-color: #7fa082;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(154, 181, 157, 0.4);
    }

    /* Modal Buttons */
    .donations-modal-cancel-btn,
    .donations-modal-save-btn {
        border-radius: 999px;
        padding: 0.6rem 1.3rem;
        font-weight: 700;
        font-family: 'Montserrat', sans-serif;
        transition: all 0.2s ease;
    }

    .donations-modal-cancel-btn {
        background: white;
        color: #3A3F3B;
        border: 2px solid #E0E0E0;
    }

    .donations-modal-cancel-btn:hover {
        background: #F0F0F0;
        color: #3A3F3B;
        border-color: #D0D0D0;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .donations-modal-save-btn {
        background: #978EC4;
        color: white;
        border: 2px solid #978EC4;
        box-shadow: 0 6px 16px rgba(151, 142, 196, 0.35);
    }

    .donations-modal-save-btn:hover {
        background: #897FB8;
        border-color: #897FB8;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(151, 142, 196, 0.4);
    }

    /* Participant Search (same as registration.ejs) */
    .reg-participant-search {
        min-width: 220px;
    }

    .reg-search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #E6E0D4;
        border-radius: 8px;
        box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        z-index: 10;
        display: none;
        max-height: 220px;
        overflow-y: auto;
    }

    .reg-search-results .result-item {
        padding: 0.5rem 0.75rem;
        cursor: pointer;
    }

    .reg-search-results .result-item:hover {
        background: #F0F0F0;
    }

    /* Delete Confirmation Modal (same as registration.ejs) */
    .reg-confirm-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.3);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2000;
    }

    .reg-confirm-backdrop.active {
        display: flex;
    }

    .reg-confirm-modal {
        background: white;
        border-radius: 12px;
        padding: 1.2rem 1.4rem;
        box-shadow: 0 16px 40px rgba(0,0,0,0.18);
        max-width: 420px;
        width: 90%;
        display: flex;
        flex-direction: column;
        gap: 0.9rem;
    }

    .reg-confirm-actions {
        display: flex;
        justify-content: flex-end;
        gap: 0.6rem;
    }


    /* Modern Add Donation Modal */
    .add-donation-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.3);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2000;
    }

    .add-donation-backdrop.active {
        display: flex;
    }

    .add-donation-modal {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 16px 40px rgba(0,0,0,0.18);
        max-width: 600px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
    }

    .add-donation-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #F0F0F0;
    }

    .add-donation-header h4 {
        margin: 0;
        font-family: 'DM Serif Display', serif;
        font-size: 1.5rem;
        color: #3A3F3B;
    }

    .add-donation-close {
        background: transparent;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #4B4F4B;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        transition: background 0.2s;
    }

    .add-donation-close:hover {
        background: #F0F0F0;
    }

    .add-donation-form-group {
        margin-bottom: 1.5rem;
    }

    .add-donation-form-group label {
        display: block;
        font-weight: 600;
        color: #3A3F3B;
        margin-bottom: 0.5rem;
        font-size: 0.95rem;
    }

    .add-donation-form-group input,
    .add-donation-form-group select {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 2px solid #E0E0E0;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.2s;
    }

    .add-donation-form-group input:focus,
    .add-donation-form-group select:focus {
        outline: none;
        border-color: #978EC4;
    }


    .add-donation-actions {
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 2px solid #F0F0F0;
    }

    /* Donations Filter Section */
    .donations-filter-section {
        padding: 1.5rem;
    }

    .donations-filter-title {
        font-family: 'DM Serif Display', serif;
        font-size: 1.5rem;
        color: #3A3F3B;
        margin: 0;
    }

    .donations-filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 2rem;
        margin-bottom: 2rem;
    }

    @media (min-width: 992px) {
        .donations-filter-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    .donations-filter-group {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .donations-filter-group-label {
        font-family: 'Montserrat', sans-serif;
        font-weight: 600;
        font-size: 0.95rem;
        color: #3A3F3B;
        margin: 0;
    }

    .donations-range-controls {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .donations-range-with-inputs {
        display: grid;
        grid-template-columns: auto 1fr auto;
        column-gap: 0.75rem;
        align-items: center;
    }

    .donations-range-input-group-min,
    .donations-range-input-group-max {
        min-width: 60px;
        max-width: 70px;
    }

    .donations-range-input-group-min .donations-range-input,
    .donations-range-input-group-max .donations-range-input {
        padding-inline: 0.4rem;
        padding-block: 0.4rem;
        text-align: center;
        font-size: 0.9rem;
    }

    .donations-range-input-group-min .donations-range-label,
    .donations-range-input-group-max .donations-range-label {
        font-size: 0.8rem;
        margin-bottom: 0.25rem;
    }

    .donations-range-slider-group {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .donations-range-slider-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }

    .donations-range-slider-item {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    /* Dual-handle range slider */
    .donations-dual-range-wrapper {
        position: relative;
        width: 100%;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .donations-dual-range {
        position: absolute;
        width: 100%;
        height: 8px;
        -webkit-appearance: none;
        appearance: none;
        background: transparent;
        outline: none;
        pointer-events: none;
    }

    .donations-dual-range::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #978EC4;
        cursor: pointer;
        pointer-events: all;
        position: relative;
        z-index: 2;
        transition: background 0.2s, transform 0.2s;
    }

    .donations-dual-range::-webkit-slider-thumb:hover {
        background: #7A6FA3;
        transform: scale(1.1);
    }

    .donations-dual-range::-moz-range-thumb {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #978EC4;
        cursor: pointer;
        border: none;
        pointer-events: all;
        position: relative;
        z-index: 2;
        transition: background 0.2s, transform 0.2s;
    }

    .donations-dual-range::-moz-range-thumb:hover {
        background: #7A6FA3;
        transform: scale(1.1);
    }

    .donations-dual-range-wrapper::before {
        content: '';
        position: absolute;
        left: 0;
        right: 0;
        height: 8px;
        background: #E0E0E0;
        border-radius: 4px;
        z-index: 0;
    }

    .donations-dual-range-min {
        z-index: 1;
    }

    .donations-dual-range-max {
        z-index: 1;
    }

    /* Active track between handles */
    .donations-dual-range-wrapper::after {
        content: '';
        position: absolute;
        height: 8px;
        background: #978EC4;
        border-radius: 4px;
        z-index: 1;
        left: var(--track-left, 0%);
        right: var(--track-right, 0%);
        pointer-events: none;
    }

    .donations-range-input-group {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        flex: 1;
    }

    .donations-range-label {
        font-family: 'Montserrat', sans-serif;
        font-size: 0.85rem;
        font-weight: 600;
        color: #4B4F4B;
    }

    .donations-range-input {
        padding: 0.5rem 0.75rem;
        border: 2px solid #E0E0E0;
        border-radius: 8px;
        font-size: 0.95rem;
        transition: border-color 0.2s;
    }

    .donations-range-input:focus {
        outline: none;
        border-color: #978EC4;
    }

    .donations-filter-actions {
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
        padding-top: 1.5rem;
        border-top: 2px solid #E0E0E0;
    }

    .donations-filter-reset-btn,
    .donations-filter-apply-btn {
        border-radius: 999px;
        padding: 0.6rem 1.3rem;
        font-weight: 700;
        font-family: 'Montserrat', sans-serif;
        transition: all 0.2s ease;
    }

    .donations-filter-reset-btn {
        background: white;
        color: #3A3F3B;
        border: 2px solid #E0E0E0;
    }

    .donations-filter-reset-btn:hover {
        background: #F0F0F0;
        color: #3A3F3B;
        border-color: #D0D0D0;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .donations-filter-apply-btn {
        background: #978EC4;
        color: white;
        border: 2px solid #978EC4;
        box-shadow: 0 6px 16px rgba(151, 142, 196, 0.35);
    }

    .donations-filter-apply-btn:hover {
        background: #897FB8;
        border-color: #897FB8;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(151, 142, 196, 0.4);
    }

    @media (max-width: 767px) {
        .donations-filter-section {
            padding: 1rem;
        }

        .donations-filter-grid {
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }
    }
    </style>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Dual-handle range slider functionality
        function setupDualRangeSlider(wrapper, minSliderId, maxSliderId, minInputId, maxInputId, minVal, maxVal, step) {
            // Handle both selector string and element
            if (typeof wrapper === 'string') {
                wrapper = document.querySelector(wrapper);
            }
            
            const minSlider = document.getElementById(minSliderId);
            const maxSlider = document.getElementById(maxSliderId);
            const minInput = document.getElementById(minInputId);
            const maxInput = document.getElementById(maxInputId);

            if (!wrapper || !minSlider || !maxSlider || !minInput || !maxInput) return;

            // Initialize with current values or defaults (full range)
            let currentMin = minInput.value ? parseFloat(minInput.value) : minVal;
            let currentMax = maxInput.value ? parseFloat(maxInput.value) : maxVal;
            
            // If no values set, use full range
            if (!minInput.value && !maxInput.value) {
                currentMin = minVal;
                currentMax = maxVal;
                // Optionally set placeholder values in inputs to show the range
                minInput.placeholder = minVal.toString();
                maxInput.placeholder = maxVal.toString();
            }
            
            minSlider.value = Math.max(minVal, Math.min(currentMin, maxVal));
            maxSlider.value = Math.max(minVal, Math.min(currentMax, maxVal));
            
            // Only set input values if they were provided (don't override empty state)
            if (minInput.value) {
                minInput.value = parseFloat(minSlider.value).toFixed(step < 1 ? 2 : 0);
            }
            if (maxInput.value) {
                maxInput.value = parseFloat(maxSlider.value).toFixed(step < 1 ? 2 : 0);
            }

            // Update active track between handles
            function updateActiveTrack() {
                const min = parseFloat(minSlider.value);
                const max = parseFloat(maxSlider.value);
                const minPercent = ((min - minVal) / (maxVal - minVal)) * 100;
                const maxPercent = ((max - minVal) / (maxVal - minVal)) * 100;
                
                wrapper.style.setProperty('--track-left', minPercent + '%');
                wrapper.style.setProperty('--track-right', (100 - maxPercent) + '%');
            }

            // Update min value
            function updateMin() {
                const min = parseFloat(minSlider.value);
                const max = parseFloat(maxSlider.value);
                
                if (min > max) {
                    minSlider.value = max;
                    minInput.value = max.toFixed(step < 1 ? 2 : 0);
                } else {
                    // Always update input when slider moves (even if it was empty)
                    minInput.value = min.toFixed(step < 1 ? 2 : 0);
                }
                updateActiveTrack();
            }

            // Update max value
            function updateMax() {
                const min = parseFloat(minSlider.value);
                const max = parseFloat(maxSlider.value);
                
                if (max < min) {
                    maxSlider.value = min;
                    maxInput.value = min.toFixed(step < 1 ? 2 : 0);
                } else {
                    // Always update input when slider moves (even if it was empty)
                    maxInput.value = max.toFixed(step < 1 ? 2 : 0);
                }
                updateActiveTrack();
            }

            // Sync from input to slider
            function syncFromInput(input, slider, otherSlider, isMin) {
                const raw = (input.value || '').trim().toLowerCase();
                let value;

                // Allow the user to type "min" / "max"
                if (raw === 'min') {
                    value = minVal;
                } else if (raw === 'max') {
                    value = maxVal;
                } else if (raw === '') {
                    // Empty means full range on that side
                    value = isMin ? minVal : maxVal;
                } else {
                    value = parseFloat(raw);
                    if (isNaN(value)) {
                        // Invalid input – don’t change the slider
                        return;
                    }
                }

                // Clamp to slider range
                value = Math.max(minVal, Math.min(value, maxVal));

                const otherValue = parseFloat(isMin ? maxSlider.value : minSlider.value);

                // Enforce min <= max
                if (isMin && value > otherValue) {
                    value = otherValue;
                } else if (!isMin && value < otherValue) {
                    value = otherValue;
                }

                slider.value = value;

                // Normalize what's actually stored/submitted:
                // convert "min"/"max" to the numeric value so the backend gets a number.
                const displayValue = value.toFixed(step < 1 ? 2 : 0);
                input.value = displayValue;

                if (isMin) {
                    updateMin();
                } else {
                    updateMax();
                }
            }


            // Event listeners
            minSlider.addEventListener('input', updateMin);
            maxSlider.addEventListener('input', updateMax);
            minInput.addEventListener('input', () => syncFromInput(minInput, minSlider, maxSlider, true));
            maxInput.addEventListener('input', () => syncFromInput(maxInput, maxSlider, minSlider, false));
            minInput.addEventListener('blur', () => {
                if (!minInput.value) {
                    minInput.value = minVal.toFixed(step < 1 ? 2 : 0);
                    minSlider.value = minVal;
                    updateMin();
                }
            });
            maxInput.addEventListener('blur', () => {
                if (!maxInput.value) {
                    maxInput.value = maxVal.toFixed(step < 1 ? 2 : 0);
                    maxSlider.value = maxVal;
                    updateMax();
                }
            });

            // Initialize active track
            updateActiveTrack();
        }

        // Setup dual-handle range sliders
        // Amount range
        const amountWrapper = document.querySelector('#amountMinSlider')?.closest('.donations-dual-range-wrapper');
        if (amountWrapper) {
            setupDualRangeSlider(amountWrapper, 'amountMinSlider', 'amountMaxSlider', 'filterMinAmount', 'filterMaxAmount', 0, 10000, 0.01);
        }
        
        // City/State filter search selectors
        const citySearchInput = document.getElementById('donationsFilterCitySearch');
        const citySearchResults = document.getElementById('donationsFilterCityResults');
        const cityInput = document.getElementById('donationsFilterCityInput');
        const stateSearchInput = document.getElementById('donationsFilterStateSearch');
        const stateSearchResults = document.getElementById('donationsFilterStateResults');
        const stateInput = document.getElementById('donationsFilterStateInput');

        function setupFilterSearch(searchInput, searchResults, hiddenInput, options, showAllOnFocus = false) {
            if (!searchInput || !searchResults || !hiddenInput) return;

            const hideResults = () => {
                if (searchResults) searchResults.style.display = 'none';
            };

            const showResults = () => {
                if (searchResults) searchResults.style.display = 'block';
            };

            const filterAndDisplay = (q = '') => {
                const searchTerm = q.toLowerCase().trim();
                const filtered = options.filter(opt => 
                    opt.toLowerCase().includes(searchTerm)
                );
                
                searchResults.innerHTML = '';
                if (filtered.length === 0 && searchTerm) {
                    hideResults();
                    return;
                }
                
                filtered.forEach(opt => {
                    const div = document.createElement('div');
                    div.className = 'result-item';
                    div.textContent = opt;
                    div.addEventListener('click', () => {
                        searchInput.value = opt;
                        hiddenInput.value = opt;
                        hideResults();
                    });
                    searchResults.appendChild(div);
                });
                showResults();
            };

            searchInput.addEventListener('input', () => {
                const q = searchInput.value.trim();
                filterAndDisplay(q);
            });

            if (showAllOnFocus) {
                searchInput.addEventListener('focus', () => {
                    filterAndDisplay(searchInput.value.trim());
                });
            }

            document.addEventListener('click', (e) => {
                if (searchResults && !searchResults.contains(e.target) && e.target !== searchInput) {
                    hideResults();
                }
            });
        }

        const uniqueCities = <%- JSON.stringify(uniqueCities || []) %>;
        const uniqueStates = <%- JSON.stringify(uniqueStates || []) %>;
        
        if (citySearchInput && citySearchResults && cityInput) {
            setupFilterSearch(citySearchInput, citySearchResults, cityInput, uniqueCities);
        }
        if (stateSearchInput && stateSearchResults && stateInput) {
            setupFilterSearch(stateSearchInput, stateSearchResults, stateInput, uniqueStates);
        }
        
        // Age range
        const ageWrapper = document.querySelector('#ageMinSlider')?.closest('.donations-dual-range-wrapper');
        if (ageWrapper) {
            setupDualRangeSlider(ageWrapper, 'ageMinSlider', 'ageMaxSlider', 'filterMinAge', 'filterMaxAge', 0, 100, 1);
        }

        // Date range validation
        const startDateInput = document.getElementById('filterStartDate');
        const endDateInput = document.getElementById('filterEndDate');
        
        if (startDateInput && endDateInput) {
            function validateDateRange() {
                const startDate = startDateInput.value;
                const endDate = endDateInput.value;
                
                if (startDate && endDate && startDate > endDate) {
                    endDateInput.setCustomValidity('End date must be after start date');
                    endDateInput.reportValidity();
                } else {
                    endDateInput.setCustomValidity('');
                }
            }
            
            startDateInput.addEventListener('change', validateDateRange);
            endDateInput.addEventListener('change', validateDateRange);
        }

        // Icon-based filter pills for Role
        const rolePills = document.querySelectorAll('.donation-role-pill');
        const roleInput = document.getElementById('filterRoleInput');
        
        rolePills.forEach(pill => {
            pill.addEventListener('click', function() {
                rolePills.forEach(p => p.classList.remove('filter-selected'));
                this.classList.add('filter-selected');
                const value = this.getAttribute('data-role-value');
                if (roleInput) roleInput.value = value || '';
            });
        });

        // Icon-based filter pills for Interest
        const interestPills = document.querySelectorAll('.donation-interest-pill');
        const interestInput = document.getElementById('filterInterestInput');
        
        interestPills.forEach(pill => {
            pill.addEventListener('click', function() {
                interestPills.forEach(p => p.classList.remove('filter-selected'));
                this.classList.add('filter-selected');
                const value = this.getAttribute('data-interest-value');
                if (interestInput) interestInput.value = value || '';
            });
        });

        // Add Donation Modal - open/close handlers
        const addDonationBtn = document.getElementById('addDonationBtn');
        const addDonationBackdrop = document.getElementById('addDonationBackdrop');
        const addDonationClose = document.getElementById('addDonationClose');
        const addDonationCancel = document.getElementById('addDonationCancel');

        const closeAddDonationModal = () => {
            if (addDonationBackdrop) {
                addDonationBackdrop.classList.remove('active');
            }
        };

        if (addDonationClose) {
            addDonationClose.addEventListener('click', closeAddDonationModal);
        }
        if (addDonationCancel) {
            addDonationCancel.addEventListener('click', closeAddDonationModal);
        }
        if (addDonationBackdrop) {
            addDonationBackdrop.addEventListener('click', (e) => {
                if (e.target === addDonationBackdrop) {
                    closeAddDonationModal();
                }
            });
        }
    });
    </script>
    
<% } %>
