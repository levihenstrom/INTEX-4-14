<% pageTitle = 'Donations'; %>
<% if (!user) { %>
<!-- Visitor Donation Page -->
<div class="donate-page">
    <!-- Cover Image -->
    <div class="donate-cover-image">
        <img src="/images/ella_donate.jpg" alt="Ella Rises Campaign" class="donate-cover-img">
    </div>

    <!-- Title Section -->
    <div class="donate-header-card">
        <div class="donate-header-card-body">
            <h1 class="donate-main-title">Rise With Ella: Empowering Futures Together</h1>
            <p class="donate-main-subtitle">We believe in the power of community and the brilliance of our youth.</p>
        </div>
    </div>

    <!-- Two Cards Layout -->
    <div class="row justify-content-center g-3">
        <!-- First Card: Information Card -->
        <div class="col-12 col-lg-7">
            <div class="donate-info-card">
                <div class="donate-info-card-body">
                    <div class="donate-section">
                        <h3 class="donate-section-title">Why We're Fundraising</h3>
                        <p class="donate-section-text">Your generous contribution will impact these programs and experiences:</p>
                        <ul class="donate-programs">
                            <li><strong>Ella Rises Youth Summits:</strong> Day camps focused on the Ella Rises Experience* across the state of Utah.</li>
                            <li><strong>Educational tours:</strong> Visits to local universities, colleges, and businesses.</li>
                            <li><strong>STEM, education, and arts programs:</strong> Including the Ella Rises Mariachi band and Ballet Folklorico.</li>
                        </ul>
                        <p class="donate-note"><em>*The Ella Rises Experience is a joyful blend of art, STEM, and educational exploration — designed to build confidence in each girl's divine worth and purpose.</em></p>
                    </div>

                    <div class="donate-section">
                        <h3 class="donate-section-title">Here's How You Can Help Today</h3>
                        <ul class="donate-help-list">
                            <li><strong>Donate</strong> — Make a one-time or monthly gift.</li>
                            <li><strong>Share</strong> — Post our campaign on your social platforms.</li>
                            <li><strong>Join</strong> — Become a mentor, volunteer, or community partner.</li>
                        </ul>
                        <p class="donate-closing">With your support, <strong>Ella Rises.</strong></p>
                        <p class="donate-signature">With gratitude,<br><em>Nadia Cates, Founder of Ella Rises</em></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Second Card: Donation Form Card -->
        <div class="col-12 col-lg-5">
            <div class="donate-form-card">
                <div class="donate-form-card-body">
                    <% if (typeof error !== 'undefined' && error) { %>
                        <div class="donate-alert"><%= error %></div>
                    <% } %>
                    <% if (typeof success !== 'undefined' && success) { %>
                        <div class="donate-success"><%= success %></div>
                    <% } %>

                    <form id="VisitorDonateForm" action="/donations/add/visitor" method="POST" class="donate-form">
                        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                        <h3 class="donate-form-title">Make a Donation</h3>
                        
                        <div class="donate-amount-section">
                            <label class="donate-label">Donation Amount</label>
                            <div class="donate-quick-amounts">
                                <button type="button" class="donate-quick-btn" data-amount="25">$25</button>
                                <button type="button" class="donate-quick-btn" data-amount="50">$50</button>
                                <button type="button" class="donate-quick-btn" data-amount="100">$100</button>
                                <button type="button" class="donate-quick-btn" data-amount="250">$250</button>
                            </div>
                            <div class="donate-amount-input-group">
                                <span class="donate-currency">$</span>
                                <input type="number" step="0.01" min="0.01" class="donate-amount-input" id="VisitorDonateAmount" name="DonationAmount" placeholder="0.00" required>
                            </div>
                        </div>

                        <div class="donate-form-group">
                            <label for="FirstName" class="donate-label">First Name *</label>
                            <input type="text" class="donate-input" id="FirstName" name="FirstName" required>
                        </div>
                        <div class="donate-form-group">
                            <label for="LastName" class="donate-label">Last Name *</label>
                            <input type="text" class="donate-input" id="LastName" name="LastName" required>
                        </div>
                        <div class="donate-form-group">
                            <label for="Email" class="donate-label">Email *</label>
                            <input type="email" class="donate-input" id="Email" name="Email" required>
                        </div>
                        
                        <input type="hidden" id="addDonationDate" name="DonationDate" value="<%= new Date().toISOString().split('T')[0] %>">
                        
                        <div class="donate-button-group">
                            <button type="submit" class="donate-btn-primary">Donate Now</button>
                        </div>
                        
                        <p class="donate-footer-note">By donating, you'll be redirected to our secure payment processor to complete your contribution.</p>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* ====================================================== */
/*                    DONATE PAGE STYLING                */
/* ====================================================== */

.donate-page {
    padding: 0 0 2rem 0;
    max-width: 1200px;
    margin: 0 auto;
}

/* Cover Image */
.donate-cover-image {
    width: 100%;
    height: 300px;
    overflow: hidden;
    margin-bottom: 2rem;
    border-radius: 12px;
}

.donate-cover-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
}

/* Header Card Section */
.donate-header-card {
    background: linear-gradient(135deg, #9AB59D 0%, #7fa082 100%);
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(154, 181, 157, 0.25);
    margin-bottom: 1.5rem;
    overflow: hidden;
    animation: fadeInScale 0.6s ease both;
}

.donate-header-card-body {
    text-align: center;
    padding: 1.5rem 2rem;
}

.donate-main-title {
    font-family: 'DM Serif Display', serif;
    font-size: 1.75rem;
    color: #FFFFFF;
    margin-bottom: 0.5rem;
    line-height: 1.2;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.donate-main-subtitle {
    font-family: 'Montserrat', sans-serif;
    font-size: 0.95rem;
    color: #FFFFFF;
    margin-bottom: 0;
    line-height: 1.5;
    opacity: 0.95;
}

/* Information Card */
.donate-info-card {
    background: #FFFFFF;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(58, 63, 59, 0.08);
    overflow: hidden;
    animation: fadeInScale 0.6s ease both;
    height: 100%;
}

.donate-info-card-body {
    padding: 1.5rem;
}

/* Form Card */
.donate-form-card {
    background: #FFFFFF;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(58, 63, 59, 0.08);
    overflow: hidden;
    animation: fadeInScale 0.6s ease 0.2s both;
    height: fit-content;
}

.donate-form-card-body {
    padding: 1.25rem;
}

.donate-section {
    margin-bottom: 1.5rem;
}

.donate-section:last-child {
    margin-bottom: 0;
}

.donate-section-title {
    font-family: 'DM Serif Display', serif;
    font-size: 1.4rem;
    color: #3A3F3B;
    margin-bottom: 0.75rem;
    font-weight: 600;
}

.donate-section-text {
    font-family: 'Montserrat', sans-serif;
    font-size: 1rem;
    color: #5A5E5A;
    margin-bottom: 0.75rem;
    line-height: 1.6;
}

.donate-programs {
    font-family: 'Montserrat', sans-serif;
    font-size: 0.95rem;
    color: #3A3F3B;
    margin-left: 1.25rem;
    margin-bottom: 0.75rem;
    line-height: 1.7;
    list-style: disc;
}

.donate-programs li {
    margin-bottom: 0.65rem;
}

.donate-help-list {
    font-family: 'Montserrat', sans-serif;
    font-size: 0.85rem;
    color: #3A3F3B;
    margin-left: 1.25rem;
    margin-bottom: 1rem;
    line-height: 1.6;
    list-style: disc;
}

.donate-help-list li {
    margin-bottom: 0.5rem;
}

.donate-note {
    font-family: 'Montserrat', sans-serif;
    font-size: 0.9rem;
    color: #7A7E7A;
    font-style: italic;
    margin-top: 0.75rem;
    padding-top: 0.75rem;
    border-top: 1px solid #E5E5E5;
    line-height: 1.6;
}

.donate-closing {
    font-family: 'Montserrat', sans-serif;
    font-size: 0.9rem;
    color: #3A3F3B;
    margin-bottom: 1rem;
    line-height: 1.5;
}

.donate-signature {
    font-family: 'Montserrat', sans-serif;
    font-size: 0.85rem;
    color: #5A5E5A;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #E5E5E5;
    line-height: 1.5;
}

.donate-alert {
    background: #FFD8D1;
    color: #9AB59D;
    padding: 1rem 1.25rem;
    border-radius: 12px;
    margin-bottom: 1.5rem;
    font-family: 'Montserrat', sans-serif;
    font-size: 0.95rem;
    border-left: 4px solid #9AB59D;
}

.donate-success {
    background: #9AB59D;
    color: #FFFFFF;
    padding: 1rem 1.25rem;
    border-radius: 12px;
    margin-bottom: 1.5rem;
    font-family: 'Montserrat', sans-serif;
    font-size: 0.95rem;
}

.donate-form {
    background: transparent;
    border: none;
    padding: 0;
}

.donate-form-title {
    font-family: 'DM Serif Display', serif;
    font-size: 1.35rem;
    color: #3A3F3B;
    margin-bottom: 1rem;
}

.donate-amount-section {
    margin-bottom: 1.25rem;
}

.donate-quick-amounts {
    display: flex;
    gap: 0.75rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
}

.donate-quick-btn {
    flex: 1;
    min-width: 80px;
    padding: 0.75rem 1rem;
    background: #FFFFFF;
    border: 2px solid #9AB59D;
    border-radius: 12px;
    color: #9AB59D;
    font-family: 'Montserrat', sans-serif;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.donate-quick-btn:hover,
.donate-quick-btn.active {
    background: #9AB59D;
    color: #FFFFFF;
    transform: translateY(-2px);
}

.donate-amount-input-group {
    display: flex;
    align-items: center;
    border: 2px solid #E5E5E5;
    border-radius: 12px;
    padding: 0.875rem 1.25rem;
    transition: all 0.3s ease;
}

.donate-amount-input-group:focus-within {
    border-color: #9AB59D;
    box-shadow: 0 0 0 3px rgba(154, 181, 157, 0.1);
}

.donate-currency {
    font-family: 'Montserrat', sans-serif;
    font-weight: 600;
    font-size: 1.2rem;
    color: #3A3F3B;
    margin-right: 0.5rem;
}

.donate-amount-input {
    flex: 1;
    border: none;
    outline: none;
    font-family: 'Montserrat', sans-serif;
    font-size: 1.5rem;
    font-weight: 600;
    color: #3A3F3B;
    background: transparent;
}

.donate-amount-input::placeholder {
    color: #9A9A9A;
    font-weight: 400;
}

.donate-form-group {
    margin-bottom: 1rem;
}

.donate-label {
    display: block;
    font-family: 'Montserrat', sans-serif;
    font-weight: 600;
    font-size: 0.95rem;
    color: #3A3F3B;
    margin-bottom: 0.5rem;
}

.donate-input {
    width: 100%;
    padding: 0.875rem 1.25rem;
    border: 2px solid #E5E5E5;
    border-radius: 12px;
    font-family: 'Montserrat', sans-serif;
    font-size: 1rem;
    color: #3A3F3B;
    background: #FFFFFF;
    transition: all 0.3s ease;
    box-sizing: border-box;
}

.donate-input:focus {
    outline: none;
    border-color: #9AB59D;
    box-shadow: 0 0 0 3px rgba(154, 181, 157, 0.1);
}

.donate-button-group {
    margin-top: 2rem;
}

.donate-btn-primary {
    width: 100%;
    padding: 0.875rem 1.5rem;
    background: #9AB59D;
    color: #FFFFFF;
    border: none;
    border-radius: 12px;
    font-family: 'Montserrat', sans-serif;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 8px 25px rgba(154, 181, 157, 0.3);
}

.donate-btn-primary:hover {
    background: #7fa082;
    transform: translateY(-2px);
    box-shadow: 0 12px 35px rgba(154, 181, 157, 0.4);
}

.donate-footer-note {
    font-family: 'Montserrat', sans-serif;
    font-size: 0.8rem;
    color: #7A7E7A;
    text-align: center;
    margin-top: 1rem;
    line-height: 1.4;
}

/* Responsive */
@media (max-width: 991.98px) {
    .donate-cover-image {
        height: 250px;
        margin-bottom: 1.5rem;
    }

    .donate-header-card-body {
        padding: 1.25rem 1.5rem;
    }

    .donate-main-title {
        font-size: 1.5rem;
    }

    .donate-main-subtitle {
        font-size: 0.9rem;
    }

    .donate-section-title {
        font-size: 1.3rem;
    }

    .donate-info-card-body,
    .donate-form-card-body {
        padding: 1.25rem;
    }

    .donate-section-title {
        font-size: 1.15rem;
    }
}

@media (max-width: 575.98px) {
    .donate-cover-image {
        height: 200px;
        border-radius: 8px;
        margin-bottom: 1rem;
    }

    .donate-header-card-body {
        padding: 1rem 1.25rem;
    }

    .donate-main-title {
        font-size: 1.35rem;
    }

    .donate-main-subtitle {
        font-size: 0.85rem;
    }

    .donate-section-title {
        font-size: 1.2rem;
    }

    .donate-section-text {
        font-size: 0.95rem;
    }

    .donate-programs {
        font-size: 0.9rem;
    }

    .donate-info-card-body,
    .donate-form-card-body {
        padding: 1rem;
    }
    
    .donate-section-title {
        font-size: 1.1rem;
    }

    .donate-section-text,
    .donate-programs,
    .donate-help-list {
        font-size: 0.8rem;
    }
    
    .donate-image-side {
        min-height: 200px;
        max-height: 250px;
    }

    .donate-quick-btn {
        min-width: 100px;
    }
}
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('VisitorDonateForm');
        const amountInput = document.getElementById('VisitorDonateAmount');
        const quickAmountBtns = document.querySelectorAll('.donate-quick-btn');

        // Quick amount buttons
        quickAmountBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const amount = this.getAttribute('data-amount');
                amountInput.value = amount;
                
                // Update active state
                quickAmountBtns.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
            });
        });

        form.addEventListener('submit', function(e) {
            const amount = amountInput.value;
            if (amount && parseFloat(amount) > 0) {
                // Open Givebutter in new tab
                window.open(`https://givebutter.com/EllaRises?amount=${encodeURIComponent(amount)}`, '_blank');
                // Form will still submit normally to /donations
            }
        });
    });
</script>
<% } else { %>
    <% const participantChoices = Array.isArray(participantOptions) ? participantOptions : []; %>
    <% const filterValues = filters || {}; %>
    <%
    const filterPairs = [];
    function pushFilterPair(key) {
        if (filterValues[key]) {
            filterPairs.push({ key: key, value: filterValues[key] });
        }
    }
    pushFilterPair('filterParticipantID');
    pushFilterPair('filterDonationID');
    pushFilterPair('filterStartDate');
    pushFilterPair('filterEndDate');
    pushFilterPair('filterTitle');
    pushFilterPair('filterCategory');
    pushFilterPair('filterMinAge');
    pushFilterPair('filterMaxAge');
    pushFilterPair('filterCity');
    pushFilterPair('filterState');
    pushFilterPair('filterRole');
    pushFilterPair('filterInterest');
    const filterQueryString = filterPairs.length ? '&' + filterPairs.map(function(pair) {
        return pair.key + '=' + encodeURIComponent(pair.value);
    }).join('&') : '';
    const sortQueryString = (typeof sortColumn !== 'undefined' ? '&sort=' + encodeURIComponent(sortColumn) : '') + (typeof sortDir !== 'undefined' ? '&sortDir=' + encodeURIComponent(sortDir) : '');
%>
    
    <%
        function formatCurrency(value) {
            if (typeof value !== 'number' || Number.isNaN(value)) {
                return '$0.00';
            }
            return value.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
        }
    %>
    <% const searchValue = typeof searchTerm !== 'undefined' ? searchTerm : ''; %>
    <% const metricsData = metrics || {}; %>
    <% const totalAmountValue = typeof metricsData.totalAmount === 'number' ? metricsData.totalAmount : 0; %>
    <% const monthAmountValue = typeof metricsData.monthAmount === 'number' ? metricsData.monthAmount : 0; %>
    <% const donationCountValue = typeof metricsData.count === 'number' ? metricsData.count : 0; %>

    <div class="milestones-page">
        <div class="row g-3 mb-4">
                <h1 class="mb-1">Donations</h1>
                <p class="text-muted mb-0">Track generosity and giving impact.</p>
                <% if(!isAdmin) { %>
                    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#DonateModal">Donate</button>
                <% } %>
        </div>

        <!-- Donations Chart -->
        <% if (isAdmin) { %>
            <div class="row mb-4">
                <div class="col-12">
                    <div style="position: relative; height: 300px; width: 100%;">
                        <canvas id="donationsByMonthChart"
                            data-search="<%= searchValue || '' %>"
                            data-filter-start-date="<%= filterValues.filterStartDate || '' %>"
                            data-filter-end-date="<%= filterValues.filterEndDate || '' %>"
                            data-filter-min-amount="<%= filterValues.filterMinAmount || '' %>"
                            data-filter-max-amount="<%= filterValues.filterMaxAmount || '' %>">
                        </canvas>
                    </div>
                    <p class="text-muted text-center mt-2 mb-0" style="font-size: 0.85rem;">
                        Click a point to filter donations for that month. Click empty space to clear filters.
                    </p>
                </div>
            </div>
        <% } %>

        <div class="row g-3 mb-4">
            <div class="col-md-4">
                <div class="card text-center shadow-sm h-100">
                    <div class="card-body">
                        <p class="text-muted mb-1">Total Donation Amount</p>
                        <h3 class="mb-0"><%= formatCurrency(totalAmountValue) %></h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center shadow-sm h-100">
                    <div class="card-body">
                        <p class="text-muted mb-1">Donations This Month</p>
                        <h3 class="mb-0"><%= formatCurrency(monthAmountValue) %></h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center shadow-sm h-100">
                    <div class="card-body">
                        <p class="text-muted mb-1">Number of Donations</p>
                        <h3 class="mb-0"><%= donationCountValue %></h3>
                    </div>
                </div>
            </div>
        </div>

        <% if (isAdmin) { %>
            <div class="d-flex flex-column flex-md-row gap-3 mb-4 align-items-md-center">
                <form method="GET" action="/donations" class="flex-grow-1">
                    <% filterPairs.forEach(function(pair) { %>
                        <input type="hidden" name="<%= pair.key %>" value="<%= pair.value %>">
                    <% }); %>
                    <input type="hidden" name="sort" value="<%= typeof sortColumn !== 'undefined' ? sortColumn : 'DonationDate' %>">
                    <input type="hidden" name="sortDir" value="<%= typeof sortDir !== 'undefined' ? sortDir : 'desc' %>">
                    <input type="hidden" name="page" value="1">
                    <div class="input-group">
                        <input type="text" class="form-control" name="search" placeholder="Search by donor, amount, or ID..." value="<%= searchValue %>">
                        <button type="submit" class="btn btn-primary">Search</button>
                        <% if (searchValue) { %>
                            <a href="/donations" class="btn btn-outline-secondary">Clear</a>
                        <% } %>
                    </div>
                </form>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#donationFilterModal">Filters</button>
                    <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#donationSortModal">Sort</button>
                    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addDonationModal">+ Add Donation</button>
                </div>
            </div>
        <% } else { %>
            <div class="mb-4"></div>
        <% } %>

        <div class="border-bottom mb-4"></div>

        <% if (typeof error !== 'undefined' && error) { %>
            <div class="alert alert-danger" role="alert"><%= error %></div>
        <% } %>
        <% if (typeof success !== 'undefined' && success) { %>
            <div class="alert alert-success" role="alert"><%= success %></div>
        <% } %>

        <% if (Array.isArray(donations) && donations.length) { %>
            <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3  g-4">
                <% donations.forEach(function(donation) { %>
                    <div class="col">
                        <div class="card h-100 shadow-sm">
                            <div class="card-body d-flex flex-column">
                                <div class="d-flex w-100 justify-content-between align-items-start mb-2">
                                    <div>
                                        <h5 class="card-title mb-1"><%= formatCurrency(donation.DonationAmountValue) %></h5>
                                        <small class="text-muted"><%= donation.DonationDateDisplay || 'Date not set' %></small>
                                    </div>
                                    <% if (isAdmin) { %>
                                        <div class="btn-group btn-group-sm ms-2">
                                        <button type="button"
                                                class="btn btn-outline-primary edit-donation-btn"
                                                data-bs-toggle="modal"
                                                data-bs-target="#editDonationModal"
                                                data-donation-id="<%= donation.DonationID %>"
                                                data-date="<%= donation.DonationDate ? new Date(donation.DonationDate).toISOString().split('T')[0] : '' %>"
                                                data-amount="<%= donation.DonationAmountValue %>"
                                                data-participant-id="<%= donation.ParticipantID %>"
                                                data-participant-display="<%= donation.ParticipantFirstName %> <%= donation.ParticipantLastName %> (#<%= donation.ParticipantID %>) - <%= donation.ParticipantEmail %>">
                                            Edit
                                        </button>
                                            <form action="/donations/delete" method="POST" class="delete-donation-form d-inline" data-amount="<%= formatCurrency(donation.DonationAmountValue) %>">
                                                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                                <input type="hidden" name="DonationID" value="<%= donation.DonationID %>">
                                                <button type="submit" class="btn btn-outline-danger">Delete</button>
                                            </form>
                                        </div>
                                    <% } %>
                                </div>
                                <p class="mb-1">
                                    <strong>Participant:</strong>
                                    <span class="participant-tooltip" data-bs-toggle="tooltip" data-bs-html="true" title="<%= donation.ParticipantFirstName %> <%= donation.ParticipantLastName %><br>Age: <%= typeof donation.ParticipantAge === 'number' ? donation.ParticipantAge : 'N/A' %><br>City: <%= donation.ParticipantCity || 'N/A' %><br>State: <%= donation.ParticipantState || 'N/A' %><br>Interest: <%= donation.ParticipantFieldOfInterest || 'N/A' %><br>Email: <%= donation.ParticipantEmail %>">
                                        <%= donation.ParticipantFirstName %> <%= donation.ParticipantLastName %>
                                    </span>
                                </p>
                                <p class="text-muted mb-0">Donation ID: <%= donation.DonationID %></p>
                            </div>
                        </div>
                    </div>
                <% }); %>
            </div>
            <% if (typeof totalDonations !== 'undefined' && totalDonations >= 0) { %>
                <% const startIndex = totalDonations > 0 ? ((currentPage - 1) * pageSize + 1) : 0; %>
                <% const endIndex = totalDonations > 0 ? Math.min(currentPage * pageSize, totalDonations) : 0; %>
                <div class="mt-4 d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
                    <div>
                        <% if (currentPage > 1) { %>
                            <a href="/donations?page=<%= currentPage - 1 %><%= searchValue ? '&search=' + encodeURIComponent(searchValue) : '' %><%= filterQueryString %><%= sortQueryString %>" class="btn btn-secondary">&larr; Previous Page</a>
                        <% } %>
                    </div>
                    <div class="text-muted text-center">
                        Showing <%= startIndex %> - <%= endIndex %> of <%= totalDonations %> donations (Page <%= currentPage %> of <%= totalPages %>)
                    </div>
                    <div class="text-end">
                        <% if (hasNextPage) { %>
                            <a href="/donations?page=<%= currentPage + 1 %><%= searchValue ? '&search=' + encodeURIComponent(searchValue) : '' %><%= filterQueryString %><%= sortQueryString %>" class="btn btn-primary">Next Page &rarr;</a>
                        <% } %>
                    </div>
                </div>
            <% } %>
        <% } else { %>
            <div class="alert alert-info text-center">No donations found.</div>
        <% } %>
    </div>


    <% if (isAdmin) { %>
        <div class="modal fade" id="addDonationModal" tabindex="-1" aria-labelledby="addDonationModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addDonationModalLabel">Add Donation</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="addDonationForm" action="/donations/add" method="POST">
                            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                            <div class="mb-3">
                                <label class="form-label">Participant *</label>
                                <input type="text" class="form-control mb-2" id="donationParticipantSearch" placeholder="Search by name or email" autocomplete="off">
                                <select class="form-select" id="donationParticipantSelect" name="ParticipantID" size="6" required>
                                    <option value="">Select participant</option>
                                    <% participantChoices.forEach(function(participant) { %>
                                        <option value="<%= participant.ParticipantID %>">
                                            <%= participant.ParticipantFirstName %> <%= participant.ParticipantLastName %> (#<%= participant.ParticipantID %>) - <%= participant.ParticipantEmail %>
                                        </option>
                                    <% }); %>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="addDonationAmount" class="form-label">Amount *</label>
                                <input type="number" step="0.01" min="0.01" class="form-control" id="addDonationAmount" name="DonationAmount" required>
                            </div>
                            <div class="mb-3">
                                <label for="addDonationDate" class="form-label">Donation Date</label>
                                <input type="date" class="form-control" id="addDonationDate" name="DonationDate">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" form="addDonationForm" class="btn btn-success">Save Donation</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="editDonationModal" tabindex="-1" aria-labelledby="editDonationModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editDonationModalLabel">Edit Donation</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editDonationForm" action="/donations/edit" method="POST">
                            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                            <input type="hidden" name="DonationID" id="editDonationId">
                            <div class="mb-3">
                                <label class="form-label">Participant *</label>
                                <input type="text" class="form-control mb-2" id="editDonationParticipantSearch" placeholder="Search by name or email" autocomplete="off">
                                <select class="form-select" id="editDonationParticipantSelect" name="ParticipantID" size="6" required>
                                    <option value="">Select participant</option>
                                    <% participantChoices.forEach(function(participant) { %>
                                        <option value="<%= participant.ParticipantID %>">
                                            <%= participant.ParticipantFirstName %> <%= participant.ParticipantLastName %> (#<%= participant.ParticipantID %>) - <%= participant.ParticipantEmail %>
                                        </option>
                                    <% }); %>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="editDonationAmount" class="form-label">Amount *</label>
                                <input type="number" step="0.01" min="0.01" class="form-control" id="editDonationAmount" name="DonationAmount" required>
                            </div>
                            <div class="mb-3">
                                <label for="editDonationDate" class="form-label">Donation Date</label>
                                <input type="date" class="form-control" id="editDonationDate" name="DonationDate" >
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" form="editDonationForm" class="btn btn-primary">Update Donation</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="donationFilterModal" tabindex="-1" aria-labelledby="donationFilterModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="donationFilterModalLabel">Filter Donations</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form method="GET" action="/donations">
                        <div class="modal-body">
                            <% if (searchValue) { %>
                                <input type="hidden" name="search" value="<%= searchValue %>">
                            <% } %>
                            <% if (filterValues.filterParticipantID) { %>
                                <input type="hidden" name="filterParticipantID" value="<%= filterValues.filterParticipantID %>">
                                <% } %>
                                <% if (filterValues.filterMilestoneID) { %>
                                    <input type="hidden" name="filterMilestoneID" value="<%= filterValues.filterMilestoneID %>">
                                <% } %>
                            <input type="hidden" name="sort" value="<%= typeof sortColumn !== 'undefined' ? sortColumn : 'DonationDate' %>">
                            <input type="hidden" name="sortDir" value="<%= typeof sortDir !== 'undefined' ? sortDir : 'desc' %>">
                            <input type="hidden" name="page" value="1">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Donation Date From</label>
                                    <input type="date" class="form-control" name="filterStartDate" value="<%= filterValues.filterStartDate || '' %>">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Donation Date To</label>
                                    <input type="date" class="form-control" name="filterEndDate" value="<%= filterValues.filterEndDate || '' %>">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Minimum Amount</label>
                                    <input type="number" step="0.01" min="0" class="form-control" name="filterMinAmount" value="<%= filterValues.filterMinAmount || '' %>">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Maximum Amount</label>
                                    <input type="number" step="0.01" min="0" class="form-control" name="filterMaxAmount" value="<%= filterValues.filterMaxAmount || '' %>">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Minimum Age</label>
                                    <input type="number" min="0" class="form-control" name="filterMinAge" value="<%= filterValues.filterMinAge || '' %>">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Maximum Age</label>
                                    <input type="number" min="0" class="form-control" name="filterMaxAge" value="<%= filterValues.filterMaxAge || '' %>">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">City</label>
                                    <input type="text" class="form-control" name="filterCity" value="<%= filterValues.filterCity || '' %>">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">State</label>
                                    <input type="text" class="form-control" name="filterState" value="<%= filterValues.filterState || '' %>">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Participant Role</label>
                                    <select class="form-select" name="filterRole">
                                        <option value="">Any</option>
                                        <option value="a" <%= filterValues.filterRole === 'a' ? 'selected' : '' %>>Admin</option>
                                        <option value="p" <%= filterValues.filterRole === 'p' ? 'selected' : '' %>>Participant</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Field of Interest</label>
                                    <select class="form-select" name="filterInterest">
                                        <option value="">Any</option>
                                        <option value="STEM" <%= filterValues.filterInterest === 'STEM' ? 'selected' : '' %>>STEM</option>
                                        <option value="Arts" <%= filterValues.filterInterest === 'Arts' ? 'selected' : '' %>>Arts</option>
                                        <option value="Both" <%= filterValues.filterInterest === 'Both' ? 'selected' : '' %>>Both</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <% if (!searchValue) { %>
                            <a href="/donations" class="btn btn-outline-secondary">Clear Filters</a>
                                <% } %>
                            <% if (searchValue) { %>
                            <a href="/donations<%= searchValue ? '?search=' + encodeURIComponent(searchValue) : '' %><%= sortQueryString %>" class="btn btn-outline-secondary">Clear Filters</a>
                                <% } %>
                            <button type="submit" class="btn btn-primary">Apply Filters</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="modal fade" id="donationSortModal" tabindex="-1" aria-labelledby="donationSortModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="donationSortModalLabel">Sort Donations</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form method="GET" action="/donations">
                        <div class="modal-body">
                            <% if (searchValue) { %>
                                <input type="hidden" name="search" value="<%= searchValue %>">
                            <% } %>
                            <% filterPairs.forEach(function(pair) { %>
                                <input type="hidden" name="<%= pair.key %>" value="<%= pair.value %>">
                            <% }); %>
                            <input type="hidden" name="page" value="1">
                            <div class="mb-3">
                                <label class="form-label">Sort field</label>
                                <select class="form-select" name="sort">
                                    <option value="DonationDate" <%= sortColumn === 'DonationDate' ? 'selected' : '' %>>Donation Date</option>
                                    <option value="DonationAmount" <%= sortColumn === 'DonationAmount' ? 'selected' : '' %>>Donation Amount</option>
                                    <option value="DonationID" <%= sortColumn === 'DonationID' ? 'selected' : '' %>>Donation ID</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Direction</label>
                                <select class="form-select" name="sortDir">
                                    <option value="desc" <%= sortDir === 'desc' ? 'selected' : '' %>>Descending</option>
                                    <option value="asc" <%= sortDir === 'asc' ? 'selected' : '' %>>Ascending</option>
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary">Apply Sort</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    <% } else if (user.ParticipantRole === 'p') { %>
        <div class="modal fade" id="DonateModal" tabindex="-1" aria-labelledby="DonateModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="DonateLabel">Donate</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="DonateForm" action="/donations/add/user" method="POST">
                            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                            <div class="mb-3">
                                <input 
                                    type="hidden"
                                    id="donationParticipantSearch"
                                    name="ParticipantID"
                                    value="<%= user.ParticipantID %>"
                                >
                            </div>
                            <div class="mb-3">
                                <label for="DonateAmount" class="form-label">Amount *</label>
                                <input type="number" step="0.01" min="0.01" class="form-control" id="DonateAmount" name="DonationAmount" required>
                            </div>
                            <div class="mb-3">
                                <input 
                                    type="hidden"
                                    id="addDonationDate"
                                    name="DonationDate"
                                    value="<%= new Date().toISOString().split('T')[0] %>"
                                >
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" form="DonateForm" class="btn btn-success">Save Donation</button>
                    </div>
                </div>
            </div>
        </div>
    <% } %>

    <script>
        var form = document.getElementById('DonateForm');

        if (form) {
            form.addEventListener('submit', function(e) {

                // get donation amount
                var amount = document.getElementById('DonateAmount').value;

                // Open new tab
                window.open(`https://givebutter.com/EllaRises?amount=${encodeURIComponent(amount)}`, '_blank');

                // Form will still submit normally to /donations
            });
        }
    </script>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const addSearchInput = document.getElementById('donationParticipantSearch');
        const addSelect = document.getElementById('donationParticipantSelect');
        const editSearchInput = document.getElementById('editDonationParticipantSearch');
        const editSelect = document.getElementById('editDonationParticipantSelect');
        const editIdInput = document.getElementById('editDonationId');
        const editAmountInput = document.getElementById('editDonationAmount');
        const editDateInput = document.getElementById('editDonationDate');

        function resetSelect(selectElement) {
            if (!selectElement) return;
            Array.from(selectElement.options).forEach(function(option, index) {
                option.hidden = false;
                if (index === 0) {
                    option.selected = true;
                }
            });
        }

        function bindFilter(input, selectElement) {
            if (!input || !selectElement) return;
            input.addEventListener('input', function() {
                const term = (input.value || '').toLowerCase();
                Array.from(selectElement.options).forEach(function(option, index) {
                    if (index === 0) {
                        option.hidden = false;
                        return;
                    }
                    option.hidden = term && !option.textContent.toLowerCase().includes(term);
                });
            });
        }

        bindFilter(addSearchInput, addSelect);
        bindFilter(editSearchInput, editSelect);

        const addModal = document.getElementById('addDonationModal');
        if (addModal) {
            addModal.addEventListener('show.bs.modal', function() {
                if (addSearchInput) addSearchInput.value = '';
                resetSelect(addSelect);
            });
        }

        document.querySelectorAll('.edit-donation-btn').forEach(function(button) {
            button.addEventListener('click', function() {
                const participantDisplay = this.getAttribute('data-participant-display') || '';
                if (editSearchInput) {
                    editSearchInput.value = participantDisplay;
                    // Trigger filter so only that participant shows
                    editSearchInput.dispatchEvent(new Event('input', { bubbles: true }));
                } else {
                    resetSelect(editSelect);
                }
                if (editIdInput) editIdInput.value = this.getAttribute('data-donation-id') || '';
                if (editAmountInput) editAmountInput.value = this.getAttribute('data-amount') || '';
                if (editDateInput) editDateInput.value = this.getAttribute('data-date') || '';
                if (editSelect) {
                    const participantId = this.getAttribute('data-participant-id') || '';
                    editSelect.value = participantId;
                }
            });
        });

        document.querySelectorAll('.delete-donation-form').forEach(function(form) {
            form.addEventListener('submit', function(e) {
                const summary = form.getAttribute('data-amount') || 'this donation';
                if (!confirm('Delete ' + summary + '?')) {
                    e.preventDefault();
                }
            });
        });

        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.forEach(function(triggerEl) {
            new bootstrap.Tooltip(triggerEl);
        });
    });
    </script>

    <% if (isAdmin) { %>
        <!-- Chart.js Library -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="/js/donations-by-month-chart.js"></script>
    <% } %>

    
<% } %>
