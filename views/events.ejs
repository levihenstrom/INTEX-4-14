<!-- Events Header -->
<div class="events-header">
    <h1>EVENTS</h1>
    <p>Join us for inspiring workshops, creative experiences, and leadership opportunities that empower the rising
        generation of women in STEAM fields.</p>
</div>

<!-- Upcoming Events Carousel -->
<% if (upcomingEvents && upcomingEvents.length > 0) { %>
<div class="upcoming-events-section">
    <h2 class="upcoming-events-title">Upcoming Events</h2>
    <div class="upcoming-events-carousel-container">
        <button class="carousel-btn carousel-btn-prev" onclick="scrollCarousel('prev')" aria-label="Previous">
            <i class="fa-solid fa-chevron-left"></i>
        </button>
        <div class="upcoming-events-carousel" id="upcomingEventsCarousel">
            <% upcomingEvents.forEach(event => { %>
                <div class="upcoming-event-card">
                    <a href="/registration/<%= event.EventID %>?occurrence=<%= event.OccurrenceID %>" class="upcoming-event-link">
                        <div class="upcoming-event-image">
                            <% const imageSrc = `/images/events/event_${event.EventID}_real.jpg`; %>
                            <img src="<%- imageSrc %>" 
                                 alt="<%= event.EventName %>" 
                                 onerror="this.src='/images/events/event_0_real.png'">
                        </div>
                        <div class="upcoming-event-content">
                            <div class="upcoming-event-header">
                                <h3 class="upcoming-event-name"><%= event.EventName %></h3>
                                <span class="status-badge <%= event.isFull ? 'status-full' : 'status-available' %>">
                                    <i class="fa-solid fa-users"></i>
                                    <%= event.isFull ? 'Full' : 'Space Available' %>
                                </span>
                            </div>
                            <div class="upcoming-event-details">
                                <% if (event.EventLocation) { %>
                                    <div class="upcoming-event-detail">
                                        <i class="fa-solid fa-location-dot"></i>
                                        <span><%= event.EventLocation %></span>
                                    </div>
                                <% } %>
                                <div class="upcoming-event-detail">
                                    <i class="fa-solid fa-calendar"></i>
                                    <span>
                                        <%= new Date(event.EventDateTimeStart).toLocaleDateString('en-US', { 
                                            weekday: 'short', 
                                            month: 'short', 
                                            day: 'numeric',
                                            year: 'numeric'
                                        }) %>
                                    </span>
                                </div>
                                <div class="upcoming-event-detail">
                                    <i class="fa-solid fa-clock"></i>
                                    <span>
                                        <%= new Date(event.EventDateTimeStart).toLocaleTimeString('en-US', { 
                                            hour: 'numeric', 
                                            minute: '2-digit',
                                            hour12: true 
                                        }) %>
                                        <% if (event.EventDateTimeEnd) { %>
                                            - <%= new Date(event.EventDateTimeEnd).toLocaleTimeString('en-US', { 
                                                hour: 'numeric', 
                                                minute: '2-digit',
                                                hour12: true 
                                            }) %>
                                        <% } %>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </a>
                </div>
            <% }); %>
        </div>
        <button class="carousel-btn carousel-btn-next" onclick="scrollCarousel('next')" aria-label="Next">
            <i class="fa-solid fa-chevron-right"></i>
        </button>
    </div>
</div>
<% } %>

<!-- Events Filters -->
<div class="events-filters">
    <div class="filters-container">
        <div class="filter-section">
            <span class="filter-label"><i class="fa-solid fa-filter"></i> Event Type:</span>
            <div class="event-labels filter-labels" id="event-type-pills">
                <span class="event-label event-label-type-stem filter-pill" data-filter-type="eventType" data-filter-value="all">
                    <i class="fa-solid fa-sliders"></i>All Types
                </span>
                <span class="event-label event-label-type-leadership filter-pill" data-filter-type="eventType" data-filter-value="Leadership">
                    <i class="fa-solid fa-users"></i>Leadership
                </span>
                <span class="event-label event-label-type-stem filter-pill" data-filter-type="eventType" data-filter-value="STEM">
                    <i class="fa-solid fa-gear"></i>STEM
                </span>
                <span class="event-label event-label-type-arts filter-pill" data-filter-type="eventType" data-filter-value="Arts">
                    <i class="fa-solid fa-paintbrush"></i>Arts
                </span>
                <span class="event-label event-label-type-annual-conference filter-pill" data-filter-type="eventType" data-filter-value="Annual Conference">
                    <i class="fa-solid fa-calendar-star"></i>Annual Conference
                </span>
            </div>
        </div>
        <div class="filter-section">
            <span class="filter-label"><i class="fa-solid fa-calendar"></i> Recurrence:</span>
            <div class="event-labels filter-labels" id="event-recurrence-pills">
                <span class="event-label event-label-recurrence-monthly filter-pill" data-filter-type="eventRecurrence" data-filter-value="all">
                    <i class="fa-solid fa-sliders"></i>All Patterns
                </span>
                <span class="event-label event-label-recurrence-weekly filter-pill" data-filter-type="eventRecurrence" data-filter-value="Weekly">
                    <i class="fa-solid fa-calendar-week"></i>Weekly
                </span>
                <span class="event-label event-label-recurrence-monthly filter-pill" data-filter-type="eventRecurrence" data-filter-value="Monthly">
                    <i class="fa-solid fa-calendar-days"></i>Monthly
                </span>
                <span class="event-label event-label-recurrence-annual filter-pill" data-filter-type="eventRecurrence" data-filter-value="Annual">
                    <i class="fa-solid fa-calendar-check"></i>Annual
                </span>
            </div>
        </div>
        <% if (typeof isAdmin !== 'undefined' && isAdmin) { %>
        <div class="filter-section">
            <button type="button" class="btn-add-event filter-pill" data-bs-toggle="modal" data-bs-target="#addEventModal">
                <i class="fa-solid fa-plus"></i>Add Event
            </button>
        </div>
        <% } %>
    </div>
</div>

<!-- Events Grid -->
<div class="events-container">
    <div class="events-grid">
        <% event_templates.forEach(event => { %>
            <div class="event-card-wrapper" 
                 data-event-id="<%= event.EventID %>" 
                 data-event-type="<%= event.EventType || '' %>" 
                 data-event-recurrence="<%= event.EventRecurrencePattern || '' %>" 
                 data-event-capacity="<%= event.EventDefaultCapacity || '' %>">
                <a href="/registration/<%= event.EventID %>" class="event-card">
                    <div class="event-image">
                        <% const imageSrc = `/images/events/event_${event.EventID}_real.jpg`;
                        %>
                        <img src="<%- imageSrc %>" 
                             alt="<%= event.EventName %>" 
                             style="width: 100%; height: 100%; object-fit: cover;"
                             onerror="this.src='/images/events/event_0_real.png'">
                    </div>
                    <div class="event-content">
                        <div class="event-name">
                            <%= event.EventName %>
                        </div>
                        <div class="event-description">
                            <span class="event-description-text">
                                <%= event.EventDescription || 'Join us for this exciting event!' %>
                            </span>
                        </div>
                    </div>
                </a>
            </div>
        <% }); %>
    </div>
</div>

<!-- Filter Functionality -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const eventCardWrappers = document.querySelectorAll('.event-card-wrapper');
        const typePills = Array.from(document.querySelectorAll('#event-type-pills .filter-pill'));
        const recurPills = Array.from(document.querySelectorAll('#event-recurrence-pills .filter-pill'));
        let currentType = 'all';
        let currentRecurrence = 'all';

        function setActive(pills, value) {
            pills.forEach(p => {
                if (p.getAttribute('data-filter-value') === value) {
                    p.classList.add('filter-selected');
                } else {
                    p.classList.remove('filter-selected');
                }
            });
        }

        function filterEvents() {
            eventCardWrappers.forEach(wrapper => {
                const cardType = (wrapper.getAttribute('data-event-type') || '').trim();
                const cardRecurrence = (wrapper.getAttribute('data-event-recurrence') || '').trim();

                const typeOk = currentType === 'all' || cardType === currentType;
                const recurOk = currentRecurrence === 'all' || cardRecurrence === currentRecurrence;
                wrapper.style.display = typeOk && recurOk ? 'block' : 'none';
            });
        }

        typePills.forEach(pill => {
            pill.addEventListener('click', () => {
                const value = pill.getAttribute('data-filter-value');
                currentType = value;
                setActive(typePills, value);
                filterEvents();
            });
        });

        recurPills.forEach(pill => {
            pill.addEventListener('click', () => {
                const value = pill.getAttribute('data-filter-value');
                currentRecurrence = value;
                setActive(recurPills, value);
                filterEvents();
            });
        });

        // initialize selection
        setActive(typePills, 'all');
        setActive(recurPills, 'all');
        filterEvents();
    });

    // Carousel functionality
    function scrollCarousel(direction) {
        const carousel = document.getElementById('upcomingEventsCarousel');
        if (!carousel) return;
        
        const cardWidth = carousel.querySelector('.upcoming-event-card').offsetWidth;
        const gap = 32; // 2rem gap
        const scrollAmount = cardWidth + gap;
        
        if (direction === 'prev') {
            carousel.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
        } else {
            carousel.scrollBy({ left: scrollAmount, behavior: 'smooth' });
        }
    }
</script>

<!-- Add Event Modal -->
<% if (typeof isAdmin !== 'undefined' && isAdmin) { %>
<div class="modal fade" id="addEventModal" tabindex="-1" aria-labelledby="addEventModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addEventModalLabel">Add New Event</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addEventForm" action="/events/add" method="POST">
                    <input type="hidden" name="_csrf" value="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">
                    
                    <!-- Event Name -->
                    <div class="mb-3">
                        <label for="eventName" class="form-label">Event Name *</label>
                        <input type="text" class="form-control" id="eventName" name="EventName" required>
                    </div>

                    <!-- Event Description -->
                    <div class="mb-3">
                        <label for="eventDescription" class="form-label">Event Description</label>
                        <textarea class="form-control" id="eventDescription" name="EventDescription" rows="4"></textarea>
                    </div>

                    <!-- Event Default Capacity -->
                    <div class="mb-3">
                        <label for="eventDefaultCapacity" class="form-label">Default Capacity</label>
                        <input type="number" class="form-control" id="eventDefaultCapacity" name="EventDefaultCapacity" min="1">
                    </div>

                    <!-- Event Type -->
                    <div class="mb-3">
                        <label class="form-label">Event Type *</label>
                        <div class="event-labels filter-labels" id="modal-event-type-pills">
                            <label class="event-label event-label-type-leadership filter-pill modal-radio-pill">
                                <input type="radio" name="EventType" value="Leadership" required style="display: none;">
                                <i class="fa-solid fa-users"></i>Leadership
                            </label>
                            <label class="event-label event-label-type-stem filter-pill modal-radio-pill">
                                <input type="radio" name="EventType" value="STEM" required style="display: none;">
                                <i class="fa-solid fa-gear"></i>STEM
                            </label>
                            <label class="event-label event-label-type-arts filter-pill modal-radio-pill">
                                <input type="radio" name="EventType" value="Arts" required style="display: none;">
                                <i class="fa-solid fa-paintbrush"></i>Arts
                            </label>
                            <label class="event-label event-label-type-annual-conference filter-pill modal-radio-pill">
                                <input type="radio" name="EventType" value="Annual Conference" required style="display: none;">
                                <i class="fa-solid fa-calendar-star"></i>Annual Conference
                            </label>
                        </div>
                    </div>

                    <!-- Event Recurrence Pattern -->
                    <div class="mb-3">
                        <label class="form-label">Recurrence Pattern *</label>
                        <div class="event-labels filter-labels" id="modal-event-recurrence-pills">
                            <label class="event-label event-label-recurrence-weekly filter-pill modal-radio-pill">
                                <input type="radio" name="EventRecurrencePattern" value="Weekly" required style="display: none;">
                                <i class="fa-solid fa-calendar-week"></i>Weekly
                            </label>
                            <label class="event-label event-label-recurrence-monthly filter-pill modal-radio-pill">
                                <input type="radio" name="EventRecurrencePattern" value="Monthly" required style="display: none;">
                                <i class="fa-solid fa-calendar-days"></i>Monthly
                            </label>
                            <label class="event-label event-label-recurrence-annual filter-pill modal-radio-pill">
                                <input type="radio" name="EventRecurrencePattern" value="Annual" required style="display: none;">
                                <i class="fa-solid fa-calendar-check"></i>Annual
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="addEventForm" class="btn btn-primary">Add Event</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Handle radio pill selection in modal
    document.addEventListener('DOMContentLoaded', function() {
        const modalTypePills = document.querySelectorAll('#modal-event-type-pills .modal-radio-pill');
        const modalRecurPills = document.querySelectorAll('#modal-event-recurrence-pills .modal-radio-pill');

        function handlePillClick(pills) {
            pills.forEach(pill => {
                pill.addEventListener('click', function() {
                    // Remove selected class from all pills of this type
                    pills.forEach(p => p.classList.remove('filter-selected'));
                    // Add selected class to clicked pill
                    this.classList.add('filter-selected');
                    // Check the radio button
                    const radio = this.querySelector('input[type="radio"]');
                    if (radio) {
                        radio.checked = true;
                    }
                });
            });
        }

        handlePillClick(modalTypePills);
        handlePillClick(modalRecurPills);

        // Reset form when modal is closed
        const addEventModal = document.getElementById('addEventModal');
        if (addEventModal) {
            addEventModal.addEventListener('hidden.bs.modal', function() {
                const form = document.getElementById('addEventForm');
                if (form) {
                    form.reset();
                    // Remove selected classes
                    modalTypePills.forEach(p => p.classList.remove('filter-selected'));
                    modalRecurPills.forEach(p => p.classList.remove('filter-selected'));
                }
            });
        }
    });
</script>
<% } %>
