<div class="registration-page">
    <div class="container-fluid">
        <div class="row justify-content-center">
            <!-- <div class="col-lg-11 col-xl-10"> -->
            <div class="col-12">
                <div class="registration-card">
                    <div class="registration-header">
                        <div class="registration-image">
                            <% const imageSrc = `/images/events/event_${eventTemplate.EventID}.jpg`; %>
                            <img src="<%- imageSrc %>" 
                                 alt="<%= eventTemplate.EventName %>" 
                                 onerror="this.src='/images/events/event_0_real.png'">
                        </div>
                        <div class="registration-header-content">
                            <h1 class="registration-title"><%= eventTemplate.EventName %></h1>
                            <div class="event-details">
                                <% if (eventTemplate.EventDescription) { %>
                            <div class="event-description">
                                <p><%= eventTemplate.EventDescription %></p>
                            </div>
                        <% } %>
                        <div class="event-labels">
                            <% 
                                const eventType = eventTemplate.EventType || '';
                                let typeIcon = 'fa-tag';
                                let typeColor = '#6B6F6B';
                                if (eventType === 'STEM') {
                                    typeIcon = 'fa-gear';
                                    typeColor = '#99B7C6';
                                } else if (eventType === 'Arts') {
                                    typeIcon = 'fa-paintbrush';
                                    typeColor = '#F4B092';
                                } else if (eventType === 'Leadership') {
                                    typeIcon = 'fa-users';
                                    typeColor = '#9AB59D';
                                } else if (eventType === 'Annual Conference') {
                                    typeIcon = 'fa-calendar-star';
                                    typeColor = '#978EC4';
                                }
                                
                                const recurrence = eventTemplate.EventRecurrencePattern || '';
                                let recurIcon = 'fa-calendar';
                                let recurColor = '#6B6F6B';
                                if (recurrence === 'Monthly') {
                                    recurIcon = 'fa-calendar-days';
                                    recurColor = '#99B7C6';
                                } else if (recurrence === 'Weekly') {
                                    recurIcon = 'fa-calendar-week';
                                    recurColor = '#978EC4';
                                } else if (recurrence === 'Annual') {
                                    recurIcon = 'fa-calendar-check';
                                    recurColor = '#9AB59D';
                                }
                            %>
                            <% if (eventType) { %>
                                <span class="event-label event-label-type-<%= eventType.toLowerCase().replace(/\s+/g, '-') %>">
                                    <i class="fa-solid <%= typeIcon %>"></i>
                                    <%= eventType %>
                                </span>
                            <% } %>
                            <% if (recurrence) { %>
                                <span class="event-label event-label-recurrence-<%= recurrence.toLowerCase() %>">
                                    <i class="fa-solid <%= recurIcon %>"></i>
                                    <%= recurrence %>
                                </span>
                            <% } %>
                        </div>
                       
                            </div>
                            <div class="occurrences-section">
                                <h2><%= typeof isAdmin !== 'undefined' && isAdmin ? 'All Sessions' : 'Available Sessions' %></h2>
                                <% if (typeof isAdmin !== 'undefined' && isAdmin) { %>
                                    <div class="occurrence-toggle" id="occurrence-toggle">
                                        <button type="button" class="toggle-btn active" data-filter="future">Future</button>
                                        <button type="button" class="toggle-btn" data-filter="past">Past</button>
                                    </div>
                                <% } %>
                                <% if (occurrences && occurrences.length > 0) { %>
                                    <div class="occurrences-list-container">
                                        <div class="occurrences-list">
                                        <% occurrences.forEach(occurrence => { %>
                                            <% const isRegistered = typeof registeredOccurrenceIds !== 'undefined' && registeredOccurrenceIds.includes(occurrence.OccurrenceID); %>
                                            <% const isPast = typeof occurrence.isPast !== 'undefined' && occurrence.isPast; %>
                                            <% const isFull = typeof occurrence.isFull !== 'undefined' && occurrence.isFull; %>
                                            <% const disableRegister = isFull && !isRegistered; %>
                                            <div class="occurrence-card <%= typeof focusedOccurrenceId !== 'undefined' && focusedOccurrenceId === occurrence.OccurrenceID ? 'occurrence-focused' : '' %> <%= isPast ? 'occurrence-past' : '' %>" 
                                                id="<%= typeof focusedOccurrenceId !== 'undefined' && focusedOccurrenceId === occurrence.OccurrenceID ? 'focused-occurrence' : '' %>"
                                                data-occurrence-id="<%= occurrence.OccurrenceID %>"
                                                data-is-past="<%= isPast %>">
                                           
                                               <div class="occurrence-info">
                                                   <div class="occurrence-main-row">
                                                       <!-- LEFT: date, time, status -->
                                                       <div class="occurrence-date-time">
                                                           <div class="occurrence-date">
                                                               <% 
                                                                   const d = new Date(occurrence.EventDateTimeStart);
                                                                   const isToday = d.toDateString() === new Date().toDateString();
                                                                    const isThisYear = d.getFullYear() === new Date().getFullYear();
                                                                %>
                                                               <%= isToday
                                                                   ? 'Today'
                                                                   : d.toLocaleDateString(
                                                                       'en-US',
                                                                       isThisYear
                                                                           ? { weekday: 'short', month: 'short', day: 'numeric' }
                                                                           : { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' }
                                                                   )
                                                               %>
                                                           </div>
                                           
                                                           <div class="occurrence-time">
                                                               <i class="fa-solid fa-clock"></i>
                                                               <%= new Date(occurrence.EventDateTimeStart).toLocaleTimeString('en-US', { 
                                                                   hour: 'numeric', 
                                                                   minute: '2-digit',
                                                                   hour12: true 
                                                               }) %>
                                                               <% if (occurrence.EventDateTimeEnd) { %>
                                                                   - <%= new Date(occurrence.EventDateTimeEnd).toLocaleTimeString('en-US', { 
                                                                       hour: 'numeric', 
                                                                       minute: '2-digit',
                                                                       hour12: true 
                                                                   }) %>
                                                               <% } %>
                                                           </div>
                                           
                                                           <% if (!isPast) { %>
                                                               <span class="status-badge <%= occurrence.isFull ? 'status-full' : 'status-available' %>">
                                                                   <i class="fa-solid fa-users"></i>
                                                                   <%= occurrence.isFull ? 'Full' : 'Space Available' %>
                                                               </span>
                                                           <% } else if (typeof isAdmin !== 'undefined' && isAdmin) { %>
                                                               <span class="status-badge status-past">
                                                                   <i class="fa-solid fa-clock"></i>
                                                                   Past
                                                               </span>
                                                           <% } %>
                                                       </div>
                                           
                                                       <!-- MIDDLE: location, capacity, attended -->
                                                       <div class="occurrence-details-row">
                                                           <% if (occurrence.EventLocation) { %>
                                                               <div class="occurrence-detail-item">
                                                                   <i class="fa-solid fa-location-dot"></i>
                                                                   <span><%= occurrence.EventLocation %></span>
                                                               </div>
                                                           <% } %>
                                                           <% if (occurrence.EventCapacity) { %>
                                                               <div class="occurrence-detail-item">
                                                                   <i class="fa-solid fa-users"></i>
                                                                   <span><%= occurrence.EventCapacity %> slots</span>
                                                               </div>
                                                           <% } %>
                                                           <% if (isPast && typeof isAdmin !== 'undefined' && isAdmin && typeof occurrence.attendanceCount !== 'undefined') { %>
                                                               <div class="occurrence-detail-item">
                                                                   <i class="fa-solid fa-check-circle"></i>
                                                                   <span><%= occurrence.attendanceCount %> attended</span>
                                                               </div>
                                                           <% } %>
                                                       </div>
                                                   </div>
                                               </div>
                                           
                                               <% if (typeof isAdmin !== 'undefined' && isAdmin) { %>
                                                   <button type="button" class="btn btn-secondary details-btn" data-occurrence-id="<%= occurrence.OccurrenceID %>">
                                                       Details
                                                   </button>
                                               <% } else if (typeof user !== 'undefined' && user && !isPast) { %>
                                                   <button type="button" 
                                                           class="btn register-toggle-btn <%= disableRegister ? 'btn-disabled' : (isRegistered ? 'btn-secondary' : 'btn-primary') %>"
                                                           data-occurrence-id="<%= occurrence.OccurrenceID %>"
                                                           data-is-registered="<%= isRegistered %>"
                                                           data-is-full="<%= isFull %>"
                                                           <%= disableRegister ? 'disabled aria-disabled=\"true\"' : '' %>>
                                                       <%= disableRegister ? 'Full' : (isRegistered ? 'Unregister' : 'Register') %>
                                                   </button>
                                               <% } else if (!isPast && (typeof isAdmin === 'undefined' || !isAdmin)) { %>
                                                   <a href="/login?redirect=/registration/<%= eventTemplate.EventID %>" class="btn btn-primary">
                                                       Login to Register
                                                   </a>
                                               <% } %>
                                           </div>
                                           
                                        <% }); %>
                                        </div>
                                        
                                    </div>
                                    <div class="registration-actions">
                                        <a href="/events" class="btn btn-outline-secondary">Back to Events</a>
                                    </div>
                                <% } else { %>
                                    <div class="no-occurrences">
                                        <p>No upcoming sessions available for this event at this time.</p>
                                        <a href="/events" class="btn btn-secondary">Back to Events</a>
                                    </div>
                                <% } %>
                            </div>
                        </div>
                    </div>

                    

                </div>
            </div>
        </div>
    </div>
</div>

<style>
.reg-modal {
    max-width: 640px;
    width: 92%;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.reg-modal-body {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.reg-modal-meta {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 0.75rem;
}

.reg-meta-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #4B4F4B;
    font-family: 'Montserrat', sans-serif;
    font-size: 0.95rem;
}

.reg-meta-item i {
    color: #978EC4;
}

.reg-participants-card {
    background: #F9F5EA;
    border: 1px solid #E6E0D4;
    border-radius: 12px;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.reg-participants-list {
    max-height: 260px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.reg-participant-row {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 0.75rem;
    padding: 0.75rem 0.9rem;
    background: white;
    border: 1px solid #E6E0D4;
    border-radius: 10px;
}

.reg-participant-info {
    display: flex;
    flex-direction: column;
    gap: 0.15rem;
}

.reg-participant-name {
    font-weight: 700;
    color: #3A3F3B;
}

.reg-participant-meta {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    flex-wrap: wrap;
}

.survey-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.25rem 0.7rem;
    border-radius: 999px;
    font-size: 0.85rem;
    font-weight: 700;
    background: #978EC4;
    color: white;
    cursor: pointer;
    text-decoration: none;
}

.survey-badge.missing {
    background: #D8D8D8;
    color: #3A3F3B;
    cursor: default;
}
.reg-participant-email {
    font-size: 0.9rem;
    color: #5A5E5A;
    word-break: break-all;
}

.reg-participant-actions {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
    position: relative;
}

.reg-participant-search {
    min-width: 220px;
}

.reg-search-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #E6E0D4;
    border-radius: 8px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.12);
    z-index: 10;
    display: none;
    max-height: 220px;
    overflow-y: auto;
}

.reg-search-results .result-item {
    padding: 0.5rem 0.75rem;
    cursor: pointer;
}

.reg-search-results .result-item:hover {
    background: #F0F0F0;
}

.reg-participant-actions .btn {
    white-space: nowrap;
}

.reg-participant-row .reg-actions {
    display: flex;
    align-items: center;
    gap: 0.4rem;
}

.reg-status-select {
    padding: 0.3rem 0.4rem;
    border-radius: 8px;
    border: 1px solid #D0D0D0;
    font-size: 0.9rem;
}

.reg-empty {
    margin: 0;
    font-style: italic;
    color: #6B6F6B;
}

.reg-form {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.reg-form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 0.75rem;
}

.reg-form-group label {
    font-weight: 600;
    color: #3A3F3B;
    margin-bottom: 0.35rem;
    display: block;
}

.reg-form-group .form-control,
.reg-form-group select {
    width: 100%;
}

.reg-modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
}

.status-pill {
    padding: 0.35rem 0.9rem;
    border-radius: 999px;
    font-size: 0.85rem;
    font-weight: 700;
    font-family: 'Montserrat', sans-serif;
    white-space: nowrap;
}

.status-pill--good {
    background: #9AB59D;
    color: white;
}

.status-pill--neutral {
    background: #D8D8D8;
    color: #3A3F3B;
}

.status-pill--bad {
    background: #CE325B;
    color: white;
}

</style>

<script>
    // Scroll to focused occurrence on page load
    document.addEventListener('DOMContentLoaded', function() {
        const isAdminView = <%= typeof isAdmin !== 'undefined' && isAdmin ? 'true' : 'false' %>;
        const adminOccurrenceData = isAdminView ? <%- JSON.stringify(typeof adminOccurrenceData !== 'undefined' ? adminOccurrenceData : {}) %> : {};
        const locationOptions = isAdminView ? <%- JSON.stringify(typeof locationOptions !== 'undefined' ? locationOptions : []) %> : [];
        const focusedOccurrence = document.getElementById('focused-occurrence');
        if (focusedOccurrence) {
            setTimeout(() => {
                focusedOccurrence.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        }

        // Admin toggle for past/future
        if (isAdminView) {
            const toggle = document.getElementById('occurrence-toggle');
            const cards = Array.from(document.querySelectorAll('.occurrence-card'));
            const modalBackdrop = document.querySelector('.reg-modal-backdrop');
            const modalClose = document.querySelector('.reg-modal-close');
            const modalTitle = document.getElementById('regModalTitle');
            const modalMeta = document.getElementById('regModalMeta');
            const modalParticipants = document.getElementById('regModalParticipants');
            const modalEmpty = document.getElementById('regModalEmpty');
            const modalCount = document.getElementById('regModalParticipantCount');
            const modalSave = document.getElementById('regModalSaveBtn');
            const modalDelete = document.getElementById('regModalDeleteBtn');
            const modalAdd = document.getElementById('regModalAddBtn');
            const searchInput = document.getElementById('regParticipantSearch');
            const searchResults = document.getElementById('regParticipantResults');
            const inputDate = document.getElementById('regEditDate');
            const inputStart = document.getElementById('regEditStart');
            const inputEnd = document.getElementById('regEditEnd');
            const selectLocation = document.getElementById('regEditLocation');
            let activeOccurrenceId = null;
            let activeSearchId = null;

            // Populate location dropdown
            if (selectLocation) {
                selectLocation.innerHTML = '';
                const defaultOpt = document.createElement('option');
                defaultOpt.value = '';
                defaultOpt.textContent = 'Select a location';
                selectLocation.appendChild(defaultOpt);
                locationOptions.forEach(loc => {
                    const opt = document.createElement('option');
                    opt.value = loc;
                    opt.textContent = loc;
                    selectLocation.appendChild(opt);
                });
            }

            const applyFilter = (filter) => {
                cards.forEach(card => {
                    const cardIsPast = card.getAttribute('data-is-past') === 'true';
                    const showCard = filter === 'past' ? cardIsPast : !cardIsPast;
                    card.style.display = showCard ? '' : 'none';
                });
            };

            const formatDateTime = (value) => {
                if (!value) return 'Date TBD';
                const d = new Date(value);
                if (Number.isNaN(d.getTime())) return 'Date TBD';
                return d.toLocaleString('en-US', {
                    weekday: 'short',
                    month: 'short',
                    day: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                });
            };

            const formatTimeRange = (start, end) => {
                if (!start) return 'Time TBD';
                const startDate = new Date(start);
                const endDate = end ? new Date(end) : null;
                const startStr = startDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
                const endStr = endDate && !Number.isNaN(endDate.getTime())
                    ? endDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })
                    : null;
                return endStr ? `${startStr} - ${endStr}` : startStr;
            };

            const computeStatus = (participant, occurrence) => {
                const isPast = !!occurrence?.isPast;
                const cancelled = (participant.status || '').toLowerCase() === 'cancelled';
                const checkedIn = !!(participant.checkInTime || participant.attended);

                if (isPast) {
                    if (participant.attended) return { label: 'Attended', cls: 'status-pill--good' };
                    if (cancelled) return { label: 'Cancelled', cls: 'status-pill--neutral' };
                    return { label: 'No Show', cls: 'status-pill--bad' };
                }

                return checkedIn
                    ? { label: 'Checked In', cls: 'status-pill--good' }
                    : { label: 'Not Checked In', cls: 'status-pill--neutral' };
            };

            const renderModal = (occurrenceId) => {
                const data = adminOccurrenceData[occurrenceId];
                if (!data || !modalBackdrop) return;
                activeOccurrenceId = occurrenceId;

                const { occurrence, participants = [] } = data;
                if (modalTitle) {
                    modalTitle.textContent = occurrence?.title || 'Occurrence Details';
                }

                if (modalMeta) {
                    modalMeta.innerHTML = `
                        <div class="reg-meta-item"><i class="fa-solid fa-calendar"></i>${formatDateTime(occurrence?.start)}</div>
                        <div class="reg-meta-item"><i class="fa-solid fa-clock"></i>${formatTimeRange(occurrence?.start, occurrence?.end)}</div>
                        <div class="reg-meta-item"><i class="fa-solid fa-location-dot"></i>${occurrence?.location || 'Location TBA'}</div>
                        <div class="reg-meta-item"><i class="fa-solid fa-users"></i>${occurrence?.registrationCount || 0}${occurrence?.capacity ? ' / ' + occurrence.capacity : ''} registered</div>
                    `;
                }

                if (modalParticipants && modalEmpty) {
                    modalParticipants.innerHTML = '';
                    if (!participants.length) {
                        modalEmpty.style.display = 'block';
                        if (modalCount) modalCount.textContent = '0 registered';
                    } else {
                        modalEmpty.style.display = 'none';
                        if (modalCount) modalCount.textContent = `${participants.length} registered`;
                        participants.forEach((p, idx) => {
                            const pill = computeStatus(p, occurrence);
                            const row = document.createElement('div');
                            row.className = 'reg-participant-row';
                            row.innerHTML = `
                                <div class="reg-participant-info">
                                    <div class="reg-participant-name">${p.name || 'Participant ' + (idx + 1)}</div>
                                    <div class="reg-participant-email">${p.email || ''}</div>
                                    <div class="reg-participant-meta">
                                        ${pill.label === 'Attended' ? `${p.surveyId
                                            ? `<a class="survey-badge" href="/surveys?filterSurveyID=${p.surveyId}">
                                                    <i class="fa-solid fa-check"></i>
                                                    Survey Complete
                                               </a>`
                                            : `<span class="survey-badge missing">
                                                    <i class="fa-solid fa-circle-xmark"></i>
                                                    Survey Missing
                                               </span>`}` : ''}
                                        <select class="reg-status-select" data-registration-id="${p.registrationId || ''}">
                                            <option value="registered:${p.attended ? 'true' : 'false'}" ${!p.attended && (p.status || '').toLowerCase() !== 'cancelled' ? 'selected' : ''}>${occurrence.isPast ? 'No Show' : 'Not Checked In'}</option>
                                            <option value="checkedin:true" ${p.checkInTime && !p.attended ? 'selected' : ''}>Checked In</option>
                                            <option value="attended:true" ${p.attended ? 'selected' : ''}>Attended</option>
                                            <option value="cancelled:false" ${(p.status || '').toLowerCase() === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                        </select>
                                        <button type="button" class="btn btn-outline-secondary btn-sm reg-remove" data-registration-id="${p.registrationId || ''}">Remove</button>
                                    </div>
                                </div>
                                <span class="status-pill ${pill.cls}">${pill.label}</span>
                            `;
                            modalParticipants.appendChild(row);
                        });
                    }
                }

                // Populate form fields
                if (inputDate) {
                    const start = occurrence?.start ? new Date(occurrence.start) : null;
                    if (start && !Number.isNaN(start.getTime())) {
                        const year = start.getFullYear();
                        const month = String(start.getMonth() + 1).padStart(2, '0');
                        const day = String(start.getDate()).padStart(2, '0');
                        inputDate.value = `${year}-${month}-${day}`;
                    } else {
                        inputDate.value = '';
                    }
                }
                if (inputStart) {
                    const start = occurrence?.start ? new Date(occurrence.start) : null;
                    if (start && !Number.isNaN(start.getTime())) {
                        const hh = String(start.getHours()).padStart(2, '0');
                        const mm = String(start.getMinutes()).padStart(2, '0');
                        inputStart.value = `${hh}:${mm}`;
                    } else {
                        inputStart.value = '';
                    }
                }
                if (inputEnd) {
                    const end = occurrence?.end ? new Date(occurrence.end) : null;
                    if (end && !Number.isNaN(end.getTime())) {
                        const hh = String(end.getHours()).padStart(2, '0');
                        const mm = String(end.getMinutes()).padStart(2, '0');
                        inputEnd.value = `${hh}:${mm}`;
                    } else {
                        inputEnd.value = '';
                    }
                }
                if (selectLocation) {
                    const loc = occurrence?.location || '';
                    if (loc && !Array.from(selectLocation.options).some(opt => opt.value === loc)) {
                        const opt = document.createElement('option');
                        opt.value = loc;
                        opt.textContent = loc;
                        selectLocation.appendChild(opt);
                    }
                    selectLocation.value = loc;
                }
            };

            if (toggle) {
                toggle.querySelectorAll('.toggle-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        toggle.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        applyFilter(btn.getAttribute('data-filter'));
                    });
                });
                applyFilter('future');
            }

            const openModal = () => {
                if (modalBackdrop) modalBackdrop.classList.add('active');
            };

            const closeModal = () => {
                if (modalBackdrop) modalBackdrop.classList.remove('active');
            };

            document.querySelectorAll('.details-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const occId = btn.getAttribute('data-occurrence-id');
                    renderModal(occId);
                    openModal();
                });
            });

            if (modalBackdrop) {
                modalBackdrop.addEventListener('click', (e) => {
                    if (e.target === modalBackdrop) {
                        closeModal();
                    }
                });
            }

            if (modalClose) {
                modalClose.addEventListener('click', closeModal);
            }

            // Participant search typeahead
            const hideResults = () => {
                if (searchResults) searchResults.style.display = 'none';
            };
            const showResults = () => {
                if (searchResults) searchResults.style.display = 'block';
            };

            if (searchInput) {
                searchInput.addEventListener('input', async () => {
                    const q = searchInput.value.trim();
                    activeSearchId = null;
                    if (!q || !searchResults) {
                        hideResults();
                        return;
                    }
                    try {
                        const res = await fetch(`/admin/participants/search?q=${encodeURIComponent(q)}`);
                        const data = await res.json();
                        if (!data.success) {
                            hideResults();
                            return;
                        }
                        searchResults.innerHTML = '';
                        data.results.forEach(item => {
                            const div = document.createElement('div');
                            div.className = 'result-item';
                            div.textContent = `${item.name} (#${item.participantId}) - ${item.email}`;
                            div.addEventListener('click', () => {
                                searchInput.value = `${item.name} (#${item.participantId})`;
                                activeSearchId = item.participantId;
                                hideResults();
                            });
                            searchResults.appendChild(div);
                        });
                        showResults();
                    } catch (err) {
                        console.error(err);
                        hideResults();
                    }
                });
            }

            document.addEventListener('click', (e) => {
                if (searchResults && !searchResults.contains(e.target) && e.target !== searchInput) {
                    hideResults();
                }
            });

            // Add participant
            if (modalAdd) {
                modalAdd.addEventListener('click', async () => {
                    if (!activeOccurrenceId) return;
                    if (!activeSearchId) {
                        alert('Select a participant first.');
                        return;
                    }
                    modalAdd.disabled = true;
                    modalAdd.textContent = 'Registering...';
                    try {
                        const res = await fetch(`/admin/occurrences/${activeOccurrenceId}/register-user`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ participantId: activeSearchId })
                        });
                        const data = await res.json();
                        if (!data.success) {
                            throw new Error(data.error || 'Registration failed');
                        }
                        // push to data
                        const record = data.registration;
                        if (adminOccurrenceData[activeOccurrenceId]) {
                            adminOccurrenceData[activeOccurrenceId].participants.push({
                                participantId: record.participantId,
                                registrationId: record.registrationId,
                                name: record.name,
                                email: record.email,
                                status: record.status,
                                attended: record.attended,
                                checkInTime: record.checkInTime,
                                surveyId: record.surveyId
                            });
                            adminOccurrenceData[activeOccurrenceId].occurrence.registrationCount += 1;
                        }
                        renderModal(activeOccurrenceId);
                        alert('Participant registered');
                    } catch (err) {
                        console.error(err);
                        alert(err.message || 'Error registering participant');
                    } finally {
                        modalAdd.disabled = false;
                        modalAdd.textContent = 'Register Participant';
                    }
                });
            }

            // Save changes (update occurrence)
            if (modalSave) {
                modalSave.addEventListener('click', async () => {
                    if (!activeOccurrenceId) return;
                    const date = inputDate?.value || '';
                    const startTime = inputStart?.value || '';
                    const endTime = inputEnd?.value || '';
                    const location = selectLocation?.value || '';

                    if (!date || !startTime) {
                        alert('Date and start time are required.');
                        return;
                    }

                    modalSave.disabled = true;
                    modalSave.textContent = 'Saving...';
                    try {
                        const res = await fetch(`/occurrences/${activeOccurrenceId}/update`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ date, startTime, endTime, location })
                        });
                        const data = await res.json();
                        if (!data.success) {
                            throw new Error(data.error || 'Update failed');
                        }

                        // Update local data
                        const updated = adminOccurrenceData[activeOccurrenceId];
                        if (updated) {
                            updated.occurrence.start = data.occurrence.EventDateTimeStart;
                            updated.occurrence.end = data.occurrence.EventDateTimeEnd;
                            updated.occurrence.location = data.occurrence.EventLocation;
                        }

                        // Update card display
                        const card = document.querySelector(`.occurrence-card[data-occurrence-id="${activeOccurrenceId}"]`);
                        if (card) {
                            const dateEl = card.querySelector('.occurrence-date');
                            const timeEl = card.querySelector('.occurrence-time');
                            const locEl = card.querySelector('.occurrence-detail-item span');
                            const startDate = new Date(data.occurrence.EventDateTimeStart);
                            const endDate = data.occurrence.EventDateTimeEnd ? new Date(data.occurrence.EventDateTimeEnd) : null;
                            const isToday = startDate.toDateString() === new Date().toDateString();
                            const isThisYear = startDate.getFullYear() === new Date().getFullYear();
                            if (dateEl) {
                                dateEl.textContent = isToday
                                    ? 'Today'
                                    : startDate.toLocaleDateString('en-US', isThisYear
                                        ? { weekday: 'short', month: 'short', day: 'numeric' }
                                        : { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
                            }
                            if (timeEl) {
                                const startStr = startDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
                                const endStr = endDate && !Number.isNaN(endDate.getTime())
                                    ? endDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })
                                    : null;
                                timeEl.innerHTML = `<i class="fa-solid fa-clock"></i> ${startStr}${endStr ? ' - ' + endStr : ''}`;
                            }
                            if (locEl) {
                                locEl.textContent = data.occurrence.EventLocation || 'Location TBA';
                            }
                        }

                        renderModal(activeOccurrenceId);
                        alert('Occurrence updated');
                    } catch (err) {
                        console.error(err);
                        alert(err.message || 'Error updating occurrence');
                    } finally {
                        modalSave.disabled = false;
                        modalSave.textContent = 'Save Changes';
                    }
                });
            }

            // Status change + removal
            if (modalParticipants) {
                modalParticipants.addEventListener('change', async (e) => {
                    const target = e.target;
                    if (!(target instanceof HTMLSelectElement)) return;
                    if (!target.classList.contains('reg-status-select')) return;
                    const registrationId = target.getAttribute('data-registration-id');
                    if (!registrationId) return;
                    const value = target.value || '';
                    const [statusKey, attendedVal] = value.split(':');
                    const attended = attendedVal === 'true';
                    let status = 'Registered';
                    if (statusKey === 'cancelled') status = 'Cancelled';
                    if (statusKey === 'checkedin') status = 'Registered';
                    if (statusKey === 'attended') status = 'Registered';
                    if (statusKey === 'registered' && attended) status = 'Registered';

                    try {
                        const res = await fetch(`/admin/registrations/${registrationId}/update-status`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ status, attended })
                        });
                        const data = await res.json();
                        if (!data.success) {
                            throw new Error(data.error || 'Update failed');
                        }
                        renderModal(activeOccurrenceId);
                    } catch (err) {
                        console.error(err);
                        alert(err.message || 'Error updating status');
                    }
                });

                modalParticipants.addEventListener('click', async (e) => {
                    const btn = e.target.closest('.reg-remove');
                    if (!btn) return;
                    const registrationId = btn.getAttribute('data-registration-id');
                    if (!registrationId) return;
                    const confirmed = confirm('Remove this participant from the occurrence?');
                    if (!confirmed) return;
                    btn.disabled = true;
                    try {
                        const res = await fetch(`/admin/registrations/${registrationId}/delete`, { method: 'POST' });
                        const data = await res.json();
                        if (!data.success) {
                            throw new Error(data.error || 'Delete failed');
                        }
                        if (adminOccurrenceData[activeOccurrenceId]) {
                            adminOccurrenceData[activeOccurrenceId].participants = adminOccurrenceData[activeOccurrenceId].participants.filter(p => String(p.registrationId) !== String(registrationId));
                            if (adminOccurrenceData[activeOccurrenceId].occurrence.registrationCount > 0) {
                                adminOccurrenceData[activeOccurrenceId].occurrence.registrationCount -= 1;
                            }
                        }
                        renderModal(activeOccurrenceId);
                    } catch (err) {
                        console.error(err);
                        alert(err.message || 'Error removing participant');
                    } finally {
                        btn.disabled = false;
                    }
                });
            }

            // Delete occurrence
            if (modalDelete) {
                modalDelete.addEventListener('click', async () => {
                    if (!activeOccurrenceId) return;
                    const confirmed = confirm('Are you sure you want to delete this event?');
                    if (!confirmed) return;

                    modalDelete.disabled = true;
                    modalDelete.textContent = 'Deleting...';
                    try {
                        const res = await fetch(`/occurrences/${activeOccurrenceId}/delete`, { method: 'POST' });
                        const data = await res.json();
                        if (!data.success) {
                            throw new Error(data.error || 'Delete failed');
                        }

                        // Remove card
                        const card = document.querySelector(`.occurrence-card[data-occurrence-id="${activeOccurrenceId}"]`);
                        if (card && card.parentElement) {
                            card.parentElement.removeChild(card);
                        }
                        delete adminOccurrenceData[activeOccurrenceId];
                        closeModal();
                        if (modalRoot) modalRoot.classList.remove('reg-editing');
                        isEditing = false;
                    } catch (err) {
                        console.error(err);
                        alert(err.message || 'Error deleting occurrence');
                    } finally {
                        modalDelete.disabled = false;
                        modalDelete.textContent = 'Delete';
                    }
                });
            }
        }

        // Handle register/unregister toggle
        document.querySelectorAll('.register-toggle-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                const occurrenceId = this.getAttribute('data-occurrence-id');
                const isRegistered = this.getAttribute('data-is-registered') === 'true';
                const originalText = this.textContent;
                
                // Disable button during request
                this.disabled = true;
                this.textContent = 'Processing...';

                try {
                    const endpoint = isRegistered ? '/unregister-occurrence' : '/register-occurrence';
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ occurrenceId: parseInt(occurrenceId, 10) })
                    });

                    const data = await response.json();

                    if (data.success) {
                        // Toggle button state
                        const newIsRegistered = !isRegistered;
                        this.setAttribute('data-is-registered', newIsRegistered);
                        this.textContent = newIsRegistered ? 'Unregister' : 'Register';
                        this.className = newIsRegistered ? 'btn btn-secondary register-toggle-btn' : 'btn btn-primary register-toggle-btn';
                        
                        // Show success message (optional - you can add a toast notification here)
                        console.log(data.message);
                    } else {
                        alert(data.error || 'An error occurred');
                        this.textContent = originalText;
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('An error occurred. Please try again.');
                    this.textContent = originalText;
                } finally {
                    this.disabled = false;
                }
            });
        });
    });
</script>

<div class="reg-modal-backdrop">
    <div class="reg-modal">
        <div class="reg-modal-header">
            <h3 id="regModalTitle">Occurrence Details</h3>
            <button type="button" class="reg-modal-close" aria-label="Close">&times;</button>
        </div>
        <div class="reg-modal-body">
            <div class="reg-modal-meta" id="regModalMeta"></div>
            <div class="reg-participants-card">
                <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center">
                    <h4 style="margin: 0;">Participants</h4>
                    <div class="reg-participant-actions">
                        <input type="text" id="regParticipantSearch" class="form-control reg-participant-search" placeholder="Search participants..." autocomplete="off">
                        <div class="reg-search-results" id="regParticipantResults"></div>
                        <button type="button" class="btn btn-secondary" id="regModalAddBtn">Register Participant</button>
                    </div>
                </div>
                <div class="reg-participants-list" id="regModalParticipants"></div>
                <p class="reg-empty" id="regModalEmpty" style="display: none;">No participants registered yet.</p>
            </div>
            <div class="reg-form">
                <div class="reg-form-row">
                    <div class="reg-form-group">
                        <label for="regEditDate">Date</label>
                        <input type="date" id="regEditDate" class="form-control">
                    </div>
                    <div class="reg-form-group">
                        <label for="regEditStart">Start Time</label>
                        <input type="time" id="regEditStart" class="form-control">
                    </div>
                    <div class="reg-form-group">
                        <label for="regEditEnd">End Time</label>
                        <input type="time" id="regEditEnd" class="form-control">
                    </div>
                </div>
                <div class="reg-form-group">
                    <label for="regEditLocation">Location</label>
                    <select id="regEditLocation" class="form-control"></select>
                </div>
            </div>
            <div class="reg-modal-footer">
                <button type="button" class="btn btn-secondary" id="regModalSaveBtn">Save Changes</button>
                <button type="button" class="btn btn-primary" id="regModalDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>
