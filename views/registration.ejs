<div class="registration-page">
    <div class="container-fluid">
        <div class="row justify-content-center">
            <!-- <div class="col-lg-11 col-xl-10"> -->
            <div class="col-12">
                <div class="registration-back">
                    <a class="btn-back" href="/events">
                        <i class="fa-solid fa-arrow-left"></i>
                        Back to Events
                    </a>
                </div>
                <div class="registration-card">
                    <div class="registration-header">
                        <div class="registration-image">
                            <% const imageSrc = `/images/events/event_${eventTemplate.EventID}.jpg`; %>
                            <img src="<%- imageSrc %>" 
                                 alt="<%= eventTemplate.EventName %>" 
                                 onerror="this.src='/images/events/event_0_real.png'">
                        </div>
                        <div class="registration-header-content">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h1 class="registration-title mb-0"><%= eventTemplate.EventName %></h1>
                                <% if (typeof isAdmin !== 'undefined' && isAdmin) { %>
                                    <button type="button" class="btn btn-secondary delete-event-template-btn" id="deleteEventBtn" data-event-id="<%= eventTemplate.EventID %>" data-event-name="<%= eventTemplate.EventName %>">
                                        Delete Event Template
                                    </button>
                                <% } %>
                            </div>
                            <div class="event-details">
                                <% if (eventTemplate.EventDescription) { %>
                            <div class="event-description">
                                <p><%= eventTemplate.EventDescription %></p>
                            </div>
                        <% } %>
                        <div class="event-labels">
                            <% 
                                const eventType = eventTemplate.EventType || '';
                                let typeIcon = 'fa-tag';
                                let typeColor = '#6B6F6B';
                                if (eventType === 'STEM') {
                                    typeIcon = 'fa-gear';
                                    typeColor = '#99B7C6';
                                } else if (eventType === 'Arts') {
                                    typeIcon = 'fa-paintbrush';
                                    typeColor = '#F4B092';
                                } else if (eventType === 'Leadership') {
                                    typeIcon = 'fa-users';
                                    typeColor = '#9AB59D';
                                } else if (eventType === 'Annual Conference') {
                                    typeIcon = 'fa-calendar-star';
                                    typeColor = '#978EC4';
                                }
                                
                                const recurrence = eventTemplate.EventRecurrencePattern || '';
                                let recurIcon = 'fa-calendar';
                                let recurColor = '#6B6F6B';
                                if (recurrence === 'Monthly') {
                                    recurIcon = 'fa-calendar-days';
                                    recurColor = '#99B7C6';
                                } else if (recurrence === 'Weekly') {
                                    recurIcon = 'fa-calendar-week';
                                    recurColor = '#978EC4';
                                } else if (recurrence === 'Annual') {
                                    recurIcon = 'fa-calendar-check';
                                    recurColor = '#9AB59D';
                                }
                            %>
                            <% if (eventType) { %>
                                <span class="event-label event-label-type-<%= eventType.toLowerCase().replace(/\s+/g, '-') %>">
                                    <i class="fa-solid <%= typeIcon %>"></i>
                                    <%= eventType %>
                                </span>
                            <% } %>
                            <% if (recurrence) { %>
                                <span class="event-label event-label-recurrence-<%= recurrence.toLowerCase() %>">
                                    <i class="fa-solid <%= recurIcon %>"></i>
                                    <%= recurrence %>
                                </span>
                            <% } %>
                        </div>
                       
                            </div>
                            <div class="occurrences-section">
                                <h2><%= typeof isAdmin !== 'undefined' && isAdmin ? 'All Sessions' : 'Available Sessions' %></h2>
                                <% if (typeof isAdmin !== 'undefined' && isAdmin) { %>
                                    <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between mb-3">
                                        <div class="occurrence-toggle" id="occurrence-toggle">
                                            <button type="button" class="toggle-btn active" data-filter="upcoming">Upcoming</button>
                                            <button type="button" class="toggle-btn" data-filter="past">Past</button>
                                        </div>
                                        <button type="button" class="btn btn-primary" id="createEventBtn">
                                            <i class="fa-solid fa-plus"></i> Create Event
                                        </button>
                                    </div>
                                <% } %>
                                <% if (occurrences && occurrences.length > 0) { %>
                                    <div class="occurrences-list-container">
                                        <div class="occurrences-list">
                                        <% occurrences.forEach(occurrence => { %>
                                            <% const isRegistered = typeof registeredOccurrenceIds !== 'undefined' && registeredOccurrenceIds.includes(occurrence.OccurrenceID); %>
                                            <% const isPast = typeof occurrence.isPast !== 'undefined' && occurrence.isPast; %>
                                            <% const isFull = typeof occurrence.isFull !== 'undefined' && occurrence.isFull; %>
                                            <% const disableRegister = isFull && !isRegistered; %>
                                            <div class="occurrence-card <%= typeof focusedOccurrenceId !== 'undefined' && focusedOccurrenceId === occurrence.OccurrenceID ? 'occurrence-focused' : '' %> <%= isPast ? 'occurrence-past' : '' %>" 
                                                id="<%= typeof focusedOccurrenceId !== 'undefined' && focusedOccurrenceId === occurrence.OccurrenceID ? 'focused-occurrence' : '' %>"
                                                data-occurrence-id="<%= occurrence.OccurrenceID %>"
                                                data-is-past="<%= isPast %>">
                                           
                                               <div class="occurrence-info">
                                                   <div class="occurrence-main-row">
                                                       <!-- LEFT: date, time, status -->
                                                       <div class="occurrence-date-time">
                                                           <div class="occurrence-date">
                                                               <% 
                                                                   const d = new Date(occurrence.EventDateTimeStart);
                                                                   const isToday = d.toDateString() === new Date().toDateString();
                                                                    const isThisYear = d.getFullYear() === new Date().getFullYear();
                                                                %>
                                                               <%= isToday
                                                                   ? 'Today'
                                                                   : d.toLocaleDateString(
                                                                       'en-US',
                                                                       isThisYear
                                                                           ? { weekday: 'short', month: 'short', day: 'numeric' }
                                                                           : { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' }
                                                                   )
                                                               %>
                                                           </div>
                                           
                                                           <div class="occurrence-time">
                                                               <i class="fa-solid fa-clock"></i>
                                                               <%= new Date(occurrence.EventDateTimeStart).toLocaleTimeString('en-US', { 
                                                                   hour: 'numeric', 
                                                                   minute: '2-digit',
                                                                   hour12: true 
                                                               }) %>
                                                               <% if (occurrence.EventDateTimeEnd) { %>
                                                                   - <%= new Date(occurrence.EventDateTimeEnd).toLocaleTimeString('en-US', { 
                                                                       hour: 'numeric', 
                                                                       minute: '2-digit',
                                                                       hour12: true 
                                                                   }) %>
                                                               <% } %>
                                                           </div>
                                           
                                                           <% if (!isPast) { %>
                                                               <span class="status-badge <%= occurrence.isFull ? 'status-full' : 'status-available' %>">
                                                                   <i class="fa-solid fa-users"></i>
                                                                   <%= occurrence.isFull ? 'Full' : 'Space Available' %>
                                                               </span>
                                                           <% } else if (typeof isAdmin !== 'undefined' && isAdmin) { %>
                                                               <span class="status-badge status-past">
                                                                   <i class="fa-solid fa-clock"></i>
                                                                   Past
                                                               </span>
                                                           <% } %>
                                                       </div>
                                           
                                                       <!-- MIDDLE: location, capacity, attended -->
                                                       <div class="occurrence-details-row">
                                                           <% if (occurrence.EventLocation) { %>
                                                               <div class="occurrence-detail-item">
                                                                   <i class="fa-solid fa-location-dot"></i>
                                                                   <span><%= occurrence.EventLocation %></span>
                                                               </div>
                                                           <% } %>
                                                           <% if (occurrence.EventCapacity) { %>
                                                               <div class="occurrence-detail-item">
                                                                   <i class="fa-solid fa-users"></i>
                                                                   <span><%= occurrence.EventCapacity - occurrence.registrationCount %> slots left</span>
                                                               </div>
                                                           <% } %>
                                                           <% if (isPast && typeof isAdmin !== 'undefined' && isAdmin && typeof occurrence.attendanceCount !== 'undefined') { %>
                                                               <div class="occurrence-detail-item">
                                                                   <i class="fa-solid fa-check-circle"></i>
                                                                   <span><%= occurrence.attendanceCount %> attended</span>
                                                               </div>
                                                           <% } %>
                                                       </div>
                                                   </div>
                                               </div>
                                           
                                               <% if (typeof isAdmin !== 'undefined' && isAdmin) { %>
                                                   <button type="button" class="btn btn-secondary details-btn" data-occurrence-id="<%= occurrence.OccurrenceID %>">
                                                       Details
                                                   </button>
                                               <% } else if (typeof user !== 'undefined' && user && !isPast) { %>
                                                   <button type="button" 
                                                           class="btn register-toggle-btn <%= disableRegister ? 'btn-disabled' : (isRegistered ? 'btn-secondary' : 'btn-primary') %>"
                                                           data-occurrence-id="<%= occurrence.OccurrenceID %>"
                                                           data-is-registered="<%= isRegistered %>"
                                                           data-is-full="<%= isFull %>"
                                                           <%= disableRegister ? 'disabled aria-disabled=\"true\"' : '' %>>
                                                       <%= disableRegister ? 'Full' : (isRegistered ? 'Unregister' : 'Register') %>
                                                   </button>
                                               <% } else if (!isPast && (typeof isAdmin === 'undefined' || !isAdmin)) { %>
                                                   <a href="/login?redirect=/registration/<%= eventTemplate.EventID %>" class="btn btn-primary">
                                                       Login to Register
                                                   </a>
                                               <% } %>
                                           </div>
                                           
                                        <% }); %>
                                        </div>
                                        
                                    </div>
                                   
                                <% } else { %>
                                    <div class="no-occurrences">
                                        <p>No upcoming sessions available for this event at this time.</p>
                                    </div>
                                <% } %>
                            </div>
                        </div>
                    </div>

                    

                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Event Confirmation Modal -->
<% if (typeof isAdmin !== 'undefined' && isAdmin) { %>
<div class="modal fade" id="deleteEventModal" tabindex="-1" aria-labelledby="deleteEventModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteEventModalLabel">Delete Event</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the event "<span id="deleteEventName"></span>"?</p>
                <p class="text-danger"><strong>Warning:</strong> This will delete the event template and all associated occurrences and registrations. This action cannot be undone.</p>
                <form id="deleteEventForm" method="POST" action="/events/delete">
                    <input type="hidden" name="_csrf" value="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">
                    <input type="hidden" name="eventId" id="deleteEventId">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="deleteEventForm" class="btn btn-danger">Delete Event</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Handle delete event button click
    document.addEventListener('DOMContentLoaded', function() {
        const deleteEventBtn = document.getElementById('deleteEventBtn');
        const deleteEventModalElement = document.getElementById('deleteEventModal');
        
        if (deleteEventBtn && deleteEventModalElement) {
            const deleteEventModal = new bootstrap.Modal(deleteEventModalElement, {
                backdrop: true,
                keyboard: true
            });
            const deleteEventName = document.getElementById('deleteEventName');
            const deleteEventId = document.getElementById('deleteEventId');
            
            deleteEventBtn.addEventListener('click', function() {
                const eventId = this.getAttribute('data-event-id');
                const eventName = this.getAttribute('data-event-name');
                
                deleteEventId.value = eventId;
                deleteEventName.textContent = eventName;
                deleteEventModal.show();
            });
            
            // Ensure backdrop is removed when modal is hidden
            deleteEventModalElement.addEventListener('hidden.bs.modal', function() {
                // Remove any lingering backdrop
                const backdrops = document.querySelectorAll('.modal-backdrop');
                backdrops.forEach(backdrop => backdrop.remove());
                // Remove modal-open class from body
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
            });
        }
    });
</script>
<% } %>

<div class="reg-confirm-backdrop" id="regConfirmBackdrop" aria-modal="true" role="dialog">
    <div class="reg-confirm-modal">
        <h4 style="margin: 0;">Confirm Delete</h4>
        <p id="regConfirmMessage" style="margin: 0;">Are you sure?</p>
        <div class="reg-confirm-actions">
            <button type="button" class="btn btn-outline-secondary" id="regConfirmNo">Cancel</button>
            <button type="button" class="btn btn-danger" id="regConfirmYes">Delete</button>
        </div>
    </div>
</div>

<style>
.registration-card {
}

.registration-back {
    max-width: 1400px;     /* match .registration-card */
    margin: 0 auto 1rem;   /* center & add space below */
    padding: 0 0.5rem;     /* small horizontal padding (optional) */
}

.registration-back .btn-back {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    background: #978EC4;
    color: white;
    border: none;
    border-radius: 999px;
    padding: 0.45rem 0.9rem;
    font-weight: 700;
    text-decoration: none;
    box-shadow: 0 6px 16px rgba(151, 142, 196, 0.35);
}

.registration-back .btn-back:hover {
    background: #897FB8;
    color: white;
}

.reg-modal {
    max-width: 640px;
    width: 92%;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.reg-modal-body {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    overflow-y: auto;
}

.reg-modal-meta {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 0.75rem;
}

.reg-meta-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #4B4F4B;
    font-family: 'Montserrat', sans-serif;
    font-size: 0.95rem;
}

.reg-meta-item i {
    color: #978EC4;
}

.reg-participants-card {
    background: #F9F5EA;
    border: 1px solid #E6E0D4;
    border-radius: 12px;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.reg-participant-head {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.75rem;
}

.reg-participants-list {
    max-height: 260px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.reg-participant-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.75rem;
    padding: 0.75rem 0.9rem;
    background: white;
    border: 1px solid #E6E0D4;
    border-radius: 10px;
    min-height: 86px;
}

.reg-participant-left,
.reg-participant-main,
.reg-participant-right {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
}

.reg-participant-left {
    flex: 0 0 auto;
    align-items: center;
    justify-content: center;
}

.reg-participant-main {
    flex: 1 1 auto;
}

.reg-participant-right {
    flex: 0 0 auto;
    align-items: flex-end;
    gap: 0.5rem;
    min-height: 70px;
    justify-content: flex-start;
}

.reg-participant-right.no-survey {
    justify-content: center;
}

.reg-participant-info {
    display: flex;
    flex-direction: column;
    gap: 0.15rem;
}

.reg-participant-name {
    font-weight: 700;
    color: #3A3F3B;
}

.reg-participant-meta {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    flex-wrap: wrap;
}

.survey-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.25rem 0.7rem;
    border-radius: 999px;
    font-size: 0.85rem;
    font-weight: 700;
    background: #978EC4;
    color: white;
    cursor: pointer;
    text-decoration: none;
}

.survey-badge.missing {
    background: #D8D8D8;
    color: #3A3F3B;
    cursor: default;
}
.reg-participant-email {
    font-size: 0.9rem;
    color: #5A5E5A;
    word-break: break-all;
}

.reg-participant-actions {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: nowrap;
    position: relative;
}

.reg-participant-search {
    min-width: 220px;
}

.reg-search-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #E6E0D4;
    border-radius: 8px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.12);
    z-index: 10;
    display: none;
    max-height: 220px;
    overflow-y: auto;
}

.reg-search-results .result-item {
    padding: 0.5rem 0.75rem;
    cursor: pointer;
}

.reg-search-results .result-item:hover {
    background: #F0F0F0;
}

.reg-empty {
    margin: 0;
    font-style: italic;
    color: #6B6F6B;
}

.reg-form {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.reg-form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 0.75rem;
}

.reg-form-group label {
    font-weight: 600;
    color: #3A3F3B;
    margin-bottom: 0.35rem;
    display: block;
}

.reg-form-group .form-control,
.reg-form-group select {
    width: 100%;
}

.reg-modal-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 0.75rem;
}

.status-pill {
    padding: 0.35rem 0.9rem;
    border-radius: 999px;
    font-size: 0.85rem;
    font-weight: 700;
    font-family: 'Montserrat', sans-serif;
    white-space: nowrap;
}

.status-pill--good {
    background: #9AB59D;
    color: white;
}

.status-pill--neutral {
    background: #D8D8D8;
    color: #3A3F3B;
}

.status-pill--bad {
    background: #CE325B;
    color: white;
}

.reg-edit-region .reg-editable {
    display: none;
}

.reg-edit-region.reg-editing .reg-editable {
    display: block;
}

.reg-edit-buttons,
.reg-edit-actions {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.reg-edit-buttons {
    margin-left: auto;
}

.btn-lavender {
    background: #978EC4;
    border: 1px solid #978EC4;
    color: white;
}

.btn-lavender:hover {
    background: #897FB8;
    border-color: #897FB8;
    color: white;
}

.reg-toast {
    display: none;
    align-items: center;
    gap: 0.4rem;
    background: #9AB59D;
    color: white;
    padding: 0.45rem 0.75rem;
    border-radius: 999px;
    font-weight: 700;
    font-size: 0.9rem;
    white-space: nowrap;
    min-height: 36px;
}

.reg-toast.active {
    display: inline-flex;
}

.reg-confirm-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.3);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2000;
}

.reg-confirm-backdrop.active {
    display: flex;
}

.reg-confirm-modal {
    background: white;
    border-radius: 12px;
    padding: 1.2rem 1.4rem;
    box-shadow: 0 16px 40px rgba(0,0,0,0.18);
    max-width: 420px;
    width: 90%;
    display: flex;
    flex-direction: column;
    gap: 0.9rem;
}

.reg-confirm-actions {
    display: flex;
    justify-content: flex-end;
    gap: 0.6rem;
}

.reg-edit-region.reg-editing #regModalEditBtn {
    display: none;
}

.reg-edit-region .reg-form {
    margin-bottom: 0.75rem;
}

.reg-edit-region .reg-form-group:last-child {
    margin-bottom: 0.5rem;
}

@media (max-width: 640px) {
    .reg-modal {
        max-height: 92vh;
    }
    .reg-modal-body {
        max-height: calc(92vh - 80px);
    }
    .reg-participant-actions {
        flex-wrap: wrap;
    }
    .reg-participant-search {
        flex: 1 1 100%;
        min-width: 0;
    }
    .reg-participant-actions .btn {
        width: 100%;
    }
    .reg-participant-email {
        display: none;
    }
}
.reg-remove-icon {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: 1px solid #E6E0D4;
    background: #FDF2F2;
    color: #D14343;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background 0.15s ease, transform 0.15s ease;
}

.reg-remove-icon:hover {
    background: #FBE3E3;
    transform: translateY(-1px);
}

.reg-status-trigger {
    min-width: 140px;
    border-radius: 999px;
    border: 1px solid #D0D0D0;
    background: #F7F7F7;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.4rem;
    padding: 0.35rem 0.8rem;
    cursor: pointer;
    position: relative;
    transition: background 0.15s ease, transform 0.15s ease;
    font-weight: 700;
}

.reg-status-trigger:hover {
    background: #EFEFEF;
    transform: translateY(-1px);
}

.reg-status-trigger.status-pill--good {
    border-color: #9AB59D;
    background: #F2F7F3;
    color: #3D6643;
}

.reg-status-trigger.status-pill--neutral {
    border-color: #D0D0D0;
    background: #F7F7F7;
    color: #4B4F4B;
}

.reg-status-trigger.status-pill--bad {
    border-color: #CE325B;
    background: #FDF2F6;
    color: #8F1D3C;
}

.reg-status-menu {
    display: none;
    position: absolute;
    top: calc(100% + 6px);
    right: 0;
    min-width: 180px;
    background: white;
    border: 1px solid #E6E0D4;
    border-radius: 10px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.14);
    z-index: 20;
    padding: 0.35rem;
}

.reg-status-menu.active {
    display: block;
}

.reg-status-option {
    width: 100%;
    border: none;
    background: transparent;
    padding: 0.45rem 0.6rem;
    border-radius: 8px;
    text-align: left;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    color: #3A3F3B;
}

.reg-status-option:hover {
    background: #F2F2F2;
}

.create-event-header {
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #F0F0F0;
}

.create-event-header h4 {
    font-family: 'DM Serif Display', serif;
    font-size: 1.5rem;
    color: #3A3F3B;
    margin-bottom: 0.75rem;
}

.create-event-header .event-labels {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
}

</style>

<script>
    // Scroll to focused occurrence on page load
    document.addEventListener('DOMContentLoaded', function() {
        const isAdminView = <%= typeof isAdmin !== 'undefined' && isAdmin ? 'true' : 'false' %>;
        const adminOccurrenceData = isAdminView ? <%- JSON.stringify(typeof adminOccurrenceData !== 'undefined' ? adminOccurrenceData : {}) %> : {};
        const locationOptions = isAdminView ? <%- JSON.stringify(typeof locationOptions !== 'undefined' ? locationOptions : []) %> : [];
        const focusedOccurrence = document.getElementById('focused-occurrence');
        if (focusedOccurrence) {
            setTimeout(() => {
                focusedOccurrence.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        }

        // Admin toggle for past/future
        if (isAdminView) {
            const toggle = document.getElementById('occurrence-toggle');
            const cards = Array.from(document.querySelectorAll('.occurrence-card'));
            const modalBackdrop = document.querySelector('.reg-modal-backdrop');
            const modalClose = document.querySelector('.reg-modal-close');
            const modalTitle = document.getElementById('regModalTitle');
            const modalMeta = document.getElementById('regModalMeta');
            const modalParticipants = document.getElementById('regModalParticipants');
            const modalEmpty = document.getElementById('regModalEmpty');
            const modalCount = document.getElementById('regModalParticipantCount');
            const modalSave = document.getElementById('regModalSaveBtn');
            const modalCancel = document.getElementById('regModalCancelBtn');
            const modalDelete = document.getElementById('regModalDeleteBtn');
            const modalAdd = document.getElementById('regModalAddBtn');
            const modalEdit = document.getElementById('regModalEditBtn');
            const modalRoot = document.querySelector('.reg-modal');
            const regEditRegion = document.getElementById('regEditRegion');
            const toastEl = document.getElementById('regModalToast');
            const confirmBackdrop = document.getElementById('regConfirmBackdrop');
            const confirmMessage = document.getElementById('regConfirmMessage');
            const confirmYes = document.getElementById('regConfirmYes');
            const confirmNo = document.getElementById('regConfirmNo');
            const searchInput = document.getElementById('regParticipantSearch');
            const searchResults = document.getElementById('regParticipantResults');
            const inputDate = document.getElementById('regEditDate');
            const inputStart = document.getElementById('regEditStart');
            const inputEnd = document.getElementById('regEditEnd');
            const selectLocation = document.getElementById('regEditLocation');
            let activeOccurrenceId = null;
            let activeSearchId = null;
            let openStatusMenuId = null;
            let isEditing = false;
            let confirmResolver = null;

            const setEditing = (state) => {
                isEditing = !!state;
                if (regEditRegion) {
                    regEditRegion.classList.toggle('reg-editing', isEditing);
                }
            };
            setEditing(false);

            const hideToast = () => {
                if (toastEl) toastEl.classList.remove('active');
            };

            const showToast = (message) => {
                if (!toastEl) return;
                toastEl.textContent = message;
                toastEl.classList.add('active');
                setTimeout(() => hideToast(), 2500);
            };

            const openConfirm = (message) => {
                if (!confirmBackdrop || !confirmMessage) {
                    return Promise.resolve(confirm('Are you sure?'));
                }
                confirmMessage.textContent = message || 'Are you sure?';
                confirmBackdrop.classList.add('active');
                return new Promise((resolve) => {
                    confirmResolver = resolve;
                });
            };

            const closeConfirm = (result) => {
                if (confirmBackdrop) confirmBackdrop.classList.remove('active');
                if (confirmResolver) {
                    confirmResolver(result);
                    confirmResolver = null;
                }
            };

            // Populate location dropdown
            if (selectLocation) {
                selectLocation.innerHTML = '';
                const defaultOpt = document.createElement('option');
                defaultOpt.value = '';
                defaultOpt.textContent = 'Select a location';
                selectLocation.appendChild(defaultOpt);
                locationOptions.forEach(loc => {
                    const opt = document.createElement('option');
                    opt.value = loc;
                    opt.textContent = loc;
                    selectLocation.appendChild(opt);
                });
            }

            const applyFilter = (filter) => {
                cards.forEach(card => {
                    const cardIsPast = card.getAttribute('data-is-past') === 'true';
                    const showCard = filter === 'past' ? cardIsPast : !cardIsPast;
                    card.style.display = showCard ? '' : 'none';
                });
            };

            const formatDateTime = (value) => {
                if (!value) return 'Date TBD';
                const d = new Date(value);
                if (Number.isNaN(d.getTime())) return 'Date TBD';
                return d.toLocaleString('en-US', {
                    weekday: 'short',
                    month: 'short',
                    day: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                });
            };

            const formatTimeRange = (start, end) => {
                if (!start) return 'Time TBD';
                const startDate = new Date(start);
                const endDate = end ? new Date(end) : null;
                const startStr = startDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
                const endStr = endDate && !Number.isNaN(endDate.getTime())
                    ? endDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })
                    : null;
                return endStr ? `${startStr} - ${endStr}` : startStr;
            };

            const computeStatus = (participant, occurrence) => {
                const isPast = !!occurrence?.isPast;
                const cancelled = (participant.status || '').toLowerCase() === 'cancelled';
                const checkedIn = !!(participant.checkInTime || participant.attended);

                if (isPast) {
                    if (participant.attended) return { label: 'Attended', cls: 'status-pill--good' };
                    if (cancelled) return { label: 'Cancelled', cls: 'status-pill--neutral' };
                    return { label: 'No Show', cls: 'status-pill--bad' };
                }

                return checkedIn
                    ? { label: 'Checked In', cls: 'status-pill--good' }
                    : { label: 'Not Checked In', cls: 'status-pill--neutral' };
            };

            const statusOptionsFor = (participant, occurrence) => {
                const defaultLabel = occurrence?.isPast ? 'No Show' : 'Not Checked In';
                const opts = [
                    { value: 'registered:false', label: defaultLabel, icon: 'fa-user-clock' },
                    { value: 'checkedin:true', label: 'Checked In', icon: 'fa-person-walking' },
                    { value: 'attended:true', label: 'Attended', icon: 'fa-user-check' },
                    { value: 'cancelled:false', label: 'Cancelled', icon: 'fa-ban' }
                ];
                return occurrence?.isPast ? opts.filter(opt => opt.value !== 'checkedin:true') : opts;
            };

            const renderModal = (occurrenceId) => {
                const data = adminOccurrenceData[occurrenceId];
                if (!data || !modalBackdrop) return;
                activeOccurrenceId = occurrenceId;
                setEditing(false);
                hideToast();

                const { occurrence, participants = [] } = data;
                if (modalTitle) {
                    modalTitle.textContent = occurrence?.title || 'Occurrence Details';
                }

                if (modalMeta) {
                    modalMeta.innerHTML = `
                        <div class="reg-meta-item"><i class="fa-solid fa-calendar"></i>${formatDateTime(occurrence?.start)}</div>
                        <div class="reg-meta-item"><i class="fa-solid fa-clock"></i>${formatTimeRange(occurrence?.start, occurrence?.end)}</div>
                        <div class="reg-meta-item"><i class="fa-solid fa-location-dot"></i>${occurrence?.location || 'Location TBA'}</div>
                        <div class="reg-meta-item"><i class="fa-solid fa-users"></i>${occurrence?.registrationCount || 0}${occurrence?.capacity ? ' / ' + occurrence.capacity : ''} registered</div>
                    `;
                }

                if (modalParticipants && modalEmpty) {
                    modalParticipants.innerHTML = '';
                    if (!participants.length) {
                        modalEmpty.style.display = 'block';
                        if (modalCount) modalCount.textContent = '0 registered';
                    } else {
                        modalEmpty.style.display = 'none';
                        if (modalCount) modalCount.textContent = `${participants.length} registered`;
                        participants.forEach((p, idx) => {
                            const pill = computeStatus(p, occurrence);
                            const statusOptions = statusOptionsFor(p, occurrence);
                            const row = document.createElement('div');
                            row.className = 'reg-participant-row';
                            row.innerHTML = `
                                <div class="reg-participant-left">
                                    <button type="button" class="reg-remove reg-remove-icon" data-registration-id="${p.registrationId || ''}" aria-label="Remove ${p.name || 'participant'}">
                                        <i class="fa-solid fa-xmark"></i>
                                    </button>
                                </div>
                                <div class="reg-participant-main">
                                    <div class="reg-participant-name">${p.name || 'Participant ' + (idx + 1)}</div>
                                    <div class="reg-participant-email">${p.email || ''}</div>
                                </div>
                                <div class="reg-participant-right ${pill.label !== 'Attended' ? 'no-survey' : ''}">
                                    <div class="reg-status-wrapper" style="position: relative;">
                                        <button type="button" class="reg-status-trigger ${pill.cls}" data-registration-id="${p.registrationId || ''}" title="${pill.label}">
                                            <i class="fa-solid fa-user-check"></i>
                                            <span class="reg-status-label">${pill.label}</span>
                                        </button>
                                        <div class="reg-status-menu" data-registration-id="${p.registrationId || ''}">
                                            ${statusOptions.map(opt => `
                                                <button type="button" class="reg-status-option" data-registration-id="${p.registrationId || ''}" data-value="${opt.value}">
                                                    <i class="fa-solid ${opt.icon}"></i>
                                                    <span>${opt.label}</span>
                                                </button>
                                            `).join('')}
                                        </div>
                                    </div>
                                    <div class="reg-participant-meta">
                                        ${pill.label === 'Attended' ? `${p.surveyId
                                            ? `<a class="survey-badge" href="/surveys?filterSurveyID=${p.surveyId}">
                                                    <i class="fa-solid fa-check"></i>
                                                    Survey Complete
                                               </a>`
                                            : `<span class="survey-badge missing">
                                                    <i class="fa-solid fa-circle-xmark"></i>
                                                    Survey Missing
                                               </span>`}` : ''}
                                    </div>
                                </div>
                            `;
                            modalParticipants.appendChild(row);
                        });
                    }
                }

                // Populate form fields
                if (inputDate) {
                    const start = occurrence?.start ? new Date(occurrence.start) : null;
                    if (start && !Number.isNaN(start.getTime())) {
                        const year = start.getFullYear();
                        const month = String(start.getMonth() + 1).padStart(2, '0');
                        const day = String(start.getDate()).padStart(2, '0');
                        inputDate.value = `${year}-${month}-${day}`;
                    } else {
                        inputDate.value = '';
                    }
                }
                if (inputStart) {
                    const start = occurrence?.start ? new Date(occurrence.start) : null;
                    if (start && !Number.isNaN(start.getTime())) {
                        const hh = String(start.getHours()).padStart(2, '0');
                        const mm = String(start.getMinutes()).padStart(2, '0');
                        inputStart.value = `${hh}:${mm}`;
                    } else {
                        inputStart.value = '';
                    }
                }
                if (inputEnd) {
                    const end = occurrence?.end ? new Date(occurrence.end) : null;
                    if (end && !Number.isNaN(end.getTime())) {
                        const hh = String(end.getHours()).padStart(2, '0');
                        const mm = String(end.getMinutes()).padStart(2, '0');
                        inputEnd.value = `${hh}:${mm}`;
                    } else {
                        inputEnd.value = '';
                    }
                }
                if (selectLocation) {
                    const loc = occurrence?.location || '';
                    if (loc && !Array.from(selectLocation.options).some(opt => opt.value === loc)) {
                        const opt = document.createElement('option');
                        opt.value = loc;
                        opt.textContent = loc;
                        selectLocation.appendChild(opt);
                    }
                    selectLocation.value = loc;
                }
            };

            if (toggle) {
                toggle.querySelectorAll('.toggle-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        toggle.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        applyFilter(btn.getAttribute('data-filter'));
                    });
                });
                applyFilter('upcoming');
            }

            const openModal = () => {
                if (modalBackdrop) modalBackdrop.classList.add('active');
            };

            const closeModal = () => {
                if (modalBackdrop) modalBackdrop.classList.remove('active');
            };

            document.querySelectorAll('.details-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const occId = btn.getAttribute('data-occurrence-id');
                    renderModal(occId);
                    openModal();
                });
            });

            if (modalBackdrop) {
                modalBackdrop.addEventListener('click', (e) => {
                    if (e.target === modalBackdrop) {
                        closeModal();
                    }
                });
            }

            if (modalClose) {
                modalClose.addEventListener('click', closeModal);
            }

            // Participant search typeahead
            const hideResults = () => {
                if (searchResults) searchResults.style.display = 'none';
            };
            const showResults = () => {
                if (searchResults) searchResults.style.display = 'block';
            };

            const closeStatusMenus = () => {
                if (modalParticipants) {
                    modalParticipants.querySelectorAll('.reg-status-menu').forEach(menu => menu.classList.remove('active'));
                }
                openStatusMenuId = null;
            };

            const toggleStatusMenu = (registrationId) => {
                if (!modalParticipants) return;
                const menu = modalParticipants.querySelector(`.reg-status-menu[data-registration-id="${registrationId}"]`);
                if (!menu) return;
                const isOpen = menu.classList.contains('active');
                closeStatusMenus();
                if (!isOpen) {
                    menu.classList.add('active');
                    openStatusMenuId = registrationId;
                }
            };

            const updateRegistrationStatus = async (registrationId, value) => {
                const [statusKey, attendedVal] = (value || '').split(':');
                const attended = attendedVal === 'true';
                let status = 'Registered';
                if (statusKey === 'cancelled') status = 'Cancelled';
                if (statusKey === 'checkedin') status = 'Registered';
                if (statusKey === 'attended') status = 'Registered';
                if (statusKey === 'registered' && attended) status = 'Registered';

                try {
                    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
                    const res = await fetch(`/admin/registrations/${registrationId}/update-status`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'X-CSRF-Token': csrfToken
                        },
                        body: JSON.stringify({ status, attended })
                    });
                    const data = await res.json();
                    if (!data.success) {
                        throw new Error(data.error || 'Update failed');
                    }
                    // Update local copy so the UI reflects changes immediately
                    const occ = adminOccurrenceData[activeOccurrenceId];
                    if (occ && Array.isArray(occ.participants)) {
                        const participant = occ.participants.find(p => String(p.registrationId) === String(registrationId));
                        if (participant) {
                            participant.status = status;
                            participant.attended = attended;
                            participant.checkInTime = statusKey === 'checkedin' ? new Date().toISOString() : null;
                        }
                    }
                    renderModal(activeOccurrenceId);
                } catch (err) {
                    console.error(err);
                    alert(err.message || 'Error updating status');
                } finally {
                    closeStatusMenus();
                }
            };

            if (searchInput) {
                searchInput.addEventListener('input', async () => {
                    const q = searchInput.value.trim();
                    activeSearchId = null;
                    if (!q || !searchResults) {
                        hideResults();
                        return;
                    }
                    try {
                        const res = await fetch(`/admin/participants/search?q=${encodeURIComponent(q)}`);
                        const data = await res.json();
                        if (!data.success) {
                            hideResults();
                            return;
                        }
                        searchResults.innerHTML = '';
                        data.results.forEach(item => {
                            const div = document.createElement('div');
                            div.className = 'result-item';
                            div.textContent = `${item.name} (#${item.participantId}) - ${item.email}`;
                            div.addEventListener('click', () => {
                                searchInput.value = `${item.name} (#${item.participantId})`;
                                activeSearchId = item.participantId;
                                hideResults();
                            });
                            searchResults.appendChild(div);
                        });
                        showResults();
                    } catch (err) {
                        console.error(err);
                        hideResults();
                    }
                });
            }

            document.addEventListener('click', (e) => {
                if (searchResults && !searchResults.contains(e.target) && e.target !== searchInput) {
                    hideResults();
                }
                const inStatusMenu = e.target.closest('.reg-status-menu');
                const isStatusTrigger = e.target.closest('.reg-status-trigger');
                if (!inStatusMenu && !isStatusTrigger) {
                    closeStatusMenus();
                }
            });

            if (confirmYes) {
                confirmYes.addEventListener('click', () => closeConfirm(true));
            }
            if (confirmNo) {
                confirmNo.addEventListener('click', () => closeConfirm(false));
            }
            if (confirmBackdrop) {
                confirmBackdrop.addEventListener('click', (e) => {
                    if (e.target === confirmBackdrop) {
                        closeConfirm(false);
                    }
                });
            }

            // Add participant
            if (modalAdd) {
                modalAdd.addEventListener('click', async () => {
                    if (!activeOccurrenceId) return;
                    if (!activeSearchId) {
                        alert('Select a participant first.');
                        return;
                    }
                    modalAdd.disabled = true;
                    modalAdd.textContent = 'Registering...';
                    try {
                        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
                        const res = await fetch(`/admin/occurrences/${activeOccurrenceId}/register-user`, {
                            method: 'POST',
                            headers: { 
                                'Content-Type': 'application/json',
                                'X-CSRF-Token': csrfToken
                            },
                            body: JSON.stringify({ participantId: activeSearchId })
                        });
                        const data = await res.json();
                        if (!data.success) {
                            throw new Error(data.error || 'Registration failed');
                        }
                        // push to data
                        const record = data.registration;
                        if (adminOccurrenceData[activeOccurrenceId]) {
                            adminOccurrenceData[activeOccurrenceId].participants.push({
                                participantId: record.participantId,
                                registrationId: record.registrationId,
                                name: record.name,
                                email: record.email,
                                status: record.status,
                                attended: record.attended,
                                checkInTime: record.checkInTime,
                                surveyId: record.surveyId
                            });
                            adminOccurrenceData[activeOccurrenceId].occurrence.registrationCount += 1;
                        }
                        renderModal(activeOccurrenceId);
                        showToast('Participant registered');
                    } catch (err) {
                        console.error(err);
                        alert(err.message || 'Error registering participant');
                    } finally {
                        modalAdd.disabled = false;
                        modalAdd.textContent = 'Register';
                    }
                });
            }

            if (modalEdit) {
                modalEdit.addEventListener('click', () => {
                    setEditing(true);
                });
            }

            if (modalCancel) {
                modalCancel.addEventListener('click', () => {
                    setEditing(false);
                    if (activeOccurrenceId) {
                        renderModal(activeOccurrenceId);
                    }
                });
            }

            // Save changes (update occurrence)
            if (modalSave) {
                modalSave.addEventListener('click', async () => {
                    if (!activeOccurrenceId) return;
                    const date = inputDate?.value || '';
                    const startTime = inputStart?.value || '';
                    const endTime = inputEnd?.value || '';
                    const location = selectLocation?.value || '';

                    if (!date || !startTime) {
                        alert('Date and start time are required.');
                        return;
                    }

                    modalSave.disabled = true;
                    modalSave.textContent = 'Saving...';
                    try {
                        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
                        const res = await fetch(`/occurrences/${activeOccurrenceId}/update`, {
                            method: 'POST',
                            headers: { 
                                'Content-Type': 'application/json',
                                'X-CSRF-Token': csrfToken
                            },
                            body: JSON.stringify({ date, startTime, endTime, location })
                        });
                        const data = await res.json();
                        if (!data.success) {
                            throw new Error(data.error || 'Update failed');
                        }

                        // Update local data
                        const updated = adminOccurrenceData[activeOccurrenceId];
                        if (updated) {
                            updated.occurrence.start = data.occurrence.EventDateTimeStart;
                            updated.occurrence.end = data.occurrence.EventDateTimeEnd;
                            updated.occurrence.location = data.occurrence.EventLocation;
                        }

                        // Update card display
                        const card = document.querySelector(`.occurrence-card[data-occurrence-id="${activeOccurrenceId}"]`);
                        if (card) {
                            const dateEl = card.querySelector('.occurrence-date');
                            const timeEl = card.querySelector('.occurrence-time');
                            const locEl = card.querySelector('.occurrence-detail-item span');
                            const startDate = new Date(data.occurrence.EventDateTimeStart);
                            const endDate = data.occurrence.EventDateTimeEnd ? new Date(data.occurrence.EventDateTimeEnd) : null;
                            const isToday = startDate.toDateString() === new Date().toDateString();
                            const isThisYear = startDate.getFullYear() === new Date().getFullYear();
                            if (dateEl) {
                                dateEl.textContent = isToday
                                    ? 'Today'
                                    : startDate.toLocaleDateString('en-US', isThisYear
                                        ? { weekday: 'short', month: 'short', day: 'numeric' }
                                        : { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
                            }
                            if (timeEl) {
                                const startStr = startDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
                                const endStr = endDate && !Number.isNaN(endDate.getTime())
                                    ? endDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })
                                    : null;
                                timeEl.innerHTML = `<i class="fa-solid fa-clock"></i> ${startStr}${endStr ? ' - ' + endStr : ''}`;
                            }
                        if (locEl) {
                            locEl.textContent = data.occurrence.EventLocation || 'Location TBA';
                        }
                    }

                    renderModal(activeOccurrenceId);
                    setEditing(false);
                    showToast('Changes saved');
                } catch (err) {
                    console.error(err);
                    alert(err.message || 'Error updating occurrence');
                } finally {
                        modalSave.disabled = false;
                        modalSave.textContent = 'Save Changes';
                    }
                });
            }

            // Status change + removal
            if (modalParticipants) {
                modalParticipants.addEventListener('click', async (e) => {
                    const trigger = e.target.closest('.reg-status-trigger');
                    if (trigger) {
                        const registrationId = trigger.getAttribute('data-registration-id');
                        if (registrationId) toggleStatusMenu(registrationId);
                        return;
                    }

                    const option = e.target.closest('.reg-status-option');
                    if (option) {
                        const registrationId = option.getAttribute('data-registration-id');
                        const value = option.getAttribute('data-value') || '';
                        if (registrationId) {
                            await updateRegistrationStatus(registrationId, value);
                        }
                        return;
                    }

                    const btn = e.target.closest('.reg-remove');
                    if (!btn) return;
                    const registrationId = btn.getAttribute('data-registration-id');
                    if (!registrationId) return;
                    const confirmed = await openConfirm('Remove this participant from the occurrence?');
                    if (!confirmed) return;
                    btn.disabled = true;
                    try {
                        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
                        const res = await fetch(`/admin/registrations/${registrationId}/delete`, { 
                            method: 'POST',
                            headers: {
                                'X-CSRF-Token': csrfToken
                            }
                        });
                        const data = await res.json();
                        if (!data.success) {
                            throw new Error(data.error || 'Delete failed');
                        }
                        if (adminOccurrenceData[activeOccurrenceId]) {
                            adminOccurrenceData[activeOccurrenceId].participants = adminOccurrenceData[activeOccurrenceId].participants.filter(p => String(p.registrationId) !== String(registrationId));
                            if (adminOccurrenceData[activeOccurrenceId].occurrence.registrationCount > 0) {
                                adminOccurrenceData[activeOccurrenceId].occurrence.registrationCount -= 1;
                            }
                        }
                        renderModal(activeOccurrenceId);
                    } catch (err) {
                        console.error(err);
                        alert(err.message || 'Error removing participant');
                    } finally {
                        btn.disabled = false;
                    }
                });
            }

            // Delete occurrence
            if (modalDelete) {
                modalDelete.addEventListener('click', async () => {
                    if (!activeOccurrenceId) return;
                    const confirmed = await openConfirm('Are you sure you want to delete this event?');
                    if (!confirmed) return;

                    modalDelete.disabled = true;
                    modalDelete.textContent = 'Deleting...';
                    try {
                        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
                        const res = await fetch(`/occurrences/${activeOccurrenceId}/delete`, { 
                            method: 'POST',
                            headers: {
                                'X-CSRF-Token': csrfToken
                            }
                        });
                        const data = await res.json();
                        if (!data.success) {
                            throw new Error(data.error || 'Delete failed');
                        }

                        // Remove card
                        const card = document.querySelector(`.occurrence-card[data-occurrence-id="${activeOccurrenceId}"]`);
                        if (card && card.parentElement) {
                            card.parentElement.removeChild(card);
                        }
                        delete adminOccurrenceData[activeOccurrenceId];
                        closeModal();
                        setEditing(false);
                    } catch (err) {
                        console.error(err);
                        alert(err.message || 'Error deleting occurrence');
                    } finally {
                        modalDelete.disabled = false;
                        modalDelete.textContent = 'Delete';
                    }
                });
            }
        }

        // Handle register/unregister toggle
        document.querySelectorAll('.register-toggle-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                const occurrenceId = this.getAttribute('data-occurrence-id');
                const isRegistered = this.getAttribute('data-is-registered') === 'true';
                const originalText = this.textContent;
                
                // Disable button during request
                this.disabled = true;
                this.textContent = 'Processing...';

                try {
                    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
                    const endpoint = isRegistered ? '/unregister-occurrence' : '/register-occurrence';
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-Token': csrfToken
                        },
                        body: JSON.stringify({ occurrenceId: parseInt(occurrenceId, 10) })
                    });

                    const data = await response.json();

                    if (data.success) {
                        // Toggle button state
                        const newIsRegistered = !isRegistered;
                        this.setAttribute('data-is-registered', newIsRegistered);
                        this.textContent = newIsRegistered ? 'Unregister' : 'Register';
                        this.className = newIsRegistered ? 'btn btn-secondary register-toggle-btn' : 'btn btn-primary register-toggle-btn';
                        
                        // Show success message (optional - you can add a toast notification here)
                        console.log(data.message);
                    } else {
                        alert(data.error || 'An error occurred');
                        this.textContent = originalText;
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('An error occurred. Please try again.');
                    this.textContent = originalText;
                } finally {
                    this.disabled = false;
                }
            });
        });

        // Create Event Modal (Admin only)
        if (isAdminView) {
            const eventTemplate = <%- JSON.stringify(eventTemplate || {}) %>;
            const createEventBtn = document.getElementById('createEventBtn');
            const createEventBackdrop = document.getElementById('createEventBackdrop');
            const createEventClose = document.getElementById('createEventClose');
            const createEventCancel = document.getElementById('createEventCancelBtn');
            const createEventPublish = document.getElementById('createEventPublishBtn');
            const createEventHeader = document.getElementById('createEventHeader');
            const createEventDate = document.getElementById('createEventDate');
            const createEventStart = document.getElementById('createEventStart');
            const createEventEnd = document.getElementById('createEventEnd');
            const createEventLocation = document.getElementById('createEventLocation');
            const createEventCapacity = document.getElementById('createEventCapacity');

            // Populate location datalist
            const createEventLocationDatalist = document.getElementById('createEventLocationOptions');
            if (createEventLocationDatalist && locationOptions) {
                createEventLocationDatalist.innerHTML = '';
                locationOptions.forEach(loc => {
                    if (loc && loc.trim()) {
                        const opt = document.createElement('option');
                        opt.value = loc;
                        createEventLocationDatalist.appendChild(opt);
                    }
                });
            }

            // Calculate suggested next date based on recurrence
            const calculateNextDate = () => {
                if (!eventTemplate || !eventTemplate.EventRecurrencePattern) return null;
                const recurrence = eventTemplate.EventRecurrencePattern;
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                // Get the most recent occurrence date
                const occurrences = Object.values(adminOccurrenceData || {})
                    .map(d => d.occurrence)
                    .filter(o => o && o.start)
                    .map(o => new Date(o.start))
                    .filter(d => !isNaN(d.getTime()))
                    .sort((a, b) => b - a);

                const lastDate = occurrences.length > 0 ? occurrences[0] : today;

                let nextDate = new Date(lastDate);
                
                if (recurrence === 'Weekly') {
                    nextDate.setDate(nextDate.getDate() + 7);
                } else if (recurrence === 'Monthly') {
                    nextDate.setMonth(nextDate.getMonth() + 1);
                } else if (recurrence === 'Annual') {
                    nextDate.setFullYear(nextDate.getFullYear() + 1);
                } else {
                    // Default: suggest next week
                    nextDate.setDate(nextDate.getDate() + 7);
                }

                // Make sure it's in the future
                if (nextDate <= today) {
                    if (recurrence === 'Weekly') {
                        nextDate.setDate(today.getDate() + 7);
                    } else if (recurrence === 'Monthly') {
                        nextDate.setMonth(today.getMonth() + 1);
                    } else if (recurrence === 'Annual') {
                        nextDate.setFullYear(today.getFullYear() + 1);
                    } else {
                        nextDate = new Date(today);
                        nextDate.setDate(today.getDate() + 7);
                    }
                }

                return nextDate;
            };

            // Populate modal header with event name and labels
            const populateHeader = () => {
                if (!createEventHeader || !eventTemplate) return;
                
                const eventType = eventTemplate.EventType || '';
                const recurrence = eventTemplate.EventRecurrencePattern || '';
                
                let typeIcon = 'fa-tag';
                if (eventType === 'STEM') typeIcon = 'fa-gear';
                else if (eventType === 'Arts') typeIcon = 'fa-paintbrush';
                else if (eventType === 'Leadership') typeIcon = 'fa-users';
                else if (eventType === 'Annual Conference') typeIcon = 'fa-calendar-star';
                
                let recurIcon = 'fa-calendar';
                if (recurrence === 'Monthly') recurIcon = 'fa-calendar-days';
                else if (recurrence === 'Weekly') recurIcon = 'fa-calendar-week';
                else if (recurrence === 'Annual') recurIcon = 'fa-calendar-check';

                let labelsHtml = '';
                if (eventType) {
                    labelsHtml += `<span class="event-label event-label-type-${eventType.toLowerCase().replace(/\s+/g, '-')}">
                        <i class="fa-solid ${typeIcon}"></i>
                        ${eventType}
                    </span>`;
                }
                if (recurrence) {
                    labelsHtml += `<span class="event-label event-label-recurrence-${recurrence.toLowerCase()}">
                        <i class="fa-solid ${recurIcon}"></i>
                        ${recurrence}
                    </span>`;
                }

                createEventHeader.innerHTML = `
                    <h4 style="margin: 0 0 0.75rem 0; font-family: 'DM Serif Display', serif; font-size: 1.5rem; color: #3A3F3B;">${eventTemplate.EventName || 'New Event'}</h4>
                    <div class="event-labels">${labelsHtml}</div>
                `;
            };

            // Open create event modal
            const openCreateModal = () => {
                if (!createEventBackdrop) return;
                
                populateHeader();
                
                // Pre-fill form
                const nextDate = calculateNextDate();
                if (nextDate && createEventDate) {
                    const year = nextDate.getFullYear();
                    const month = String(nextDate.getMonth() + 1).padStart(2, '0');
                    const day = String(nextDate.getDate()).padStart(2, '0');
                    createEventDate.value = `${year}-${month}-${day}`;
                }
                
                if (createEventCapacity && eventTemplate.EventDefaultCapacity) {
                    createEventCapacity.value = eventTemplate.EventDefaultCapacity;
                }
                
                createEventBackdrop.classList.add('active');
            };

            // Close create event modal
            const closeCreateModal = () => {
                if (createEventBackdrop) createEventBackdrop.classList.remove('active');
                // Reset form
                if (createEventDate) createEventDate.value = '';
                if (createEventStart) createEventStart.value = '';
                if (createEventEnd) createEventEnd.value = '';
                if (createEventLocation) createEventLocation.value = '';
                if (createEventCapacity) createEventCapacity.value = '';
            };

            // Event listeners
            if (createEventBtn) {
                createEventBtn.addEventListener('click', openCreateModal);
            }

            if (createEventClose) {
                createEventClose.addEventListener('click', closeCreateModal);
            }

            if (createEventCancel) {
                createEventCancel.addEventListener('click', closeCreateModal);
            }

            if (createEventBackdrop) {
                createEventBackdrop.addEventListener('click', (e) => {
                    if (e.target === createEventBackdrop) {
                        closeCreateModal();
                    }
                });
            }

            // Publish event
            if (createEventPublish) {
                createEventPublish.addEventListener('click', async () => {
                    const date = createEventDate?.value || '';
                    const startTime = createEventStart?.value || '';
                    const endTime = createEventEnd?.value || '';
                    const location = createEventLocation?.value || '';
                    const capacity = parseInt(createEventCapacity?.value || '0', 10);

                    if (!date || !startTime || !capacity || capacity < 1) {
                        alert('Please fill in all required fields (Date, Start Time, and Capacity).');
                        return;
                    }

                    createEventPublish.disabled = true;
                    createEventPublish.textContent = 'Publishing...';

                    try {
                        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
                        const res = await fetch(`/admin/occurrences/create`, {
                            method: 'POST',
                            headers: { 
                                'Content-Type': 'application/json',
                                'X-CSRF-Token': csrfToken
                            },
                            body: JSON.stringify({
                                eventId: eventTemplate.EventID,
                                date,
                                startTime,
                                endTime: endTime || null,
                                location: location || null,
                                capacity
                            })
                        });

                        const data = await res.json();
                        if (!data.success) {
                            throw new Error(data.error || 'Failed to create event');
                        }

                        // Reload page to show new occurrence
                        window.location.reload();
                    } catch (err) {
                        console.error('Error creating event:', err);
                        alert(err.message || 'Error creating event. Please try again.');
                        createEventPublish.disabled = false;
                        createEventPublish.textContent = 'Publish Event';
                    }
                });
            }
        }
    });
</script>

<div class="reg-modal-backdrop">
    <div class="reg-modal">
        <div class="reg-modal-header">
            <h3 id="regModalTitle">Occurrence Details</h3>
            <button type="button" class="reg-modal-close" aria-label="Close">&times;</button>
        </div>
            <div class="reg-modal-body">
            <div class="reg-modal-meta" id="regModalMeta"></div>
            <div class="reg-participants-card">
                <div class="reg-participant-head">
                    <h4 style="margin: 0;">Participants</h4>
                    <div class="reg-toast" id="regModalToast" role="status" aria-live="polite"></div>
                </div>
                <div class="reg-participant-actions">
                    <input type="text" id="regParticipantSearch" class="form-control reg-participant-search" placeholder="Search participants..." autocomplete="off">
                    <div class="reg-search-results" id="regParticipantResults"></div>
                    <button type="button" class="btn btn-secondary" id="regModalAddBtn">Register</button>
                </div>
                <div class="reg-participants-list" id="regModalParticipants"></div>
                <p class="reg-empty" id="regModalEmpty" style="display: none;">No participants registered yet.</p>
            </div>
            <div class="reg-edit-region" id="regEditRegion">
                <div class="reg-form reg-editable">
                    <div class="reg-form-row">
                        <div class="reg-form-group">
                            <label for="regEditDate">Date</label>
                            <input type="date" id="regEditDate" class="form-control">
                        </div>
                        <div class="reg-form-group">
                            <label for="regEditStart">Start Time</label>
                            <input type="time" id="regEditStart" class="form-control">
                        </div>
                        <div class="reg-form-group">
                            <label for="regEditEnd">End Time</label>
                            <input type="time" id="regEditEnd" class="form-control">
                        </div>
                    </div>
                    <div class="reg-form-group">
                        <label for="regEditLocation">Location</label>
                        <select id="regEditLocation" class="form-control"></select>
                    </div>
                </div>
                <div class="reg-modal-footer">
                    <div class="reg-edit-actions reg-editable">
                        <button type="button" class="btn btn-secondary" id="regModalSaveBtn">Save Changes</button>
                        <button type="button" class="btn btn-outline-secondary" id="regModalCancelBtn">Cancel</button>
                    </div>
                    <div class="reg-edit-buttons">
                        <button type="button" class="btn btn-lavender" id="regModalEditBtn">Edit</button>
                        <button type="button" class="btn btn-danger" id="regModalDeleteBtn">Delete</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Event Modal -->
<div class="reg-modal-backdrop" id="createEventBackdrop" aria-modal="true" role="dialog">
    <div class="reg-modal">
        <div class="reg-modal-header">
            <h3 id="createEventTitle">Create Event</h3>
            <button type="button" class="reg-modal-close" id="createEventClose" aria-label="Close">&times;</button>
        </div>
        <div class="reg-modal-body">
            <div class="create-event-header" id="createEventHeader">
                <!-- Will be populated with event name and labels -->
            </div>
            <div class="reg-form">
                <div class="reg-form-row">
                    <div class="reg-form-group">
                        <label for="createEventDate">Date *</label>
                        <input type="date" id="createEventDate" class="form-control" required>
                    </div>
                    <div class="reg-form-group">
                        <label for="createEventStart">Start Time *</label>
                        <input type="time" id="createEventStart" class="form-control" required>
                    </div>
                    <div class="reg-form-group">
                        <label for="createEventEnd">End Time</label>
                        <input type="time" id="createEventEnd" class="form-control">
                    </div>
                </div>
                <div class="reg-form-row">
                    <div class="reg-form-group">
                        <label for="createEventLocation">Location</label>
                        <input type="text" id="createEventLocation" class="form-control" list="createEventLocationOptions" placeholder="Type or select a location">
                        <datalist id="createEventLocationOptions"></datalist>
                    </div>
                    <div class="reg-form-group">
                        <label for="createEventCapacity">Capacity *</label>
                        <input type="number" id="createEventCapacity" class="form-control" min="1" required>
                    </div>
                </div>
            </div>
            <div class="reg-modal-footer">
                <div style="display: flex; justify-content: flex-end; gap: 0.75rem; width: 100%;">
                    <button type="button" class="btn btn-outline-secondary" id="createEventCancelBtn">Cancel</button>
                    <button type="button" class="btn btn-primary" id="createEventPublishBtn">Publish Event</button>
                </div>
            </div>
        </div>
    </div>
</div>
